import { Duration } from 'aws-cdk-lib';
const DEFAULT_API_KEY_EXPIRATION_DAYS = 7;
const DEFAULT_LAMBDA_AUTH_TIME_TO_LIVE_SECONDS = 60;
/**
 * Function instance provider which uses the
 */
export const buildConstructFactoryProvidedAuthConfig = (authResourceProvider) => {
    if (!authResourceProvider)
        return;
    return {
        userPool: authResourceProvider.resources.userPool,
        identityPoolId: authResourceProvider.resources.cfnResources.cfnIdentityPool.ref,
        authenticatedUserRole: authResourceProvider.resources.authenticatedUserIamRole,
        unauthenticatedUserRole: authResourceProvider.resources.unauthenticatedUserIamRole,
    };
};
/**
 * Convert to CDK ApiKeyAuthorizationConfig.
 */
const convertApiKeyAuthConfigToCDK = ({ description, expiresInDays = DEFAULT_API_KEY_EXPIRATION_DAYS, }) => ({
    description,
    expires: Duration.days(expiresInDays),
});
/**
 * Convert to CDK LambdaAuthorizationConfig.
 */
const convertLambdaAuthorizationConfigToCDK = (functionInstanceProvider, { function: authFn, timeToLiveInSeconds = DEFAULT_LAMBDA_AUTH_TIME_TO_LIVE_SECONDS, }) => ({
    function: functionInstanceProvider.provide(authFn),
    ttl: Duration.seconds(timeToLiveInSeconds),
});
/**
 * Convert to CDK OIDCAuthorizationConfig.
 */
const convertOIDCAuthConfigToCDK = ({ oidcProviderName, oidcIssuerUrl, clientId, tokenExpiryFromAuthInSeconds, tokenExpireFromIssueInSeconds, }) => ({
    oidcProviderName,
    oidcIssuerUrl,
    clientId,
    tokenExpiryFromAuth: Duration.seconds(tokenExpiryFromAuthInSeconds),
    tokenExpiryFromIssue: Duration.seconds(tokenExpireFromIssueInSeconds),
});
/**
 * Compute default auth mode based on availability of auth resources.
 * Will specify userPool if both user pool is specified, and no auth resources are specified, else rely on override value if needed.
 */
const computeDefaultAuthorizationMode = (providedAuthConfig, authModes) => {
    if (providedAuthConfig && !authModes)
        return 'userPool';
    return;
};
/**
 * Compute user pool auth config from auth resource provider.
 * @returns a user pool auth config, if relevant
 */
const computeUserPoolAuthFromResource = (providedAuthConfig) => {
    if (providedAuthConfig) {
        return { userPool: providedAuthConfig.userPool };
    }
    return;
};
/**
 * Compute iam auth config from auth resource provider.
 * @returns an iam auth config, if relevant
 */
const computeIAMAuthFromResource = (providedAuthConfig, authModes) => {
    if (providedAuthConfig) {
        return {
            authenticatedUserRole: providedAuthConfig.authenticatedUserRole,
            unauthenticatedUserRole: providedAuthConfig.unauthenticatedUserRole,
            identityPoolId: providedAuthConfig.identityPoolId,
            allowListedRoles: authModes?.allowListedRoleNames ?? [],
        };
    }
    return;
};
/**
 * Compute api key auth config from auth resource provider.
 * @returns an api key auth config, if relevant
 */
const computeApiKeyAuthFromResource = (providedAuthConfig, authModes) => {
    if (providedAuthConfig || authModes) {
        return;
    }
    return {
        expires: Duration.days(DEFAULT_API_KEY_EXPIRATION_DAYS),
    };
};
const authorizationModeMapping = {
    iam: 'AWS_IAM',
    userPool: 'AMAZON_COGNITO_USER_POOLS',
    oidc: 'OPENID_CONNECT',
    apiKey: 'API_KEY',
    lambda: 'AWS_LAMBDA',
};
const convertAuthorizationModeToCDK = (mode) => {
    if (!mode)
        return;
    return authorizationModeMapping[mode];
};
/**
 * Convert to CDK AuthorizationModes.
 */
export const convertAuthorizationModesToCDK = (functionInstanceProvider, authResources, authModes) => {
    const defaultAuthorizationMode = authModes?.defaultAuthorizationMode ??
        computeDefaultAuthorizationMode(authResources, authModes);
    const cdkAuthorizationMode = convertAuthorizationModeToCDK(defaultAuthorizationMode);
    const apiKeyConfig = authModes?.apiKeyAuthorizationMode
        ? convertApiKeyAuthConfigToCDK(authModes.apiKeyAuthorizationMode)
        : computeApiKeyAuthFromResource(authResources, authModes);
    const userPoolConfig = computeUserPoolAuthFromResource(authResources);
    const iamConfig = computeIAMAuthFromResource(authResources, authModes);
    const lambdaConfig = authModes?.lambdaAuthorizationMode
        ? convertLambdaAuthorizationConfigToCDK(functionInstanceProvider, authModes.lambdaAuthorizationMode)
        : undefined;
    const oidcConfig = authModes?.oidcAuthorizationMode
        ? convertOIDCAuthConfigToCDK(authModes.oidcAuthorizationMode)
        : undefined;
    return {
        ...(cdkAuthorizationMode
            ? { defaultAuthorizationMode: cdkAuthorizationMode }
            : undefined),
        ...(apiKeyConfig ? { apiKeyConfig } : undefined),
        ...(userPoolConfig ? { userPoolConfig } : undefined),
        ...(iamConfig ? { iamConfig } : undefined),
        ...(lambdaConfig ? { lambdaConfig } : undefined),
        ...(oidcConfig ? { oidcConfig } : undefined),
    };
};
/**
 * Return whether or not the api will use default API_KEY auth due to absence of auth resources and input auth-modes.
 * @param authResources the generated auth resources in the system
 * @param authModes the provided auth modes
 * @returns a boolean indicating whether or not default api key auth will be used.
 */
export const isUsingDefaultApiKeyAuth = (authResources, authModes) => {
    return (authModes === undefined &&
        computeApiKeyAuthFromResource(authResources, authModes) !== undefined);
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29udmVydF9hdXRob3JpemF0aW9uX21vZGVzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL2NvbnZlcnRfYXV0aG9yaXphdGlvbl9tb2Rlcy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0sYUFBYSxDQUFDO0FBcUJ2QyxNQUFNLCtCQUErQixHQUFHLENBQUMsQ0FBQztBQUMxQyxNQUFNLHdDQUF3QyxHQUFHLEVBQUUsQ0FBQztBQVNwRDs7R0FFRztBQUNILE1BQU0sQ0FBQyxNQUFNLHVDQUF1QyxHQUFHLENBQ3JELG9CQUFpRSxFQUNqQyxFQUFFO0lBQ2xDLElBQUksQ0FBQyxvQkFBb0I7UUFBRSxPQUFPO0lBRWxDLE9BQU87UUFDTCxRQUFRLEVBQUUsb0JBQW9CLENBQUMsU0FBUyxDQUFDLFFBQVE7UUFDakQsY0FBYyxFQUNaLG9CQUFvQixDQUFDLFNBQVMsQ0FBQyxZQUFZLENBQUMsZUFBZSxDQUFDLEdBQUc7UUFDakUscUJBQXFCLEVBQ25CLG9CQUFvQixDQUFDLFNBQVMsQ0FBQyx3QkFBd0I7UUFDekQsdUJBQXVCLEVBQ3JCLG9CQUFvQixDQUFDLFNBQVMsQ0FBQywwQkFBMEI7S0FDNUQsQ0FBQztBQUNKLENBQUMsQ0FBQztBQUVGOztHQUVHO0FBQ0gsTUFBTSw0QkFBNEIsR0FBRyxDQUFDLEVBQ3BDLFdBQVcsRUFDWCxhQUFhLEdBQUcsK0JBQStCLEdBQ2xCLEVBQWdDLEVBQUUsQ0FBQyxDQUFDO0lBQ2pFLFdBQVc7SUFDWCxPQUFPLEVBQUUsUUFBUSxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUM7Q0FDdEMsQ0FBQyxDQUFDO0FBRUg7O0dBRUc7QUFDSCxNQUFNLHFDQUFxQyxHQUFHLENBQzVDLHdCQUFrRCxFQUNsRCxFQUNFLFFBQVEsRUFBRSxNQUFNLEVBQ2hCLG1CQUFtQixHQUFHLHdDQUF3QyxHQUNqQyxFQUNELEVBQUUsQ0FBQyxDQUFDO0lBQ2xDLFFBQVEsRUFBRSx3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LHdCQUF3QixHQUFHLENBQ3RDLGFBQTZDLEVBQzdDLFNBQXlDLEVBQ2hDLEVBQUU7SUFDWCxPQUFPLENBQ0wsU0FBUyxLQUFLLFNBQVM7UUFDdkIsNkJBQTZCLENBQUMsYUFBYSxFQUFFLFNBQVMsQ0FBQyxLQUFLLFNBQVMsQ0FDdEUsQ0FBQztBQUNKLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IER1cmF0aW9uIH0gZnJvbSAnYXdzLWNkay1saWInO1xuaW1wb3J0IHsgSVVzZXJQb29sIH0gZnJvbSAnYXdzLWNkay1saWIvYXdzLWNvZ25pdG8nO1xuaW1wb3J0IHsgSVJvbGUgfSBmcm9tICdhd3MtY2RrLWxpYi9hd3MtaWFtJztcbmltcG9ydCB7XG4gIEFwaUtleUF1dGhvcml6YXRpb25Db25maWcgYXMgQ0RLQXBpS2V5QXV0aG9yaXphdGlvbkNvbmZpZyxcbiAgQXV0aG9yaXphdGlvbk1vZGVzIGFzIENES0F1dGhvcml6YXRpb25Nb2RlcyxcbiAgSUFNQXV0aG9yaXphdGlvbkNvbmZpZyBhcyBDREtJQU1BdXRob3JpemF0aW9uQ29uZmlnLFxuICBMYW1iZGFBdXRob3JpemF0aW9uQ29uZmlnIGFzIENES0xhbWJkYUF1dGhvcml6YXRpb25Db25maWcsXG4gIE9JRENBdXRob3JpemF0aW9uQ29uZmlnIGFzIENES09JRENBdXRob3JpemF0aW9uQ29uZmlnLFxuICBVc2VyUG9vbEF1dGhvcml6YXRpb25Db25maWcgYXMgQ0RLVXNlclBvb2xBdXRob3JpemF0aW9uQ29uZmlnLFxufSBmcm9tICdAYXdzLWFtcGxpZnkvZGF0YS1jb25zdHJ1Y3QnO1xuaW1wb3J0IHtcbiAgQXBpS2V5QXV0aG9yaXphdGlvbk1vZGVQcm9wcyxcbiAgQXV0aG9yaXphdGlvbk1vZGVzLFxuICBEZWZhdWx0QXV0aG9yaXphdGlvbk1vZGUsXG4gIExhbWJkYUF1dGhvcml6YXRpb25Nb2RlUHJvcHMsXG4gIE9JRENBdXRob3JpemF0aW9uTW9kZVByb3BzLFxufSBmcm9tICcuL3R5cGVzLmpzJztcbmltcG9ydCB7IEZ1bmN0aW9uSW5zdGFuY2VQcm92aWRlciB9IGZyb20gJy4vY29udmVydF9mdW5jdGlvbnMuanMnO1xuaW1wb3J0IHsgQXV0aFJlc291cmNlcywgUmVzb3VyY2VQcm92aWRlciB9IGZyb20gJ0Bhd3MtYW1wbGlmeS9wbHVnaW4tdHlwZXMnO1xuXG5jb25zdCBERUZBVUxUX0FQSV9LRVlfRVhQSVJBVElPTl9EQVlTID0gNztcbmNvbnN0IERFRkFVTFRfTEFNQkRBX0FVVEhfVElNRV9UT19MSVZFX1NFQ09ORFMgPSA2MDtcblxuZXhwb3J0IHR5cGUgUHJvdmlkZWRBdXRoQ29uZmlnID0ge1xuICB1c2VyUG9vbDogSVVzZXJQb29sO1xuICBhdXRoZW50aWNhdGVkVXNlclJvbGU6IElSb2xlO1xuICB1bmF1dGhlbnRpY2F0ZWRVc2VyUm9sZTogSVJvbGU7XG4gIGlkZW50aXR5UG9vbElkOiBzdHJpbmc7XG59O1xuXG4vKipcbiAqIEZ1bmN0aW9uIGluc3RhbmNlIHByb3ZpZGVyIHdoaWNoIHVzZXMgdGhlXG4gKi9cbmV4cG9ydCBjb25zdCBidWlsZENvbnN0cnVjdEZhY3RvcnlQcm92aWRlZEF1dGhDb25maWcgPSAoXG4gIGF1dGhSZXNvdXJjZVByb3ZpZGVyOiBSZXNvdXJjZVByb3ZpZGVyPEF1dGhSZXNvdXJjZXM+IHwgdW5kZWZpbmVkXG4pOiBQcm92aWRlZEF1dGhDb25maWcgfCB1bmRlZmluZWQgPT4ge1xuICBpZiAoIWF1dGhSZXNvdXJjZVByb3ZpZGVyKSByZXR1cm47XG5cbiAgcmV0dXJuIHtcbiAgICB1c2VyUG9vbDogYXV0aFJlc291cmNlUHJvdmlkZXIucmVzb3VyY2VzLnVzZXJQb29sLFxuICAgIGlkZW50aXR5UG9vbElkOlxuICAgICAgYXV0aFJlc291cmNlUHJvdmlkZXIucmVzb3VyY2VzLmNmblJlc291cmNlcy5jZm5JZGVudGl0eVBvb2wucmVmLFxuICAgIGF1dGhlbnRpY2F0ZWRVc2VyUm9sZTpcbiAgICAgIGF1dGhSZXNvdXJjZVByb3ZpZGVyLnJlc291cmNlcy5hdXRoZW50aWNhdGVkVXNlcklhbVJvbGUsXG4gICAgdW5hdXRoZW50aWNhdGVkVXNlclJvbGU6XG4gICAgICBhdXRoUmVzb3VyY2VQcm92aWRlci5yZXNvdXJjZXMudW5hdXRoZW50aWNhdGVkVXNlcklhbVJvbGUsXG4gIH07XG59O1xuXG4vKipcbiAqIENvbnZlcnQgdG8gQ0RLIEFwaUtleUF1dGhvcml6YXRpb25Db25maWcuXG4gKi9cbmNvbnN0IGNvbnZlcnRBcGlLZXlBdXRoQ29uZmlnVG9DREsgPSAoe1xuICBkZXNjcmlwdGlvbixcbiAgZXhwaXJlc0luRGF5cyA9IERFRkFVTFRfQVBJX0tFWV9FWFBJUkFUSU9OX0RBWVMsXG59OiBBcGlLZXlBdXRob3JpemF0aW9uTW9kZVByb3BzKTogQ0RLQXBpS2V5QXV0aG9yaXphdGlvbkNvbmZpZyA9PiAoe1xuICBkZXNjcmlwdGlvbixcbiAgZXhwaXJlczogRHVyYXRpb24uZGF5cyhleHBpcmVzSW5EYXlzKSxcbn0pO1xuXG4vKipcbiAqIENvbnZlcnQgdG8gQ0RLIExhbWJkYUF1dGhvcml6YXRpb25Db25maWcuXG4gKi9cbmNvbnN0IGNvbnZlcnRMYW1iZGFBdXRob3JpemF0aW9uQ29uZmlnVG9DREsgPSAoXG4gIGZ1bmN0aW9uSW5zdGFuY2VQcm92aWRlcjogRnVuY3Rpb25JbnN0YW5jZVByb3ZpZGVyLFxuICB7XG4gICAgZnVuY3Rpb246IGF1dGhGbixcbiAgICB0aW1lVG9MaXZlSW5TZWNvbmRzID0gREVGQVVMVF9MQU1CREFfQVVUSF9USU1FX1RPX0xJVkVfU0VDT05EUyxcbiAgfTogTGFtYmRhQXV0aG9yaXphdGlvbk1vZGVQcm9wc1xuKTogQ0RLTGFtYmRhQXV0aG9yaXphdGlvbkNvbmZpZyA9PiAoe1xuICBmdW5jdGlvbjogZnVuY3Rpb25JbnN0YW5jZVByb3ZpZGVyLnByb3ZpZGUoYXV0aEZuKSxcbiAgdHRsOiBEdXJhdGlvbi5zZWNvbmRzKHRpbWVUb0xpdmVJblNlY29uZHMpLFxufSk7XG5cbi8qKlxuICogQ29udmVydCB0byBDREsgT0lEQ0F1dGhvcml6YXRpb25Db25maWcuXG4gKi9cbmNvbnN0IGNvbnZlcnRPSURDQXV0aENvbmZpZ1RvQ0RLID0gKHtcbiAgb2lkY1Byb3ZpZGVyTmFtZSxcbiAgb2lkY0lzc3VlclVybCxcbiAgY2xpZW50SWQsXG4gIHRva2VuRXhwaXJ5RnJvbUF1dGhJblNlY29uZHMsXG4gIHRva2VuRXhwaXJlRnJvbUlzc3VlSW5TZWNvbmRzLFxufTogT0lEQ0F1dGhvcml6YXRpb25Nb2RlUHJvcHMpOiBDREtPSURDQXV0aG9yaXphdGlvbkNvbmZpZyA9PiAoe1xuICBvaWRjUHJvdmlkZXJOYW1lLFxuICBvaWRjSXNzdWVyVXJsLFxuICBjbGllbnRJZCxcbiAgdG9rZW5FeHBpcnlGcm9tQXV0aDogRHVyYXRpb24uc2Vjb25kcyh0b2tlbkV4cGlyeUZyb21BdXRoSW5TZWNvbmRzKSxcbiAgdG9rZW5FeHBpcnlGcm9tSXNzdWU6IER1cmF0aW9uLnNlY29uZHModG9rZW5FeHBpcmVGcm9tSXNzdWVJblNlY29uZHMpLFxufSk7XG5cbi8qKlxuICogQ29tcHV0ZSBkZWZhdWx0IGF1dGggbW9kZSBiYXNlZCBvbiBhdmFpbGFiaWxpdHkgb2YgYXV0aCByZXNvdXJjZXMuXG4gKiBXaWxsIHNwZWNpZnkgdXNlclBvb2wgaWYgYm90aCB1c2VyIHBvb2wgaXMgc3BlY2lmaWVkLCBhbmQgbm8gYXV0aCByZXNvdXJjZXMgYXJlIHNwZWNpZmllZCwgZWxzZSByZWx5IG9uIG92ZXJyaWRlIHZhbHVlIGlmIG5lZWRlZC5cbiAqL1xuY29uc3QgY29tcHV0ZURlZmF1bHRBdXRob3JpemF0aW9uTW9kZSA9IChcbiAgcHJvdmlkZWRBdXRoQ29uZmlnOiBQcm92aWRlZEF1dGhDb25maWcgfCB1bmRlZmluZWQsXG4gIGF1dGhNb2RlczogQXV0aG9yaXphdGlvbk1vZGVzIHwgdW5kZWZpbmVkXG4pOiBEZWZhdWx0QXV0aG9yaXphdGlvbk1vZGUgfCB1bmRlZmluZWQgPT4ge1xuICBpZiAocHJvdmlkZWRBdXRoQ29uZmlnICYmICFhdXRoTW9kZXMpIHJldHVybiAndXNlclBvb2wnO1xuICByZXR1cm47XG59O1xuXG4vKipcbiAqIENvbXB1dGUgdXNlciBwb29sIGF1dGggY29uZmlnIGZyb20gYXV0aCByZXNvdXJjZSBwcm92aWRlci5cbiAqIEByZXR1cm5zIGEgdXNlciBwb29sIGF1dGggY29uZmlnLCBpZiByZWxldmFudFxuICovXG5jb25zdCBjb21wdXRlVXNlclBvb2xBdXRoRnJvbVJlc291cmNlID0gKFxuICBwcm92aWRlZEF1dGhDb25maWc6IFByb3ZpZGVkQXV0aENvbmZpZyB8IHVuZGVmaW5lZFxuKTogQ0RLVXNlclBvb2xBdXRob3JpemF0aW9uQ29uZmlnIHwgdW5kZWZpbmVkID0+IHtcbiAgaWYgKHByb3ZpZGVkQXV0aENvbmZpZykge1xuICAgIHJldHVybiB7IHVzZXJQb29sOiBwcm92aWRlZEF1dGhDb25maWcudXNlclBvb2wgfTtcbiAgfVxuICByZXR1cm47XG59O1xuXG4vKipcbiAqIENvbXB1dGUgaWFtIGF1dGggY29uZmlnIGZyb20gYXV0aCByZXNvdXJjZSBwcm92aWRlci5cbiAqIEByZXR1cm5zIGFuIGlhbSBhdXRoIGNvbmZpZywgaWYgcmVsZXZhbnRcbiAqL1xuY29uc3QgY29tcHV0ZUlBTUF1dGhGcm9tUmVzb3VyY2UgPSAoXG4gIHByb3ZpZGVkQXV0aENvbmZpZzogUHJvdmlkZWRBdXRoQ29uZmlnIHwgdW5kZWZpbmVkLFxuICBhdXRoTW9kZXM6IEF1dGhvcml6YXRpb25Nb2RlcyB8IHVuZGVmaW5lZFxuKTogQ0RLSUFNQXV0aG9yaXphdGlvbkNvbmZpZyB8IHVuZGVmaW5lZCA9PiB7XG4gIGlmIChwcm92aWRlZEF1dGhDb25maWcpIHtcbiAgICByZXR1cm4ge1xuICAgICAgYXV0aGVudGljYXRlZFVzZXJSb2xlOiBwcm92aWRlZEF1dGhDb25maWcuYXV0aGVudGljYXRlZFVzZXJSb2xlLFxuICAgICAgdW5hdXRoZW50aWNhdGVkVXNlclJvbGU6IHByb3ZpZGVkQXV0aENvbmZpZy51bmF1dGhlbnRpY2F0ZWRVc2VyUm9sZSxcbiAgICAgIGlkZW50aXR5UG9vbElkOiBwcm92aWRlZEF1dGhDb25maWcuaWRlbnRpdHlQb29sSWQsXG4gICAgICBhbGxvd0xpc3RlZFJvbGVzOiBhdXRoTW9kZXM/LmFsbG93TGlzdGVkUm9sZU5hbWVzID8/IFtdLFxuICAgIH07XG4gIH1cbiAgcmV0dXJuO1xufTtcblxuLyoqXG4gKiBDb21wdXRlIGFwaSBrZXkgYXV0aCBjb25maWcgZnJvbSBhdXRoIHJlc291cmNlIHByb3ZpZGVyLlxuICogQHJldHVybnMgYW4gYXBpIGtleSBhdXRoIGNvbmZpZywgaWYgcmVsZXZhbnRcbiAqL1xuY29uc3QgY29tcHV0ZUFwaUtleUF1dGhGcm9tUmVzb3VyY2UgPSAoXG4gIHByb3ZpZGVkQXV0aENvbmZpZzogUHJvdmlkZWRBdXRoQ29uZmlnIHwgdW5kZWZpbmVkLFxuICBhdXRoTW9kZXM6IEF1dGhvcml6YXRpb25Nb2RlcyB8IHVuZGVmaW5lZFxuKTogQ0RLQXBpS2V5QXV0aG9yaXphdGlvbkNvbmZpZyB8IHVuZGVmaW5lZCA9PiB7XG4gIGlmIChwcm92aWRlZEF1dGhDb25maWcgfHwgYXV0aE1vZGVzKSB7XG4gICAgcmV0dXJuO1xuICB9XG4gIHJldHVybiB7XG4gICAgZXhwaXJlczogRHVyYXRpb24uZGF5cyhERUZBVUxUX0FQSV9LRVlfRVhQSVJBVElPTl9EQVlTKSxcbiAgfTtcbn07XG5cbmNvbnN0IGF1dGhvcml6YXRpb25Nb2RlTWFwcGluZyA9IHtcbiAgaWFtOiAnQVdTX0lBTScsXG4gIHVzZXJQb29sOiAnQU1BWk9OX0NPR05JVE9fVVNFUl9QT09MUycsXG4gIG9pZGM6ICdPUEVOSURfQ09OTkVDVCcsXG4gIGFwaUtleTogJ0FQSV9LRVknLFxuICBsYW1iZGE6ICdBV1NfTEFNQkRBJyxcbn0gYXMgY29uc3Q7XG5cbmNvbnN0IGNvbnZlcnRBdXRob3JpemF0aW9uTW9kZVRvQ0RLID0gKG1vZGU/OiBEZWZhdWx0QXV0aG9yaXphdGlvbk1vZGUpID0+IHtcbiAgaWYgKCFtb2RlKSByZXR1cm47XG5cbiAgcmV0dXJuIGF1dGhvcml6YXRpb25Nb2RlTWFwcGluZ1ttb2RlXTtcbn07XG5cbi8qKlxuICogQ29udmVydCB0byBDREsgQXV0aG9yaXphdGlvbk1vZGVzLlxuICovXG5leHBvcnQgY29uc3QgY29udmVydEF1dGhvcml6YXRpb25Nb2Rlc1RvQ0RLID0gKFxuICBmdW5jdGlvbkluc3RhbmNlUHJvdmlkZXI6IEZ1bmN0aW9uSW5zdGFuY2VQcm92aWRlcixcbiAgYXV0aFJlc291cmNlczogUHJvdmlkZWRBdXRoQ29uZmlnIHwgdW5kZWZpbmVkLFxuICBhdXRoTW9kZXM6IEF1dGhvcml6YXRpb25Nb2RlcyB8IHVuZGVmaW5lZFxuKTogQ0RLQXV0aG9yaXphdGlvbk1vZGVzID0+IHtcbiAgY29uc3QgZGVmYXVsdEF1dGhvcml6YXRpb25Nb2RlID1cbiAgICBhdXRoTW9kZXM/LmRlZmF1bHRBdXRob3JpemF0aW9uTW9kZSA/P1xuICAgIGNvbXB1dGVEZWZhdWx0QXV0aG9yaXphdGlvbk1vZGUoYXV0aFJlc291cmNlcywgYXV0aE1vZGVzKTtcbiAgY29uc3QgY2RrQXV0aG9yaXphdGlvbk1vZGUgPSBjb252ZXJ0QXV0aG9yaXphdGlvbk1vZGVUb0NESyhcbiAgICBkZWZhdWx0QXV0aG9yaXphdGlvbk1vZGVcbiAgKTtcbiAgY29uc3QgYXBpS2V5Q29uZmlnID0gYXV0aE1vZGVzPy5hcGlLZXlBdXRob3JpemF0aW9uTW9kZVxuICAgID8gY29udmVydEFwaUtleUF1dGhDb25maWdUb0NESyhhdXRoTW9kZXMuYXBpS2V5QXV0aG9yaXphdGlvbk1vZGUpXG4gICAgOiBjb21wdXRlQXBpS2V5QXV0aEZyb21SZXNvdXJjZShhdXRoUmVzb3VyY2VzLCBhdXRoTW9kZXMpO1xuICBjb25zdCB1c2VyUG9vbENvbmZpZyA9IGNvbXB1dGVVc2VyUG9vbEF1dGhGcm9tUmVzb3VyY2UoYXV0aFJlc291cmNlcyk7XG4gIGNvbnN0IGlhbUNvbmZpZyA9IGNvbXB1dGVJQU1BdXRoRnJvbVJlc291cmNlKGF1dGhSZXNvdXJjZXMsIGF1dGhNb2Rlcyk7XG4gIGNvbnN0IGxhbWJkYUNvbmZpZyA9IGF1dGhNb2Rlcz8ubGFtYmRhQXV0aG9yaXphdGlvbk1vZGVcbiAgICA/IGNvbnZlcnRMYW1iZGFBdXRob3JpemF0aW9uQ29uZmlnVG9DREsoXG4gICAgICAgIGZ1bmN0aW9uSW5zdGFuY2VQcm92aWRlcixcbiAgICAgICAgYXV0aE1vZGVzLmxhbWJkYUF1dGhvcml6YXRpb25Nb2RlXG4gICAgICApXG4gICAgOiB1bmRlZmluZWQ7XG4gIGNvbnN0IG9pZGNDb25maWcgPSBhdXRoTW9kZXM/Lm9pZGNBdXRob3JpemF0aW9uTW9kZVxuICAgID8gY29udmVydE9JRENBdXRoQ29uZmlnVG9DREsoYXV0aE1vZGVzLm9pZGNBdXRob3JpemF0aW9uTW9kZSlcbiAgICA6IHVuZGVmaW5lZDtcblxuICByZXR1cm4ge1xuICAgIC4uLihjZGtBdXRob3JpemF0aW9uTW9kZVxuICAgICAgPyB7IGRlZmF1bHRBdXRob3JpemF0aW9uTW9kZTogY2RrQXV0aG9yaXphdGlvbk1vZGUgfVxuICAgICAgOiB1bmRlZmluZWQpLFxuICAgIC4uLihhcGlLZXlDb25maWcgPyB7IGFwaUtleUNvbmZpZyB9IDogdW5kZWZpbmVkKSxcbiAgICAuLi4odXNlclBvb2xDb25maWcgPyB7IHVzZXJQb29sQ29uZmlnIH0gOiB1bmRlZmluZWQpLFxuICAgIC4uLihpYW1Db25maWcgPyB7IGlhbUNvbmZpZyB9IDogdW5kZWZpbmVkKSxcbiAgICAuLi4obGFtYmRhQ29uZmlnID8geyBsYW1iZGFDb25maWcgfSA6IHVuZGVmaW5lZCksXG4gICAgLi4uKG9pZGNDb25maWcgPyB7IG9pZGNDb25maWcgfSA6IHVuZGVmaW5lZCksXG4gIH07XG59O1xuXG4vKipcbiAqIFJldHVybiB3aGV0aGVyIG9yIG5vdCB0aGUgYXBpIHdpbGwgdXNlIGRlZmF1bHQgQVBJX0tFWSBhdXRoIGR1ZSB0byBhYnNlbmNlIG9mIGF1dGggcmVzb3VyY2VzIGFuZCBpbnB1dCBhdXRoLW1vZGVzLlxuICogQHBhcmFtIGF1dGhSZXNvdXJjZXMgdGhlIGdlbmVyYXRlZCBhdXRoIHJlc291cmNlcyBpbiB0aGUgc3lzdGVtXG4gKiBAcGFyYW0gYXV0aE1vZGVzIHRoZSBwcm92aWRlZCBhdXRoIG1vZGVzXG4gKiBAcmV0dXJucyBhIGJvb2xlYW4gaW5kaWNhdGluZyB3aGV0aGVyIG9yIG5vdCBkZWZhdWx0IGFwaSBrZXkgYXV0aCB3aWxsIGJlIHVzZWQuXG4gKi9cbmV4cG9ydCBjb25zdCBpc1VzaW5nRGVmYXVsdEFwaUtleUF1dGggPSAoXG4gIGF1dGhSZXNvdXJjZXM6IFByb3ZpZGVkQXV0aENvbmZpZyB8IHVuZGVmaW5lZCxcbiAgYXV0aE1vZGVzOiBBdXRob3JpemF0aW9uTW9kZXMgfCB1bmRlZmluZWRcbik6IGJvb2xlYW4gPT4ge1xuICByZXR1cm4gKFxuICAgIGF1dGhNb2RlcyA9PT0gdW5kZWZpbmVkICYmXG4gICAgY29tcHV0ZUFwaUtleUF1dGhGcm9tUmVzb3VyY2UoYXV0aFJlc291cmNlcywgYXV0aE1vZGVzKSAhPT0gdW5kZWZpbmVkXG4gICk7XG59O1xuIl19