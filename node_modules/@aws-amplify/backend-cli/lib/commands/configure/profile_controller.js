import { DEFAULT_PROFILE, getHomeDir, loadSharedConfigFiles, } from '@smithy/shared-ini-file-loader';
import { fromIni } from '@aws-sdk/credential-providers';
import { EOL } from 'os';
import fs from 'fs/promises';
import { join } from 'path';
/**
 * Manages AWS profiles.
 */
export class ProfileController {
    /**
     * Return true if the provided profile exists in the aws config and/or credential file.
     */
    profileExists = async (profile) => {
        const profileData = await loadSharedConfigFiles({
            ignoreCache: true,
        });
        return (profileData.configFile?.[profile] !== undefined ||
            profileData.credentialsFile?.[profile] !== undefined);
    };
    /**
     * Appends a profile to AWS config and credential files.
     */
    appendAWSFiles = async (options) => {
        await this.appendAWSConfigFile(options);
        await this.appendAWSCredentialFile(options);
    };
    appendAWSConfigFile = async (options) => {
        const filePath = process.env.AWS_CONFIG_FILE ?? join(getHomeDir(), '.aws', 'config');
        const fileEndsWithEOL = await this.isFileEndsWithEOL(filePath);
        let configData = fileEndsWithEOL ? '' : EOL;
        configData +=
            options.profile === DEFAULT_PROFILE
                ? `[${options.profile}]${EOL}`
                : `[profile ${options.profile}]${EOL}`;
        configData += `region = ${options.region}${EOL}`;
        await fs.appendFile(filePath, configData);
        // validate after write. It is to ensure this function is compatible with the current AWS format.
        const profileData = await loadSharedConfigFiles({
            ignoreCache: true,
        });
        const retrievedRegion = profileData.configFile?.[options.profile]?.region;
        if (retrievedRegion !== options.region) {
            throw new Error(`Failed to configure the AWS config file`);
        }
    };
    appendAWSCredentialFile = async (options) => {
        const filePath = process.env.AWS_SHARED_CREDENTIALS_FILE ??
            join(getHomeDir(), '.aws', 'credentials');
        const fileEndsWithEOL = await this.isFileEndsWithEOL(filePath);
        let credentialData = fileEndsWithEOL ? '' : EOL;
        credentialData += `[${options.profile}]${EOL}`;
        credentialData += `aws_access_key_id = ${options.accessKeyId}${EOL}`;
        credentialData += `aws_secret_access_key = ${options.secretAccessKey}${EOL}`;
        await fs.appendFile(filePath, credentialData);
        // validate after write. It is to ensure this function is compatible with the current AWS format.
        const provider = fromIni({
            profile: options.profile,
            ignoreCache: true,
        });
        const retrievedCredentials = await provider();
        if (retrievedCredentials.accessKeyId !== options.accessKeyId ||
            retrievedCredentials.secretAccessKey !== options.secretAccessKey ||
            retrievedCredentials.sessionToken) {
            throw new Error(`Failed to configure the AWS credentials file`);
        }
    };
    isFileEndsWithEOL = async (filePath) => {
        try {
            const data = await fs.readFile(filePath, 'utf-8');
            return data.length > 0 && data.slice(-EOL.length) === EOL;
        }
        catch (err) {
            const error = err;
            if (error.message.includes('ENOENT')) {
                // file doesn't exists
                return true;
            }
            throw err;
        }
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJvZmlsZV9jb250cm9sbGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2NvbW1hbmRzL2NvbmZpZ3VyZS9wcm9maWxlX2NvbnRyb2xsZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUNMLGVBQWUsRUFDZixVQUFVLEVBQ1YscUJBQXFCLEdBQ3RCLE1BQU0sZ0NBQWdDLENBQUM7QUFDeEMsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLCtCQUErQixDQUFDO0FBQ3hELE9BQU8sRUFBRSxHQUFHLEVBQUUsTUFBTSxJQUFJLENBQUM7QUFDekIsT0FBTyxFQUFFLE1BQU0sYUFBYSxDQUFDO0FBQzdCLE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxNQUFNLENBQUM7QUF3QjVCOztHQUVHO0FBQ0gsTUFBTSxPQUFPLGlCQUFpQjtJQUM1Qjs7T0FFRztJQUNILGFBQWEsR0FBRyxLQUFLLEVBQUUsT0FBZSxFQUFvQixFQUFFO1FBQzFELE1BQU0sV0FBVyxHQUFHLE1BQU0scUJBQXFCLENBQUM7WUFDOUMsV0FBVyxFQUFFLElBQUk7U0FDbEIsQ0FBQyxDQUFDO1FBRUgsT0FBTyxDQUNMLFdBQVcsQ0FBQyxVQUFVLEVBQUUsQ0FBQyxPQUFPLENBQUMsS0FBSyxTQUFTO1lBQy9DLFdBQVcsQ0FBQyxlQUFlLEVBQUUsQ0FBQyxPQUFPLENBQUMsS0FBSyxTQUFTLENBQ3JELENBQUM7SUFDSixDQUFDLENBQUM7SUFFRjs7T0FFRztJQUNILGNBQWMsR0FBRyxLQUFLLEVBQUUsT0FBdUIsRUFBRSxFQUFFO1FBQ2pELE1BQU0sSUFBSSxDQUFDLG1CQUFtQixDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQ3hDLE1BQU0sSUFBSSxDQUFDLHVCQUF1QixDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQzlDLENBQUMsQ0FBQztJQUVNLG1CQUFtQixHQUFHLEtBQUssRUFBRSxPQUE2QixFQUFFLEVBQUU7UUFDcEUsTUFBTSxRQUFRLEdBQ1os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TSxDQUFDLEtBQUssR0FBRyxDQUFDO1NBQzNEO1FBQUMsT0FBTyxHQUFHLEVBQUU7WUFDWixNQUFNLEtBQUssR0FBRyxHQUFZLENBQUM7WUFDM0IsSUFBSSxLQUFLLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUMsRUFBRTtnQkFDcEMsc0JBQXNCO2dCQUN0QixPQUFPLElBQUksQ0FBQzthQUNiO1lBQ0QsTUFBTSxHQUFHLENBQUM7U0FDWDtJQUNILENBQUMsQ0FBQztDQUNIIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgREVGQVVMVF9QUk9GSUxFLFxuICBnZXRIb21lRGlyLFxuICBsb2FkU2hhcmVkQ29uZmlnRmlsZXMsXG59IGZyb20gJ0BzbWl0aHkvc2hhcmVkLWluaS1maWxlLWxvYWRlcic7XG5pbXBvcnQgeyBmcm9tSW5pIH0gZnJvbSAnQGF3cy1zZGsvY3JlZGVudGlhbC1wcm92aWRlcnMnO1xuaW1wb3J0IHsgRU9MIH0gZnJvbSAnb3MnO1xuaW1wb3J0IGZzIGZyb20gJ2ZzL3Byb21pc2VzJztcbmltcG9ydCB7IGpvaW4gfSBmcm9tICdwYXRoJztcblxuLyoqXG4gKiBPcHRpb25zIGZvciB0aGUgcHJvZmlsZSBjb25maWd1cmF0aW9uLlxuICovXG50eXBlIENvbmZpZ1Byb2ZpbGVPcHRpb25zID0ge1xuICBwcm9maWxlOiBzdHJpbmc7XG4gIHJlZ2lvbjogc3RyaW5nO1xufTtcblxuLyoqXG4gKiBPcHRpb25zIGZvciB0aGUgcHJvZmlsZSBjcmVkZW50aWFsLlxuICovXG50eXBlIENyZWRlbnRpYWxQcm9maWxlT3B0aW9ucyA9IHtcbiAgcHJvZmlsZTogc3RyaW5nO1xuICBhY2Nlc3NLZXlJZDogc3RyaW5nO1xuICBzZWNyZXRBY2Nlc3NLZXk6IHN0cmluZztcbn07XG5cbi8qKlxuICogT3B0aW9ucyBmb3IgdGhlIHByb2ZpbGUgY29uZmlndXJhdGlvbiBhbmQgY3JlZGVudGlhbC5cbiAqL1xuZXhwb3J0IHR5cGUgUHJvZmlsZU9wdGlvbnMgPSBDb25maWdQcm9maWxlT3B0aW9ucyAmIENyZWRlbnRpYWxQcm9maWxlT3B0aW9ucztcblxuLyoqXG4gKiBNYW5hZ2VzIEFXUyBwcm9maWxlcy5cbiAqL1xuZXhwb3J0IGNsYXNzIFByb2ZpbGVDb250cm9sbGVyIHtcbiAgLyoqXG4gICAqIFJldHVybiB0cnVlIGlmIHRoZSBwcm92aWRlZCBwcm9maWxlIGV4aXN0cyBpbiB0aGUgYXdzIGNvbmZpZyBhbmQvb3IgY3JlZGVudGlhbCBmaWxlLlxuICAgKi9cbiAgcHJvZmlsZUV4aXN0cyA9IGFzeW5jIChwcm9maWxlOiBzdHJpbmcpOiBQcm9taXNlPGJvb2xlYW4+ID0+IHtcbiAgICBjb25zdCBwcm9maWxlRGF0YSA9IGF3YWl0IGxvYWRTaGFyZWRDb25maWdGaWxlcyh7XG4gICAgICBpZ25vcmVDYWNoZTogdHJ1ZSxcbiAgICB9KTtcblxuICAgIHJldHVybiAoXG4gICAgICBwcm9maWxlRGF0YS5jb25maWdGaWxlPy5bcHJvZmlsZV0gIT09IHVuZGVmaW5lZCB8fFxuICAgICAgcHJvZmlsZURhdGEuY3JlZGVudGlhbHNGaWxlPy5bcHJvZmlsZV0gIT09IHVuZGVmaW5lZFxuICAgICk7XG4gIH07XG5cbiAgLyoqXG4gICAqIEFwcGVuZHMgYSBwcm9maWxlIHRvIEFXUyBjb25maWcgYW5kIGNyZWRlbnRpYWwgZmlsZXMuXG4gICAqL1xuICBhcHBlbmRBV1NGaWxlcyA9IGFzeW5jIChvcHRpb25zOiBQcm9maWxlT3B0aW9ucykgPT4ge1xuICAgIGF3YWl0IHRoaXMuYXBwZW5kQVdTQ29uZmlnRmlsZShvcHRpb25zKTtcbiAgICBhd2FpdCB0aGlzLmFwcGVuZEFXU0NyZWRlbnRpYWxGaWxlKG9wdGlvbnMpO1xuICB9O1xuXG4gIHByaXZhdGUgYXBwZW5kQVdTQ29uZmlnRmlsZSA9IGFzeW5jIChvcHRpb25zOiBDb25maWdQcm9maWxlT3B0aW9ucykgPT4ge1xuICAgIGNvbnN0IGZpbGVQYXRoID1cbiAgICAgIHByb2Nlc3MuZW52LkFXU19DT05GSUdfRklMRSA/PyBqb2luKGdldEhvbWVEaXIoKSwgJy5hd3MnLCAnY29uZmlnJyk7XG5cbiAgICBjb25zdCBmaWxlRW5kc1dpdGhFT0wgPSBhd2FpdCB0aGlzLmlzRmlsZUVuZHNXaXRoRU9MKGZpbGVQYXRoKTtcbiAgICBsZXQgY29uZmlnRGF0YSA9IGZpbGVFbmRzV2l0aEVPTCA/ICcnIDogRU9MO1xuXG4gICAgY29uZmlnRGF0YSArPVxuICAgICAgb3B0aW9ucy5wcm9maWxlID09PSBERUZBVUxUX1BST0ZJTEVcbiAgICAgICAgPyBgWyR7b3B0aW9ucy5wcm9maWxlfV0ke0VPTH1gXG4gICAgICAgIDogYFtwcm9maWxlICR7b3B0aW9ucy5wcm9maWxlfV0ke0VPTH1gO1xuICAgIGNvbmZpZ0RhdGEgKz0gYHJlZ2lvbiA9ICR7b3B0aW9ucy5yZWdpb259JHtFT0x9YDtcblxuICAgIGF3YWl0IGZzLmFwcGVuZEZpbGUoZmlsZVBhdGgsIGNvbmZpZ0RhdGEpO1xuXG4gICAgLy8gdmFsaWRhdGUgYWZ0ZXIgd3JpdGUuIEl0IGlzIHRvIGVuc3VyZSB0aGlzIGZ1bmN0aW9uIGlzIGNvbXBhdGlibGUgd2l0aCB0aGUgY3VycmVudCBBV1MgZm9ybWF0LlxuICAgIGNvbnN0IHByb2ZpbGVEYXRhID0gYXdhaXQgbG9hZFNoYXJlZENvbmZpZ0ZpbGVzKHtcbiAgICAgIGlnbm9yZUNhY2hlOiB0cnVlLFxuICAgIH0pO1xuICAgIGNvbnN0IHJldHJpZXZlZFJlZ2lvbiA9IHByb2ZpbGVEYXRhLmNvbmZpZ0ZpbGU/LltvcHRpb25zLnByb2ZpbGVdPy5yZWdpb247XG4gICAgaWYgKHJldHJpZXZlZFJlZ2lvbiAhPT0gb3B0aW9ucy5yZWdpb24pIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgRmFpbGVkIHRvIGNvbmZpZ3VyZSB0aGUgQVdTIGNvbmZpZyBmaWxlYCk7XG4gICAgfVxuICB9O1xuXG4gIHByaXZhdGUgYXBwZW5kQVdTQ3JlZGVudGlhbEZpbGUgPSBhc3luYyAoXG4gICAgb3B0aW9uczogQ3JlZGVudGlhbFByb2ZpbGVPcHRpb25zXG4gICkgPT4ge1xuICAgIGNvbnN0IGZpbGVQYXRoID1cbiAgICAgIHByb2Nlc3MuZW52LkFXU19TSEFSRURfQ1JFREVOVElBTFNfRklMRSA/P1xuICAgICAgam9pbihnZXRIb21lRGlyKCksICcuYXdzJywgJ2NyZWRlbnRpYWxzJyk7XG5cbiAgICBjb25zdCBmaWxlRW5kc1dpdGhFT0wgPSBhd2FpdCB0aGlzLmlzRmlsZUVuZHNXaXRoRU9MKGZpbGVQYXRoKTtcbiAgICBsZXQgY3JlZGVudGlhbERhdGEgPSBmaWxlRW5kc1dpdGhFT0wgPyAnJyA6IEVPTDtcblxuICAgIGNyZWRlbnRpYWxEYXRhICs9IGBbJHtvcHRpb25zLnByb2ZpbGV9XSR7RU9MfWA7XG4gICAgY3JlZGVudGlhbERhdGEgKz0gYGF3c19hY2Nlc3Nfa2V5X2lkID0gJHtvcHRpb25zLmFjY2Vzc0tleUlkfSR7RU9MfWA7XG4gICAgY3JlZGVudGlhbERhdGEgKz0gYGF3c19zZWNyZXRfYWNjZXNzX2tleSA9ICR7b3B0aW9ucy5zZWNyZXRBY2Nlc3NLZXl9JHtFT0x9YDtcblxuICAgIGF3YWl0IGZzLmFwcGVuZEZpbGUoZmlsZVBhdGgsIGNyZWRlbnRpYWxEYXRhKTtcblxuICAgIC8vIHZhbGlkYXRlIGFmdGVyIHdyaXRlLiBJdCBpcyB0byBlbnN1cmUgdGhpcyBmdW5jdGlvbiBpcyBjb21wYXRpYmxlIHdpdGggdGhlIGN1cnJlbnQgQVdTIGZvcm1hdC5cbiAgICBjb25zdCBwcm92aWRlciA9IGZyb21Jbmkoe1xuICAgICAgcHJvZmlsZTogb3B0aW9ucy5wcm9maWxlLFxuICAgICAgaWdub3JlQ2FjaGU6IHRydWUsXG4gICAgfSk7XG4gICAgY29uc3QgcmV0cmlldmVkQ3JlZGVudGlhbHMgPSBhd2FpdCBwcm92aWRlcigpO1xuICAgIGlmIChcbiAgICAgIHJldHJpZXZlZENyZWRlbnRpYWxzLmFjY2Vzc0tleUlkICE9PSBvcHRpb25zLmFjY2Vzc0tleUlkIHx8XG4gICAgICByZXRyaWV2ZWRDcmVkZW50aWFscy5zZWNyZXRBY2Nlc3NLZXkgIT09IG9wdGlvbnMuc2VjcmV0QWNjZXNzS2V5IHx8XG4gICAgICByZXRyaWV2ZWRDcmVkZW50aWFscy5zZXNzaW9uVG9rZW5cbiAgICApIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgRmFpbGVkIHRvIGNvbmZpZ3VyZSB0aGUgQVdTIGNyZWRlbnRpYWxzIGZpbGVgKTtcbiAgICB9XG4gIH07XG5cbiAgcHJpdmF0ZSBpc0ZpbGVFbmRzV2l0aEVPTCA9IGFzeW5jIChmaWxlUGF0aDogc3RyaW5nKTogUHJvbWlzZTxib29sZWFuPiA9PiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGRhdGEgPSBhd2FpdCBmcy5yZWFkRmlsZShmaWxlUGF0aCwgJ3V0Zi04Jyk7XG4gICAgICByZXR1cm4gZGF0YS5sZW5ndGggPiAwICYmIGRhdGEuc2xpY2UoLUVPTC5sZW5ndGgpID09PSBFT0w7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBjb25zdCBlcnJvciA9IGVyciBhcyBFcnJvcjtcbiAgICAgIGlmIChlcnJvci5tZXNzYWdlLmluY2x1ZGVzKCdFTk9FTlQnKSkge1xuICAgICAgICAvLyBmaWxlIGRvZXNuJ3QgZXhpc3RzXG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgfVxuICAgICAgdGhyb3cgZXJyO1xuICAgIH1cbiAgfTtcbn1cbiJdfQ==