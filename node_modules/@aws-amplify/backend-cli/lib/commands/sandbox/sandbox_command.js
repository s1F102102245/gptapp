import fsp from 'fs/promises';
import { AmplifyPrompter } from '@aws-amplify/cli-core';
import { ClientConfigFormat, getClientConfigPath, } from '@aws-amplify/client-config';
import { handleCommandFailure } from '../../command_failure_handler.js';
import { ClientConfigLifecycleHandler } from '../../client-config/client_config_lifecycle_handler.js';
/**
 * Command that starts sandbox.
 */
export class SandboxCommand {
    sandboxFactory;
    sandboxSubCommands;
    clientConfigGeneratorAdapter;
    commandMiddleware;
    sandboxEventHandlerCreator;
    /**
     * @inheritDoc
     */
    command;
    /**
     * @inheritDoc
     */
    describe;
    sandboxName;
    /**
     * Creates sandbox command.
     */
    constructor(sandboxFactory, sandboxSubCommands, clientConfigGeneratorAdapter, commandMiddleware, sandboxEventHandlerCreator) {
        this.sandboxFactory = sandboxFactory;
        this.sandboxSubCommands = sandboxSubCommands;
        this.clientConfigGeneratorAdapter = clientConfigGeneratorAdapter;
        this.commandMiddleware = commandMiddleware;
        this.sandboxEventHandlerCreator = sandboxEventHandlerCreator;
        this.command = 'sandbox';
        this.describe = 'Starts sandbox, watch mode for amplify deployments';
    }
    /**
     * @inheritDoc
     */
    handler = async (args) => {
        const sandbox = await this.sandboxFactory.getInstance();
        this.sandboxName = args.name;
        // attaching event handlers
        const clientConfigLifecycleHandler = new ClientConfigLifecycleHandler(this.clientConfigGeneratorAdapter, args['config-out-dir'], args['config-format']);
        const eventHandlers = this.sandboxEventHandlerCreator?.({
            sandboxName: this.sandboxName,
            clientConfigLifecycleHandler,
        });
        if (eventHandlers) {
            Object.entries(eventHandlers).forEach(([event, handlers]) => {
                handlers.forEach((handler) => sandbox.on(event, handler));
            });
        }
        const watchExclusions = args.exclude ?? [];
        const clientConfigWritePath = await getClientConfigPath(args['config-out-dir'], args['config-format']);
        watchExclusions.push(clientConfigWritePath);
        await sandbox.start({
            dir: args['dir-to-watch'],
            exclude: watchExclusions,
            name: args.name,
            profile: args.profile,
        });
        process.once('SIGINT', () => void this.sigIntHandler());
    };
    /**
     * @inheritDoc
     */
    builder = (yargs) => {
        return (yargs
            // Cast to erase options types used in internal sub command implementation. Otherwise, compiler fails here.
            .command(this.sandboxSubCommands)
            .version(false)
            .option('dir-to-watch', {
            describe: 'Directory to watch for file changes. All subdirectories and files will be included. defaults to the current directory.',
            type: 'string',
            array: false,
            global: false,
        })
            .option('exclude', {
            describe: 'An array of paths or glob patterns to ignore. Paths can be relative or absolute and can either be files or directories',
            type: 'string',
            array: true,
            global: false,
        })
            .option('name', {
            describe: 'An optional name to distinguish between different sandbox environments. Default is the name in your package.json',
            type: 'string',
            array: false,
            global: false,
        })
            .option('config-format', {
            describe: 'Client config output format',
            type: 'string',
            array: false,
            choices: Object.values(ClientConfigFormat),
            global: false,
        })
            .option('config-out-dir', {
            describe: 'A path to directory where config is written. If not provided defaults to current process working directory.',
            type: 'string',
            array: false,
            global: false,
        })
            .option('profile', {
            describe: 'An AWS profile name.',
            type: 'string',
            array: false,
        })
            .check(async (argv) => {
            if (argv['dir-to-watch']) {
                await this.validateDirectory('dir-to-watch', argv['dir-to-watch']);
            }
            if (argv['config-out-dir']) {
                await this.validateDirectory('config-out-dir', argv['config-out-dir']);
            }
            if (argv.name) {
                const projectNameRegex = /^[a-zA-Z0-9-]{1,15}$/;
                if (!argv.name.match(projectNameRegex)) {
                    throw new Error(`--name should match [a-zA-Z0-9-] and less than 15 characters.`);
                }
            }
            return true;
        })
            .middleware([this.commandMiddleware.ensureAwsCredentialAndRegion])
            .fail((msg, err) => {
            handleCommandFailure(msg, err, yargs);
            yargs.exit(1, err);
        }));
    };
    sigIntHandler = async () => {
        const answer = await AmplifyPrompter.yesOrNo({
            message: 'Would you like to delete all the resources in your sandbox environment (This cannot be undone)?',
            defaultValue: false,
        });
        if (answer)
            await (await this.sandboxFactory.getInstance()).delete({ name: this.sandboxName });
    };
    validateDirectory = async (option, dir) => {
        let stats;
        try {
            stats = await fsp.stat(dir, {});
        }
        catch (e) {
            throw new Error(`--${option} ${dir} does not exist`);
        }
        if (!stats.isDirectory()) {
            throw new Error(`--${option} ${dir} is not a valid directory`);
        }
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2FuZGJveF9jb21tYW5kLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2NvbW1hbmRzL3NhbmRib3gvc2FuZGJveF9jb21tYW5kLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sR0FBRyxNQUFNLGFBQWEsQ0FBQztBQUM5QixPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFFeEQsT0FBTyxFQUNMLGtCQUFrQixFQUNsQixtQkFBbUIsR0FDcEIsTUFBTSw0QkFBNEIsQ0FBQztBQUVwQyxPQUFPLEVBQUUsb0JBQW9CLEVBQUUsTUFBTSxrQ0FBa0MsQ0FBQztBQUN4RSxPQUFPLEVBQUUsNEJBQTRCLEVBQUUsTUFBTSx3REFBd0QsQ0FBQztBQWlDdEc7O0dBRUc7QUFDSCxNQUFNLE9BQU8sY0FBYztJQW1CTjtJQUNBO0lBQ1Q7SUFDQTtJQUNTO0lBcEJuQjs7T0FFRztJQUNNLE9BQU8sQ0FBUztJQUV6Qjs7T0FFRztJQUNNLFFBQVEsQ0FBUztJQUVsQixXQUFXLENBQVU7SUFFN0I7O09BRUc7SUFDSCxZQUNtQixjQUF1QyxFQUN2QyxrQkFBbUMsRUFDNUMsNEJBQTBELEVBQzFELGlCQUFvQyxFQUMzQiwwQkFBdUQ7UUFKdkQsbUJBQWMsR0FBZCxjQUFjLENBQXlCO1FBQ3ZDLHVCQUFrQixHQUFsQixrQkFBa0IsQ0FBaUI7UUFDNUMsaUNBQTRCLEdBQTVCLDRCQUE0QixDQUE4QjtRQUMxRCxzQkFBaUIsR0FBakIsaUJBQWlCLENBQW1CO1FBQzNCLCtCQUEwQixHQUExQiwwQkFBMEIsQ0FBNkI7UUFFeEUsSUFBSSxDQUFDLE9BQU8sR0FBRyxTQUFTLENBQUM7UUFDekIsSUFBSSxDQUFDLFFBQVEsR0FBRyxvREFBb0QsQ0FBQztJQUN2RSxDQUFDO0lBRUQ7O09BRUc7SUFDSCxPQUFPLEdBQUcsS0FBSyxFQUFFLElBQTJCLEVBQWlCLEVBQUU7UUFDN0QsTUFBTSxPQUFPLEdBQUcsTUFBTSxJQUFJLENBQUMsY0FBYyxDQUFDLFdBQVcsRUFBRSxDQUFDO1FBQ3hELElBQUksQ0FBQyxXQUFXLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQztRQUU3QiwyQkFBMkI7UUFDM0IsTUFBTSw0QkFBNEIsR0FBRyxJQUFJLDRCQUE0QixDQUNuRSxJQUFJLENBQUMsNEJBQTRCLEVBQ2pDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxFQUN0QixJQUFJLENBQUMsZUFBZSxDQUFDLENBQ3RCLENBQUM7UUFDRixNQUFNLGFBQWEsR0FBRyxJQUFJLENBQUMsMEJBQTBCLEVBQUUsQ0FBQztZQUN0RCxXQUFXLEVBQUUsSUFBSSxDQUFDLFdBQVc7WUFDN0IsNEJBQTRCO1NBQzdCLENBQUMsQ0FBQztRQUNILElBQUksYUFBYSxFQUFFO1lBQ2pCLE1BQU0sQ0FBQyxPQUFPLENBQUMsYUFBYSxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxLQUFLLEVBQUUsUUFBUSxDQUFDLEVBQUUsRUFBRTtnQkFDMUQsUUFBUSxDQUFDLE9BQU8sQ0FBQyxDQUFDLE9BQU8sRUFBRSxFQUFFLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxLQUFLLEVBQUUsT0FBTyxDQUFDLENBQUMsQ0FBQztZQUM1RCxDQUFDLENBQUMsQ0FBQztTQUNKO1FBQ0QsTUFBTSxlQUFlLEdBQUcsSUFBSSxDQUFDLE9BQU8sSUFBSSxFQUFFLENBQUM7UUFDM0MsTUFBTSxxQkFBcUIsR0FBRyxNQUFNLG1CQUFtQixDQUNyRCxJQUFJLENBQUMsZ0JBQWdCLENBQUMsRUFDdEIsSUFBSSxDQUFDLGVBQWUsQ0FBQyxDQUN0QixDQUFDO1FBQ0YsZUFBZSxDQUFDLElBQUksQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDO1FBQzVDLE1BQU0sT0FBTyxDQUFDLEtBQUssQ0FBQztZQUNsQixHQUFHLEVBQUUsSUFBSSxDQUFDLGNBQWMsQ0FBQztZQUN6QixPQUFPLEVBQUUsZUFBZTtZQUN4QixJQUFJLEVBQUUsSUFBSSxDQUFDLElBQUk7WUFDZixPQUFPLEVBQUUsSUFBSSxDQUFDLE9BQU87U0FDdEIsQ0FBQyxDQUFDO1FBQ0gsT0FBTyxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUUsR0FBRyxFQUFFLENBQUMsS0FBSyxJQUFJLENBQUMsYUFBYSxFQUFFLENBQUMsQ0FBQztJQUMxRCxDQUFDLENBQUM7SUFFRjs7T0FFRztJQUNILE9BQU8sR0FBRyxDQUFDLEtBQVcsRUFBK0IsRUFBRTtRQUNyRCxPQUFPLENBQ0wsS0FBSztZQUNILDJHQUEyRzthQUMxRyxPQUFPLENBQUMsSUFBSSxDQUFDLGtCQUFrQixDQUFDO2FBQ2hDLE9BQU8sQ0FBQyxLQUFLLENBQUM7YUFDZCxNQUFNLENBQUMsY0FBYyxFQUFFO1lBQ3RCLFFBQVEsRUFDTix3SEFBd0g7WUFDMUgsSUFBSSxFQUFFLFFBQVE7WUFDZCxLQUFLLEVBQUUsS0FBSztZQUNaLE1BQU0sRUFBRSxLQUFLO1NBQ2QsQ0FBQzthQUNELE1BQU0sQ0FBQyxTQUFTLEVBQUU7WUFDakIsUUFBUSxFQUNOLHdIQUF3SDtZQUMxSCxJQUFJLEVBQUUsUUFBUTtZQUNkLEtBQUssRUFBRSxJQUFJO1lBQ1gsTUFBTSxFQUFFLEtBQUs7U0FDZCxDQUFDO2FBQ0QsTUFBTSxDQUFDLE1BQU0sRUFBRTtZQUNkLFFBQVEsRUFDTixrSEFBa0g7WUFDcEgsSUFBSSxFQUFFLFFBQVE7WUFDZCxLQUFLLEVBQUUsS0FBSztZQUNaLE1BQU0sRUFBRSxLQUFLO1NBQ2QsQ0FBQzthQUNELE1BQU0sQ0FBQyxlQUFlLEVBQUU7WUFDdkIsUUFBUSxFQUFFLDZCQUE2QjtZQUN2QyxJQUFJLEVBQUUsUUFBUTtZQUNkLEtBQUssRUFBRSxLQUFLO1lBQ1osT0FBTyxFQUFFLE1BQU0sQ0FBQyxNQUFNLENBQUMsa0JBQWtCLENBQUM7WUFDMUMsTUFBTSxFQUFFLEtBQUs7U0FDZCxDQUFDO2FBQ0QsTUFBTSxDQUFDLGdCQUFnQixFQUFFO1lBQ3hCLFFBQVEsRUFDTiw2R0FBNkc7WUFDL0csSUFBSSxFQUFFLFFBQVE7WUFDZCxLQUFLLEVBQUUsS0FBSztZQUNaLE1BQU0sRUFBRSxLQUFLO1NBQ2QsQ0FBQzthQUNELE1BQU0sQ0FBQyxTQUFTLEVBQUU7WUFDakIsUUFBUSxFQUFFLHNCQUFzQjtZQUNoQyxJQUFJLEVBQUUsUUFBUTtZQUNkLEtBQUssRUFBRSxLQUFLO1NBQ2IsQ0FBQzthQUNELEtBQUssQ0FBQyxLQUFLLEVBQUUsSUFBSSxFQUFFLEVBQUU7WUFDcEIsSUFBSSxJQUFJLENBQUMsY0FBYyxDQUFDLEVBQUU7Z0JBQ3hCLE1BQU0sSUFBSSxDQUFDLGlCQUFpQixDQUFDLGNBQWMsRUFBRSxJQUFJLENBQUMsY0FBYyxDQUFDLENBQUMsQ0FBQzthQUNwRTtZQUNELElBQUksSUFBSSxDQUFDLGdCQUFnQixDQUFDLEVBQUU7Z0JBQzFCLE1BQU0sSUFBSSxDQUFDLGlCQUFpQixDQUMxQixnQkFBZ0IsRUFDaEIsSUFBSSxDQUFDLGdCQUFnQixDQUFDLENBQ3ZCLENBQUM7YUFDSDtZQUNELElBQUksSUFBSSxDQUFDLElBQUksRUFBRTtnQkFDYixNQUFNLGdCQUFnQixHQUFHLHNCQUFzQixDQUFDO2dCQUNoRCxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsZ0JBQWdCLENBQUMsRUFBRTtvQkFDdEMsTUFBTSxJQUFJLEtBQUssQ0FDYiwrREFBK0QsQ0FDaEUsQ0FBQztpQkFDSDthQUNGO1lBQ0QsT0FBTyxJQUFJLENBQUM7UUFDZCxDQUFDLENBQUM7YUFDRCxVQUFVLENBQUMsQ0FBQyxJQUFJLENBQUMsaUJBQWlCLENBQUMsNEJBQTRCLENBQUMsQ0FBQzthQUNqRSxJQUFJLENBQUMsQ0FBQyxHQUFHLEVBQUUsR0FBRyxFQUFFLEVBQUU7WUFDakIsb0JBQW9CLENBQUMsR0FBRyxFQUFFLEdBQUcsRUFBRSxLQUFLLENBQUMsQ0FBQztZQUN0QyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUMsRUFBRSxHQUFHLENBQUMsQ0FBQztRQUNyQixDQUFDLENBQUMsQ0FDTCxDQUFDO0lBQ0osQ0FBQyxDQUFDO0lBRUYsYUFBYSxHQUFHLEtBQUssSUFBSSxFQUFFO1FBQ3pCLE1BQU0sTUFBTSxHQUFHLE1BQU0sZUFBZSxDQUFDLE9BQU8sQ0FBQztZQUMzQyxPQUFPLEVBQ0wsaUdBQWlHO1lBQ25HLFlBQVksRUFBRSxLQUFLO1NBQ3BCLENBQUMsQ0FBQztRQUNILElBQUksTUFBTTtZQUNSLE1BQU0sQ0FDSixNQUFNLElBQUksQ0FBQyxjQUFjLENBQUMsV0FBVyxFQUFFLENBQ3hDLENBQUMsTUFBTSxDQUFDLEVBQUUsSUFBSSxFQUFFLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQyxDQUFDO0lBQ3pDLENBQUMsQ0FBQztJQUVNLGlCQUFpQixHQUFHLEtBQUssRUFBRSxNQUFjLEVBQUUsR0FBVyxFQUFFLEVBQUU7UUFDaEUsSUFBSSxLQUFLLENBQUM7UUFDVixJQUFJO1lBQ0YsS0FBSyxHQUFHLE1BQU0sR0FBRyxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUUsRUFBRSxDQUFDLENBQUM7U0FDakM7UUFBQyxPQUFPLENBQUMsRUFBRTtZQUNWLE1BQU0sSUFBSSxLQUFLLENBQUMsS0FBSyxNQUFNLElBQUksR0FBRyxpQkFBaUIsQ0FBQyxDQUFDO1NBQ3REO1FBQ0QsSUFBSSxDQUFDLEtBQUssQ0FBQyxXQUFXLEVBQUUsRUFBRTtZQUN4QixNQUFNLElBQUksS0FBSyxDQUFDLEtBQUssTUFBTSxJQUFJLEdBQUcsMkJBQTJCLENBQUMsQ0FBQztTQUNoRTtJQUNILENBQUMsQ0FBQztDQUNIIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQXJndiwgQ29tbWFuZE1vZHVsZSB9IGZyb20gJ3lhcmdzJztcbmltcG9ydCBmc3AgZnJvbSAnZnMvcHJvbWlzZXMnO1xuaW1wb3J0IHsgQW1wbGlmeVByb21wdGVyIH0gZnJvbSAnQGF3cy1hbXBsaWZ5L2NsaS1jb3JlJztcbmltcG9ydCB7IFNhbmRib3hTaW5nbGV0b25GYWN0b3J5IH0gZnJvbSAnQGF3cy1hbXBsaWZ5L3NhbmRib3gnO1xuaW1wb3J0IHtcbiAgQ2xpZW50Q29uZmlnRm9ybWF0LFxuICBnZXRDbGllbnRDb25maWdQYXRoLFxufSBmcm9tICdAYXdzLWFtcGxpZnkvY2xpZW50LWNvbmZpZyc7XG5pbXBvcnQgeyBBcmd1bWVudHNLZWJhYkNhc2UgfSBmcm9tICcuLi8uLi9rZWJhYl9jYXNlLmpzJztcbmltcG9ydCB7IGhhbmRsZUNvbW1hbmRGYWlsdXJlIH0gZnJvbSAnLi4vLi4vY29tbWFuZF9mYWlsdXJlX2hhbmRsZXIuanMnO1xuaW1wb3J0IHsgQ2xpZW50Q29uZmlnTGlmZWN5Y2xlSGFuZGxlciB9IGZyb20gJy4uLy4uL2NsaWVudC1jb25maWcvY2xpZW50X2NvbmZpZ19saWZlY3ljbGVfaGFuZGxlci5qcyc7XG5pbXBvcnQgeyBDbGllbnRDb25maWdHZW5lcmF0b3JBZGFwdGVyIH0gZnJvbSAnLi4vLi4vY2xpZW50LWNvbmZpZy9jbGllbnRfY29uZmlnX2dlbmVyYXRvcl9hZGFwdGVyLmpzJztcbmltcG9ydCB7IENvbW1hbmRNaWRkbGV3YXJlIH0gZnJvbSAnLi4vLi4vY29tbWFuZF9taWRkbGV3YXJlLmpzJztcblxuZXhwb3J0IHR5cGUgU2FuZGJveENvbW1hbmRPcHRpb25zID1cbiAgQXJndW1lbnRzS2ViYWJDYXNlPFNhbmRib3hDb21tYW5kT3B0aW9uc0NhbWVsQ2FzZT47XG5cbnR5cGUgU2FuZGJveENvbW1hbmRPcHRpb25zQ2FtZWxDYXNlID0ge1xuICBkaXJUb1dhdGNoOiBzdHJpbmcgfCB1bmRlZmluZWQ7XG4gIGV4Y2x1ZGU6IHN0cmluZ1tdIHwgdW5kZWZpbmVkO1xuICBuYW1lOiBzdHJpbmcgfCB1bmRlZmluZWQ7XG4gIGNvbmZpZ0Zvcm1hdDogQ2xpZW50Q29uZmlnRm9ybWF0IHwgdW5kZWZpbmVkO1xuICBjb25maWdPdXREaXI6IHN0cmluZyB8IHVuZGVmaW5lZDtcbiAgcHJvZmlsZTogc3RyaW5nIHwgdW5kZWZpbmVkO1xufTtcblxuZXhwb3J0IHR5cGUgRXZlbnRIYW5kbGVyID0gKC4uLmFyZ3M6IHVua25vd25bXSkgPT4gdm9pZDtcblxuZXhwb3J0IHR5cGUgU2FuZGJveEV2ZW50SGFuZGxlcnMgPSB7XG4gIHN1Y2Nlc3NmdWxEZXBsb3ltZW50OiBFdmVudEhhbmRsZXJbXTtcbiAgc3VjY2Vzc2Z1bERlbGV0aW9uOiBFdmVudEhhbmRsZXJbXTtcbiAgZmFpbGVkRGVwbG95bWVudDogRXZlbnRIYW5kbGVyW107XG59O1xuXG5leHBvcnQgdHlwZSBTYW5kYm94RXZlbnRIYW5kbGVyUGFyYW1zID0ge1xuICBzYW5kYm94TmFtZT86IHN0cmluZztcbiAgY2xpZW50Q29uZmlnTGlmZWN5Y2xlSGFuZGxlcjogQ2xpZW50Q29uZmlnTGlmZWN5Y2xlSGFuZGxlcjtcbn07XG5cbmV4cG9ydCB0eXBlIFNhbmRib3hFdmVudEhhbmRsZXJDcmVhdG9yID0gKFxuICBwYXJhbXM6IFNhbmRib3hFdmVudEhhbmRsZXJQYXJhbXNcbikgPT4gU2FuZGJveEV2ZW50SGFuZGxlcnM7XG5cbi8qKlxuICogQ29tbWFuZCB0aGF0IHN0YXJ0cyBzYW5kYm94LlxuICovXG5leHBvcnQgY2xhc3MgU2FuZGJveENvbW1hbmRcbiAgaW1wbGVtZW50cyBDb21tYW5kTW9kdWxlPG9iamVjdCwgU2FuZGJveENvbW1hbmRPcHRpb25zPlxue1xuICAvKipcbiAgICogQGluaGVyaXREb2NcbiAgICovXG4gIHJlYWRvbmx5IGNvbW1hbmQ6IHN0cmluZztcblxuICAvKipcbiAgICogQGluaGVyaXREb2NcbiAgICovXG4gIHJlYWRvbmx5IGRlc2NyaWJlOiBzdHJpbmc7XG5cbiAgcHJpdmF0ZSBzYW5kYm94TmFtZT86IHN0cmluZztcblxuICAvKipcbiAgICogQ3JlYXRlcyBzYW5kYm94IGNvbW1hbmQuXG4gICAqL1xuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIHJlYWRvbmx5IHNhbmRib3hGYWN0b3J5OiBTYW5kYm94U2luZ2xldG9uRmFjdG9yeSxcbiAgICBwcml2YXRlIHJlYWRvbmx5IHNhbmRib3hTdWJDb21tYW5kczogQ29tbWFuZE1vZHVsZVtdLFxuICAgIHByaXZhdGUgY2xpZW50Q29uZmlnR2VuZXJhdG9yQWRhcHRlcjogQ2xpZW50Q29uZmlnR2VuZXJhdG9yQWRhcHRlcixcbiAgICBwcml2YXRlIGNvbW1hbmRNaWRkbGV3YXJlOiBDb21tYW5kTWlkZGxld2FyZSxcbiAgICBwcml2YXRlIHJlYWRvbmx5IHNhbmRib3hFdmVudEhhbmRsZXJDcmVhdG9yPzogU2FuZGJveEV2ZW50SGFuZGxlckNyZWF0b3JcbiAgKSB7XG4gICAgdGhpcy5jb21tYW5kID0gJ3NhbmRib3gnO1xuICAgIHRoaXMuZGVzY3JpYmUgPSAnU3RhcnRzIHNhbmRib3gsIHdhdGNoIG1vZGUgZm9yIGFtcGxpZnkgZGVwbG95bWVudHMnO1xuICB9XG5cbiAgLyoqXG4gICAqIEBpbmhlcml0RG9jXG4gICAqL1xuICBoYW5kbGVyID0gYXN5bmMgKGFyZ3M6IFNhbmRib3hDb21tYW5kT3B0aW9ucyk6IFByb21pc2U8dm9pZD4gPT4ge1xuICAgIGNvbnN0IHNhbmRib3ggPSBhd2FpdCB0aGlzLnNhbmRib3hGYWN0b3J5LmdldEluc3RhbmNlKCk7XG4gICAgdGhpcy5zYW5kYm94TmFtZSA9IGFyZ3MubmFtZTtcblxuICAgIC8vIGF0dGFjaGluZyBldmVudCBoYW5kbGVyc1xuICAgIGNvbnN0IGNsaWVudENvbmZpZ0xpZmVjeWNsZUhhbmRsZXIgPSBuZXcgQ2xpZW50Q29uZmlnTGlmZWN5Y2xlSGFuZGxlcihcbiAgICAgIHRoaXMuY2xpZW50Q29uZmlnR2VuZXJhdG9yQWRhcHRlcixcbiAgICAgIGFyZ3NbJ2NvbmZpZy1vdXQtZGlyJ10sXG4gICAgICBhcmdzWydjb25maWctZm9ybWF0J11cbiAgICApO1xuICAgIGNvbnN0IGV2ZW50SGFuZGxlcnMgPSB0aGlzLnNhbmRib3hFdmVudEhhbmRsZXJDcmVhdG9yPy4oe1xuICAgICAgc2FuZGJveE5hbWU6IHRoaXMuc2FuZGJveE5hbWUsXG4gICAgICBjbGllbnRDb25maWdMaWZlY3ljbGVIYW5kbGVyLFxuICAgIH0pO1xuICAgIGlmIChldmVudEhhbmRsZXJzKSB7XG4gICAgICBPYmplY3QuZW50cmllcyhldmVudEhhbmRsZXJzKS5mb3JFYWNoKChbZXZlbnQsIGhhbmRsZXJzXSkgPT4ge1xuICAgICAgICBoYW5kbGVycy5mb3JFYWNoKChoYW5kbGVyKSA9PiBzYW5kYm94Lm9uKGV2ZW50LCBoYW5kbGVyKSk7XG4gICAgICB9KTtcbiAgICB9XG4gICAgY29uc3Qgd2F0Y2hFeGNsdXNpb25zID0gYXJncy5leGNsdWRlID8/IFtdO1xuICAgIGNvbnN0IGNsaWVudENvbmZpZ1dyaXRlUGF0aCA9IGF3YWl0IGdldENsaWVudENvbmZpZ1BhdGgoXG4gICAgICBhcmdzWydjb25maWctb3V0LWRpciddLFxuICAgICAgYXJnc1snY29uZmlnLWZvcm1hdCddXG4gICAgKTtcbiAgICB3YXRjaEV4Y2x1c2lvbnMucHVzaChjbGllbnRDb25maWdXcml0ZVBhdGgpO1xuICAgIGF3YWl0IHNhbmRib3guc3RhcnQoe1xuICAgICAgZGlyOiBhcmdzWydkaXItdG8td2F0Y2gnXSxcbiAgICAgIGV4Y2x1ZGU6IHdhdGNoRXhjbHVzaW9ucyxcbiAgICAgIG5hbWU6IGFyZ3MubmFtZSxcbiAgICAgIHByb2ZpbGU6IGFyZ3MucHJvZmlsZSxcbiAgICB9KTtcbiAgICBwcm9jZXNzLm9uY2UoJ1NJR0lOVCcsICgpID0+IHZvaWQgdGhpcy5zaWdJbnRIYW5kbGVyKCkpO1xuICB9O1xuXG4gIC8qKlxuICAgKiBAaW5oZXJpdERvY1xuICAgKi9cbiAgYnVpbGRlciA9ICh5YXJnczogQXJndik6IEFyZ3Y8U2FuZGJveENvbW1hbmRPcHRpb25zPiA9PiB7XG4gICAgcmV0dXJuIChcbiAgICAgIHlhcmdzXG4gICAgICAgIC8vIENhc3QgdG8gZXJhc2Ugb3B0aW9ucyB0eXBlcyB1c2VkIGluIGludGVybmFsIHN1YiBjb21tYW5kIGltcGxlbWVudGF0aW9uLiBPdGhlcndpc2UsIGNvbXBpbGVyIGZhaWxzIGhlcmUuXG4gICAgICAgIC5jb21tYW5kKHRoaXMuc2FuZGJveFN1YkNvbW1hbmRzKVxuICAgICAgICAudmVyc2lvbihmYWxzZSlcbiAgICAgICAgLm9wdGlvbignZGlyLXRvLXdhdGNoJywge1xuICAgICAgICAgIGRlc2NyaWJlOlxuICAgICAgICAgICAgJ0RpcmVjdG9yeSB0byB3YXRjaCBmb3IgZmlsZSBjaGFuZ2VzLiBBbGwgc3ViZGlyZWN0b3JpZXMgYW5kIGZpbGVzIHdpbGwgYmUgaW5jbHVkZWQuIGRlZmF1bHRzIHRvIHRoZSBjdXJyZW50IGRpcmVjdG9yeS4nLFxuICAgICAgICAgIHR5cGU6ICdzdHJpbmcnLFxuICAgICAgICAgIGFycmF5OiBmYWxzZSxcbiAgICAgICAgICBnbG9iYWw6IGZhbHNlLFxuICAgICAgICB9KVxuICAgICAgICAub3B0aW9uKCdleGNsdWRlJywge1xuICAgICAgICAgIGRlc2NyaWJlOlxuICAgICAgICAgICAgJ0FuIGFycmF5IG9mIHBhdGhzIG9yIGdsb2IgcGF0dGVybnMgdG8gaWdub3JlLiBQYXRocyBjYW4gYmUgcmVsYXRpdmUgb3IgYWJzb2x1dGUgYW5kIGNhbiBlaXRoZXIgYmUgZmlsZXMgb3IgZGlyZWN0b3JpZXMnLFxuICAgICAgICAgIHR5cGU6ICdzdHJpbmcnLFxuICAgICAgICAgIGFycmF5OiB0cnVlLFxuICAgICAgICAgIGdsb2JhbDogZmFsc2UsXG4gICAgICAgIH0pXG4gICAgICAgIC5vcHRpb24oJ25hbWUnLCB7XG4gICAgICAgICAgZGVzY3JpYmU6XG4gICAgICAgICAgICAnQW4gb3B0aW9uYWwgbmFtZSB0byBkaXN0aW5ndWlzaCBiZXR3ZWVuIGRpZmZlcmVudCBzYW5kYm94IGVudmlyb25tZW50cy4gRGVmYXVsdCBpcyB0aGUgbmFtZSBpbiB5b3VyIHBhY2thZ2UuanNvbicsXG4gICAgICAgICAgdHlwZTogJ3N0cmluZycsXG4gICAgICAgICAgYXJyYXk6IGZhbHNlLFxuICAgICAgICAgIGdsb2JhbDogZmFsc2UsXG4gICAgICAgIH0pXG4gICAgICAgIC5vcHRpb24oJ2NvbmZpZy1mb3JtYXQnLCB7XG4gICAgICAgICAgZGVzY3JpYmU6ICdDbGllbnQgY29uZmlnIG91dHB1dCBmb3JtYXQnLFxuICAgICAgICAgIHR5cGU6ICdzdHJpbmcnLFxuICAgICAgICAgIGFycmF5OiBmYWxzZSxcbiAgICAgICAgICBjaG9pY2VzOiBPYmplY3QudmFsdWVzKENsaWVudENvbmZpZ0Zvcm1hdCksXG4gICAgICAgICAgZ2xvYmFsOiBmYWxzZSxcbiAgICAgICAgfSlcbiAgICAgICAgLm9wdGlvbignY29uZmlnLW91dC1kaXInLCB7XG4gICAgICAgICAgZGVzY3JpYmU6XG4gICAgICAgICAgICAnQSBwYXRoIHRvIGRpcmVjdG9yeSB3aGVyZSBjb25maWcgaXMgd3JpdHRlbi4gSWYgbm90IHByb3ZpZGVkIGRlZmF1bHRzIHRvIGN1cnJlbnQgcHJvY2VzcyB3b3JraW5nIGRpcmVjdG9yeS4nLFxuICAgICAgICAgIHR5cGU6ICdzdHJpbmcnLFxuICAgICAgICAgIGFycmF5OiBmYWxzZSxcbiAgICAgICAgICBnbG9iYWw6IGZhbHNlLFxuICAgICAgICB9KVxuICAgICAgICAub3B0aW9uKCdwcm9maWxlJywge1xuICAgICAgICAgIGRlc2NyaWJlOiAnQW4gQVdTIHByb2ZpbGUgbmFtZS4nLFxuICAgICAgICAgIHR5cGU6ICdzdHJpbmcnLFxuICAgICAgICAgIGFycmF5OiBmYWxzZSxcbiAgICAgICAgfSlcbiAgICAgICAgLmNoZWNrKGFzeW5jIChhcmd2KSA9PiB7XG4gICAgICAgICAgaWYgKGFyZ3ZbJ2Rpci10by13YXRjaCddKSB7XG4gICAgICAgICAgICBhd2FpdCB0aGlzLnZhbGlkYXRlRGlyZWN0b3J5KCdkaXItdG8td2F0Y2gnLCBhcmd2WydkaXItdG8td2F0Y2gnXSk7XG4gICAgICAgICAgfVxuICAgICAgICAgIGlmIChhcmd2Wydjb25maWctb3V0LWRpciddKSB7XG4gICAgICAgICAgICBhd2FpdCB0aGlzLnZhbGlkYXRlRGlyZWN0b3J5KFxuICAgICAgICAgICAgICAnY29uZmlnLW91dC1kaXInLFxuICAgICAgICAgICAgICBhcmd2Wydjb25maWctb3V0LWRpciddXG4gICAgICAgICAgICApO1xuICAgICAgICAgIH1cbiAgICAgICAgICBpZiAoYXJndi5uYW1lKSB7XG4gICAgICAgICAgICBjb25zdCBwcm9qZWN0TmFtZVJlZ2V4ID0gL15bYS16QS1aMC05LV17MSwxNX0kLztcbiAgICAgICAgICAgIGlmICghYXJndi5uYW1lLm1hdGNoKHByb2plY3ROYW1lUmVnZXgpKSB7XG4gICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICAgICAgICBgLS1uYW1lIHNob3VsZCBtYXRjaCBbYS16QS1aMC05LV0gYW5kIGxlc3MgdGhhbiAxNSBjaGFyYWN0ZXJzLmBcbiAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH0pXG4gICAgICAgIC5taWRkbGV3YXJlKFt0aGlzLmNvbW1hbmRNaWRkbGV3YXJlLmVuc3VyZUF3c0NyZWRlbnRpYWxBbmRSZWdpb25dKVxuICAgICAgICAuZmFpbCgobXNnLCBlcnIpID0+IHtcbiAgICAgICAgICBoYW5kbGVDb21tYW5kRmFpbHVyZShtc2csIGVyciwgeWFyZ3MpO1xuICAgICAgICAgIHlhcmdzLmV4aXQoMSwgZXJyKTtcbiAgICAgICAgfSlcbiAgICApO1xuICB9O1xuXG4gIHNpZ0ludEhhbmRsZXIgPSBhc3luYyAoKSA9PiB7XG4gICAgY29uc3QgYW5zd2VyID0gYXdhaXQgQW1wbGlmeVByb21wdGVyLnllc09yTm8oe1xuICAgICAgbWVzc2FnZTpcbiAgICAgICAgJ1dvdWxkIHlvdSBsaWtlIHRvIGRlbGV0ZSBhbGwgdGhlIHJlc291cmNlcyBpbiB5b3VyIHNhbmRib3ggZW52aXJvbm1lbnQgKFRoaXMgY2Fubm90IGJlIHVuZG9uZSk/JyxcbiAgICAgIGRlZmF1bHRWYWx1ZTogZmFsc2UsXG4gICAgfSk7XG4gICAgaWYgKGFuc3dlcilcbiAgICAgIGF3YWl0IChcbiAgICAgICAgYXdhaXQgdGhpcy5zYW5kYm94RmFjdG9yeS5nZXRJbnN0YW5jZSgpXG4gICAgICApLmRlbGV0ZSh7IG5hbWU6IHRoaXMuc2FuZGJveE5hbWUgfSk7XG4gIH07XG5cbiAgcHJpdmF0ZSB2YWxpZGF0ZURpcmVjdG9yeSA9IGFzeW5jIChvcHRpb246IHN0cmluZywgZGlyOiBzdHJpbmcpID0+IHtcbiAgICBsZXQgc3RhdHM7XG4gICAgdHJ5IHtcbiAgICAgIHN0YXRzID0gYXdhaXQgZnNwLnN0YXQoZGlyLCB7fSk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGAtLSR7b3B0aW9ufSAke2Rpcn0gZG9lcyBub3QgZXhpc3RgKTtcbiAgICB9XG4gICAgaWYgKCFzdGF0cy5pc0RpcmVjdG9yeSgpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYC0tJHtvcHRpb259ICR7ZGlyfSBpcyBub3QgYSB2YWxpZCBkaXJlY3RvcnlgKTtcbiAgICB9XG4gIH07XG59XG4iXX0=