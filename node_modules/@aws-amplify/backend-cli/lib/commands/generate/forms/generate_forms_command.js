import path from 'path';
import { graphqlOutputKey } from '@aws-amplify/backend-output-schemas';
import { DEFAULT_UI_PATH } from '../../../form-generation/default_form_generation_output_paths.js';
import { handleCommandFailure } from '../../../command_failure_handler.js';
/**
 * Command that generates client config.
 */
export class GenerateFormsCommand {
    backendIdentifierResolver;
    backendOutputClientBuilder;
    formGenerationHandler;
    /**
     * @inheritDoc
     */
    command;
    /**
     * @inheritDoc
     */
    describe;
    /**
     * Creates client config generation command.
     */
    constructor(backendIdentifierResolver, backendOutputClientBuilder, formGenerationHandler) {
        this.backendIdentifierResolver = backendIdentifierResolver;
        this.backendOutputClientBuilder = backendOutputClientBuilder;
        this.formGenerationHandler = formGenerationHandler;
        this.command = 'forms';
        this.describe = 'Generates UI forms';
    }
    getBackendIdentifier = async (args) => {
        return await this.backendIdentifierResolver.resolve(args);
    };
    /**
     * @inheritDoc
     */
    handler = async (args) => {
        const backendIdentifier = await this.backendIdentifierResolver.resolve(args);
        if (!backendIdentifier) {
            throw new Error('Could not resolve the backend identifier');
        }
        const backendOutputClient = this.backendOutputClientBuilder();
        const output = await backendOutputClient.getOutput(backendIdentifier);
        if (!(graphqlOutputKey in output) || !output[graphqlOutputKey]) {
            throw new Error('No GraphQL API configured for this backend.');
        }
        const apiUrl = output[graphqlOutputKey].payload.amplifyApiModelSchemaS3Uri;
        if (!args['out-dir']) {
            throw new Error('out-dir must be defined');
        }
        const outDir = args['out-dir'];
        await this.formGenerationHandler.generate({
            modelsOutDir: path.join(outDir, 'graphql'),
            backendIdentifier,
            uiOutDir: outDir,
            apiUrl,
            modelsFilter: args.models,
        });
    };
    /**
     * @inheritDoc
     */
    builder = (yargs) => {
        return yargs
            .option('stack', {
            conflicts: ['app-id', 'branch'],
            describe: 'A stack name that contains an Amplify backend',
            type: 'string',
            array: false,
            group: 'Stack identifier',
        })
            .option('app-id', {
            conflicts: ['stack'],
            describe: 'The Amplify App ID of the project',
            type: 'string',
            array: false,
            implies: 'branch',
            group: 'Project identifier',
        })
            .option('branch', {
            conflicts: ['stack'],
            describe: 'A git branch of the Amplify project',
            type: 'string',
            array: false,
            group: 'Project identifier',
            implies: 'appId',
        })
            .option('out-dir', {
            describe: 'A path to directory where generated forms are written.',
            default: DEFAULT_UI_PATH,
            type: 'string',
            array: false,
            group: 'Form Generation',
        })
            .option('models', {
            describe: 'Model name to generate',
            type: 'string',
            array: true,
            group: 'Form Generation',
        })
            .fail((msg, err) => {
            handleCommandFailure(msg, err, yargs);
            yargs.exit(1, err);
        });
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2VuZXJhdGVfZm9ybXNfY29tbWFuZC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb21tYW5kcy9nZW5lcmF0ZS9mb3Jtcy9nZW5lcmF0ZV9mb3Jtc19jb21tYW5kLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sSUFBSSxNQUFNLE1BQU0sQ0FBQztBQUd4QixPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxxQ0FBcUMsQ0FBQztBQUV2RSxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sa0VBQWtFLENBQUM7QUFHbkcsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0scUNBQXFDLENBQUM7QUFhM0U7O0dBRUc7QUFDSCxNQUFNLE9BQU8sb0JBQW9CO0lBaUJaO0lBQ0E7SUFDQTtJQWhCbkI7O09BRUc7SUFDTSxPQUFPLENBQVM7SUFFekI7O09BRUc7SUFDTSxRQUFRLENBQVM7SUFFMUI7O09BRUc7SUFDSCxZQUNtQix5QkFBb0QsRUFDcEQsMEJBQXFELEVBQ3JELHFCQUE0QztRQUY1Qyw4QkFBeUIsR0FBekIseUJBQXlCLENBQTJCO1FBQ3BELCtCQUEwQixHQUExQiwwQkFBMEIsQ0FBMkI7UUFDckQsMEJBQXFCLEdBQXJCLHFCQUFxQixDQUF1QjtRQUU3RCxJQUFJLENBQUMsT0FBTyxHQUFHLE9BQU8sQ0FBQztRQUN2QixJQUFJLENBQUMsUUFBUSxHQUFHLG9CQUFvQixDQUFDO0lBQ3ZDLENBQUM7SUFFRCxvQkFBb0IsR0FBRyxLQUFLLEVBQUUsSUFBaUMsRUFBRSxFQUFFO1FBQ2pFLE9BQU8sTUFBTSxJQUFJLENBQUMseUJBQXlCLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQzVELENBQUMsQ0FBQztJQUVGOztPQUVHO0lBQ0gsT0FBTyxHQUFHLEtBQUssRUFBRSxJQUFpQyxFQUFpQixFQUFFO1FBQ25FLE1BQU0saUJBQWlCLEdBQUcsTUFBTSxJQUFJLENBQUMseUJBQXlCLENBQUMsT0FB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bXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB7IEFyZ3YsIENvbW1hbmRNb2R1bGUgfSBmcm9tICd5YXJncyc7XG5pbXBvcnQgeyBCYWNrZW5kT3V0cHV0Q2xpZW50IH0gZnJvbSAnQGF3cy1hbXBsaWZ5L2RlcGxveWVkLWJhY2tlbmQtY2xpZW50JztcbmltcG9ydCB7IGdyYXBocWxPdXRwdXRLZXkgfSBmcm9tICdAYXdzLWFtcGxpZnkvYmFja2VuZC1vdXRwdXQtc2NoZW1hcyc7XG5pbXBvcnQgeyBCYWNrZW5kSWRlbnRpZmllclJlc29sdmVyIH0gZnJvbSAnLi4vLi4vLi4vYmFja2VuZC1pZGVudGlmaWVyL2JhY2tlbmRfaWRlbnRpZmllcl9yZXNvbHZlci5qcyc7XG5pbXBvcnQgeyBERUZBVUxUX1VJX1BBVEggfSBmcm9tICcuLi8uLi8uLi9mb3JtLWdlbmVyYXRpb24vZGVmYXVsdF9mb3JtX2dlbmVyYXRpb25fb3V0cHV0X3BhdGhzLmpzJztcbmltcG9ydCB7IEZvcm1HZW5lcmF0aW9uSGFuZGxlciB9IGZyb20gJy4uLy4uLy4uL2Zvcm0tZ2VuZXJhdGlvbi9mb3JtX2dlbmVyYXRpb25faGFuZGxlci5qcyc7XG5pbXBvcnQgeyBBcmd1bWVudHNLZWJhYkNhc2UgfSBmcm9tICcuLi8uLi8uLi9rZWJhYl9jYXNlLmpzJztcbmltcG9ydCB7IGhhbmRsZUNvbW1hbmRGYWlsdXJlIH0gZnJvbSAnLi4vLi4vLi4vY29tbWFuZF9mYWlsdXJlX2hhbmRsZXIuanMnO1xuXG5leHBvcnQgdHlwZSBHZW5lcmF0ZUZvcm1zQ29tbWFuZE9wdGlvbnMgPVxuICBBcmd1bWVudHNLZWJhYkNhc2U8R2VuZXJhdGVGb3Jtc0NvbW1hbmRPcHRpb25zQ2FtZWxDYXNlPjtcblxudHlwZSBHZW5lcmF0ZUZvcm1zQ29tbWFuZE9wdGlvbnNDYW1lbENhc2UgPSB7XG4gIHN0YWNrOiBzdHJpbmcgfCB1bmRlZmluZWQ7XG4gIGFwcElkOiBzdHJpbmcgfCB1bmRlZmluZWQ7XG4gIGJyYW5jaDogc3RyaW5nIHwgdW5kZWZpbmVkO1xuICBvdXREaXI6IHN0cmluZyB8IHVuZGVmaW5lZDtcbiAgbW9kZWxzOiBzdHJpbmdbXSB8IHVuZGVmaW5lZDtcbn07XG5cbi8qKlxuICogQ29tbWFuZCB0aGF0IGdlbmVyYXRlcyBjbGllbnQgY29uZmlnLlxuICovXG5leHBvcnQgY2xhc3MgR2VuZXJhdGVGb3Jtc0NvbW1hbmRcbiAgaW1wbGVtZW50cyBDb21tYW5kTW9kdWxlPG9iamVjdCwgR2VuZXJhdGVGb3Jtc0NvbW1hbmRPcHRpb25zPlxue1xuICAvKipcbiAgICogQGluaGVyaXREb2NcbiAgICovXG4gIHJlYWRvbmx5IGNvbW1hbmQ6IHN0cmluZztcblxuICAvKipcbiAgICogQGluaGVyaXREb2NcbiAgICovXG4gIHJlYWRvbmx5IGRlc2NyaWJlOiBzdHJpbmc7XG5cbiAgLyoqXG4gICAqIENyZWF0ZXMgY2xpZW50IGNvbmZpZyBnZW5lcmF0aW9uIGNvbW1hbmQuXG4gICAqL1xuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIHJlYWRvbmx5IGJhY2tlbmRJZGVudGlmaWVyUmVzb2x2ZXI6IEJhY2tlbmRJZGVudGlmaWVyUmVzb2x2ZXIsXG4gICAgcHJpdmF0ZSByZWFkb25seSBiYWNrZW5kT3V0cHV0Q2xpZW50QnVpbGRlcjogKCkgPT4gQmFja2VuZE91dHB1dENsaWVudCxcbiAgICBwcml2YXRlIHJlYWRvbmx5IGZvcm1HZW5lcmF0aW9uSGFuZGxlcjogRm9ybUdlbmVyYXRpb25IYW5kbGVyXG4gICkge1xuICAgIHRoaXMuY29tbWFuZCA9ICdmb3Jtcyc7XG4gICAgdGhpcy5kZXNjcmliZSA9ICdHZW5lcmF0ZXMgVUkgZm9ybXMnO1xuICB9XG5cbiAgZ2V0QmFja2VuZElkZW50aWZpZXIgPSBhc3luYyAoYXJnczogR2VuZXJhdGVGb3Jtc0NvbW1hbmRPcHRpb25zKSA9PiB7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMuYmFja2VuZElkZW50aWZpZXJSZXNvbHZlci5yZXNvbHZlKGFyZ3MpO1xuICB9O1xuXG4gIC8qKlxuICAgKiBAaW5oZXJpdERvY1xuICAgKi9cbiAgaGFuZGxlciA9IGFzeW5jIChhcmdzOiBHZW5lcmF0ZUZvcm1zQ29tbWFuZE9wdGlvbnMpOiBQcm9taXNlPHZvaWQ+ID0+IHtcbiAgICBjb25zdCBiYWNrZW5kSWRlbnRpZmllciA9IGF3YWl0IHRoaXMuYmFja2VuZElkZW50aWZpZXJSZXNvbHZlci5yZXNvbHZlKFxuICAgICAgYXJnc1xuICAgICk7XG5cbiAgICBpZiAoIWJhY2tlbmRJZGVudGlmaWVyKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0NvdWxkIG5vdCByZXNvbHZlIHRoZSBiYWNrZW5kIGlkZW50aWZpZXInKTtcbiAgICB9XG5cbiAgICBjb25zdCBiYWNrZW5kT3V0cHV0Q2xpZW50ID0gdGhpcy5iYWNrZW5kT3V0cHV0Q2xpZW50QnVpbGRlcigpO1xuXG4gICAgY29uc3Qgb3V0cHV0ID0gYXdhaXQgYmFja2VuZE91dHB1dENsaWVudC5nZXRPdXRwdXQoYmFja2VuZElkZW50aWZpZXIpO1xuXG4gICAgaWYgKCEoZ3JhcGhxbE91dHB1dEtleSBpbiBvdXRwdXQpIHx8ICFvdXRwdXRbZ3JhcGhxbE91dHB1dEtleV0pIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignTm8gR3JhcGhRTCBBUEkgY29uZmlndXJlZCBmb3IgdGhpcyBiYWNrZW5kLicpO1xuICAgIH1cblxuICAgIGNvbnN0IGFwaVVybCA9IG91dHB1dFtncmFwaHFsT3V0cHV0S2V5XS5wYXlsb2FkLmFtcGxpZnlBcGlNb2RlbFNjaGVtYVMzVXJpO1xuXG4gICAgaWYgKCFhcmdzWydvdXQtZGlyJ10pIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignb3V0LWRpciBtdXN0IGJlIGRlZmluZWQnKTtcbiAgICB9XG5cbiAgICBjb25zdCBvdXREaXIgPSBhcmdzWydvdXQtZGlyJ107XG5cbiAgICBhd2FpdCB0aGlzLmZvcm1HZW5lcmF0aW9uSGFuZGxlci5nZW5lcmF0ZSh7XG4gICAgICBtb2RlbHNPdXREaXI6IHBhdGguam9pbihvdXREaXIsICdncmFwaHFsJyksXG4gICAgICBiYWNrZW5kSWRlbnRpZmllcixcbiAgICAgIHVpT3V0RGlyOiBvdXREaXIsXG4gICAgICBhcGlVcmwsXG4gICAgICBtb2RlbHNGaWx0ZXI6IGFyZ3MubW9kZWxzLFxuICAgIH0pO1xuICB9O1xuXG4gIC8qKlxuICAgKiBAaW5oZXJpdERvY1xuICAgKi9cbiAgYnVpbGRlciA9ICh5YXJnczogQXJndik6IEFyZ3Y8R2VuZXJhdGVGb3Jtc0NvbW1hbmRPcHRpb25zPiA9PiB7XG4gICAgcmV0dXJuIHlhcmdzXG4gICAgICAub3B0aW9uKCdzdGFjaycsIHtcbiAgICAgICAgY29uZmxpY3RzOiBbJ2FwcC1pZCcsICdicmFuY2gnXSxcbiAgICAgICAgZGVzY3JpYmU6ICdBIHN0YWNrIG5hbWUgdGhhdCBjb250YWlucyBhbiBBbXBsaWZ5IGJhY2tlbmQnLFxuICAgICAgICB0eXBlOiAnc3RyaW5nJyxcbiAgICAgICAgYXJyYXk6IGZhbHNlLFxuICAgICAgICBncm91cDogJ1N0YWNrIGlkZW50aWZpZXInLFxuICAgICAgfSlcbiAgICAgIC5vcHRpb24oJ2FwcC1pZCcsIHtcbiAgICAgICAgY29uZmxpY3RzOiBbJ3N0YWNrJ10sXG4gICAgICAgIGRlc2NyaWJlOiAnVGhlIEFtcGxpZnkgQXBwIElEIG9mIHRoZSBwcm9qZWN0JyxcbiAgICAgICAgdHlwZTogJ3N0cmluZycsXG4gICAgICAgIGFycmF5OiBmYWxzZSxcbiAgICAgICAgaW1wbGllczogJ2JyYW5jaCcsXG4gICAgICAgIGdyb3VwOiAnUHJvamVjdCBpZGVudGlmaWVyJyxcbiAgICAgIH0pXG4gICAgICAub3B0aW9uKCdicmFuY2gnLCB7XG4gICAgICAgIGNvbmZsaWN0czogWydzdGFjayddLFxuICAgICAgICBkZXNjcmliZTogJ0EgZ2l0IGJyYW5jaCBvZiB0aGUgQW1wbGlmeSBwcm9qZWN0JyxcbiAgICAgICAgdHlwZTogJ3N0cmluZycsXG4gICAgICAgIGFycmF5OiBmYWxzZSxcbiAgICAgICAgZ3JvdXA6ICdQcm9qZWN0IGlkZW50aWZpZXInLFxuICAgICAgICBpbXBsaWVzOiAnYXBwSWQnLFxuICAgICAgfSlcbiAgICAgIC5vcHRpb24oJ291dC1kaXInLCB7XG4gICAgICAgIGRlc2NyaWJlOiAnQSBwYXRoIHRvIGRpcmVjdG9yeSB3aGVyZSBnZW5lcmF0ZWQgZm9ybXMgYXJlIHdyaXR0ZW4uJyxcbiAgICAgICAgZGVmYXVsdDogREVGQVVMVF9VSV9QQVRILFxuICAgICAgICB0eXBlOiAnc3RyaW5nJyxcbiAgICAgICAgYXJyYXk6IGZhbHNlLFxuICAgICAgICBncm91cDogJ0Zvcm0gR2VuZXJhdGlvbicsXG4gICAgICB9KVxuICAgICAgLm9wdGlvbignbW9kZWxzJywge1xuICAgICAgICBkZXNjcmliZTogJ01vZGVsIG5hbWUgdG8gZ2VuZXJhdGUnLFxuICAgICAgICB0eXBlOiAnc3RyaW5nJyxcbiAgICAgICAgYXJyYXk6IHRydWUsXG4gICAgICAgIGdyb3VwOiAnRm9ybSBHZW5lcmF0aW9uJyxcbiAgICAgIH0pXG4gICAgICAuZmFpbCgobXNnLCBlcnIpID0+IHtcbiAgICAgICAgaGFuZGxlQ29tbWFuZEZhaWx1cmUobXNnLCBlcnIsIHlhcmdzKTtcbiAgICAgICAgeWFyZ3MuZXhpdCgxLCBlcnIpO1xuICAgICAgfSk7XG4gIH07XG59XG4iXX0=