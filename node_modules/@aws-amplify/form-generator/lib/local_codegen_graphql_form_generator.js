import { AmplifyFormRenderer, ModuleKind, ReactIndexStudioTemplateRenderer, ReactUtilsStudioTemplateRenderer, ScriptKind, ScriptTarget, getDeclarationFilename, } from '@aws-amplify/codegen-ui-react';
/**
 * Generates GraphQL-compatible forms in React by directly leveraging @aws-amplify/codegen-ui-react
 */
export class LocalGraphqlFormGenerator {
    schemaFetcher;
    renderOptions;
    resultBuilder;
    /**
     * Instantiates a LocalGraphqlFormGenerator for a provided schema
     */
    constructor(schemaFetcher, renderOptions, resultBuilder) {
        this.schemaFetcher = schemaFetcher;
        this.renderOptions = renderOptions;
        this.resultBuilder = resultBuilder;
    }
    /**
     * reduces the dataSchema to a map of models
     */
    getModelMapForDataSchema = (dataSchema) => {
        return Object.entries(dataSchema.models).reduce((prev, [name, model]) => {
            if (!model.isJoinTable) {
                prev[name] = new Set(['create', 'update']);
            }
            return prev;
        }, {});
    };
    getSchema = (name, type) => ({
        name: `${name}${type === 'create' ? 'CreateForm' : 'UpdateForm'}`,
        formActionType: type,
        dataType: { dataSourceType: 'DataStore', dataTypeName: name },
        fields: {},
        sectionalElements: {},
        style: {},
        cta: {},
    });
    generateBaseForms = (modelMap) => {
        const schemas = [];
        Object.entries(modelMap).forEach(([name, set]) => {
            set.forEach((type) => schemas.push(this.getSchema(name, type)));
        });
        return schemas;
    };
    renderGraphqlPath = (submodule) => {
        const graphqlPath = `${this.renderOptions.graphqlDir}/${submodule}`;
        // if the path does not start with a leading ./ or ../, assume that the graphql folder is in the same directory relative to the ui, and prepend a `./`
        if (graphqlPath.startsWith('.')) {
            return graphqlPath;
        }
        return `./${graphqlPath}`;
    };
    /**
     * Gets the react render config
     */
    get config() {
        return {
            module: ModuleKind.ES2020,
            target: ScriptTarget.ES2020,
            script: ScriptKind.JSX,
            includeUseClientDirective: true,
            renderTypeDeclarations: true,
            apiConfiguration: {
                dataApi: 'GraphQL',
                fragmentsFilePath: this.renderGraphqlPath('fragments'),
                mutationsFilePath: this.renderGraphqlPath('mutations'),
                queriesFilePath: this.renderGraphqlPath('queries'),
                subscriptionsFilePath: this.renderGraphqlPath('subscriptions'),
                typesFilePath: this.renderGraphqlPath('types'),
            },
            dependencies: {
                // Tell the renderer to generate amplify js v6 compatible code
                'aws-amplify': '^6.0.0',
            },
        };
    }
    createUiBuilderForm = (schema, dataSchema, formFeatureFlags) => {
        const renderer = new AmplifyFormRenderer(schema, dataSchema, this.config, formFeatureFlags);
        const { componentText, declaration } = renderer.renderComponentInternal();
        const files = [
            {
                componentText,
                fileName: renderer.fileName,
            },
        ];
        if (declaration) {
            files.push({
                componentText: declaration,
                fileName: getDeclarationFilename(renderer.fileName),
            });
        }
        return files;
    };
    filterModelsByName = (filteredModelNames, schemaModel) => {
        const lowerCaseModelKeys = new Set(Object.keys(schemaModel).map((k) => k.toLowerCase()));
        const modelEntries = Object.entries(schemaModel);
        return filteredModelNames.reduce((prev, model) => {
            if (lowerCaseModelKeys?.has(model.toLowerCase())) {
                const entry = modelEntries.find(([key]) => key.toLowerCase() === model.toLowerCase());
                if (!entry) {
                    throw new Error(`Could not find specified model ${model}`);
                }
                prev.push(entry);
                return prev;
            }
            throw new Error(`Could not find specified model ${model}`);
        }, []);
    };
    codegenForm = (dataSchema, formSchema) => {
        return this.createUiBuilderForm(formSchema, dataSchema, {});
    };
    getFilteredModels = (dataSchema, filteredModelNames) => {
        const modelMap = this.getModelMapForDataSchema(dataSchema);
        const filteredModels = [];
        if (!filteredModelNames || !filteredModelNames?.length) {
            filteredModels.push(...Object.entries(modelMap));
        }
        else {
            filteredModels.push(...this.filterModelsByName(filteredModelNames, modelMap));
        }
        return filteredModels;
    };
    transformModelListToMap = (models) => {
        return models.reduce((prev, [key, value]) => ({ ...prev, [key]: value }), {});
    };
    static defaultConfig = {
        module: ModuleKind.ES2020,
        target: ScriptTarget.ES2020,
        script: ScriptKind.JSX,
        renderTypeDeclarations: true,
    };
    createUtilFile = (utils) => {
        const renderer = new ReactUtilsStudioTemplateRenderer(utils, LocalGraphqlFormGenerator.defaultConfig);
        const { componentText } = renderer.renderComponentInternal();
        return {
            componentText,
            fileName: renderer.fileName,
        };
    };
    /**
     * Return utils file text
     */
    generateUtilFile = () => {
        const utils = [
            'validation',
            'formatter',
            'fetchByPath',
            'processFile',
        ];
        const { componentText, fileName } = this.createUtilFile(utils);
        return {
            schemaName: 'AmplifyStudioUtilFile',
            componentText,
            fileName,
            declaration: undefined,
            error: undefined,
        };
    };
    createIndexFile = (schemas) => {
        const renderer = new ReactIndexStudioTemplateRenderer(schemas, LocalGraphqlFormGenerator.defaultConfig);
        const { componentText } = renderer.renderComponentInternal();
        return {
            componentText,
            fileName: renderer.fileName,
        };
    };
    generateIndexFile = (schemas) => {
        const { componentText, fileName } = this.createIndexFile(schemas);
        return {
            schemaName: 'AmplifyStudioIndexFile',
            componentText,
            fileName,
            declaration: undefined,
            error: undefined,
        };
    };
    generateForms = async (options) => {
        const dataSchema = await this.schemaFetcher();
        const filteredModels = this.getFilteredModels(dataSchema, options?.models);
        const filteredSchema = this.transformModelListToMap(filteredModels);
        const utilFile = this.generateUtilFile();
        const baseForms = this.generateBaseForms(filteredSchema);
        const indexFile = this.generateIndexFile(baseForms.map(({ name }) => ({
            name,
        })));
        dataSchema.models = Object.entries(dataSchema.models).reduce((prev, [key, value]) => {
            // Discard createdAt and updatedAt fields
            /* eslint-disable-next-line @typescript-eslint/no-unused-vars */
            const { createdAt, updatedAt, ...fields } = value.fields;
            const valueExcludingTimestampFields = {
                ...value,
                fields,
            };
            prev[key] = valueExcludingTimestampFields;
            return prev;
        }, {});
        const forms = baseForms.reduce((prev, formSchema) => {
            const results = this.codegenForm(dataSchema, formSchema);
            results.forEach((result) => {
                prev[result.fileName] = result.componentText;
            });
            return prev;
        }, {});
        forms[utilFile.fileName] = utilFile.componentText;
        forms[indexFile.fileName] = indexFile.componentText;
        return this.resultBuilder(forms);
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibG9jYWxfY29kZWdlbl9ncmFwaHFsX2Zvcm1fZ2VuZXJhdG9yLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL2xvY2FsX2NvZGVnZW5fZ3JhcGhxbF9mb3JtX2dlbmVyYXRvci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFNQSxPQUFPLEVBQ0wsbUJBQW1CLEVBQ25CLFVBQVUsRUFDVixnQ0FBZ0MsRUFFaEMsZ0NBQWdDLEVBQ2hDLFVBQVUsRUFDVixZQUFZLEVBRVosc0JBQXNCLEdBQ3ZCLE1BQU0sK0JBQStCLENBQUM7QUFzQnZDOztHQUVHO0FBQ0gsTUFBTSxPQUFPLHlCQUF5QjtJQUsxQjtJQUNBO0lBQ0E7SUFOVjs7T0FFRztJQUNILFlBQ1UsYUFBNEIsRUFDNUIsYUFBNEIsRUFDNUIsYUFBNEI7UUFGNUIsa0JBQWEsR0FBYixhQUFhLENBQWU7UUFDNUIsa0JBQWEsR0FBYixhQUFhLENBQWU7UUFDNUIsa0JBQWEsR0FBYixhQUFhLENBQWU7SUFDbkMsQ0FBQztJQUNKOztPQUVHO0lBQ0ssd0JBQXdCLEdBQUcsQ0FBQyxVQUE2QixFQUFFLEVBQUU7UUFDbkUsT0FBTyxNQUFNLENBQUMsT0FBTyxDQUFDLFVBQVUsQ0FBQyxNQUFNLENBQUMsQ0FBQyxNQUFNLENBQzdDLENBQUMsSUFBSSxFQUFFLENBQUMsSUFBSSxFQUFFLEtBQUssQ0FBQyxFQUFFLEVBQUU7WUFDdEIsSUFBSSxDQUFDLEtBQUssQ0FBQyxXQUFXLEVBQUU7Z0JBQ3RCLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxJQUFJLEdBQUcsQ0FBQyxDQUFDLFFBQVEsRUFBRSxRQUFRLENBQUMsQ0FBQyxDQUFDO2FBQzVDO1lBQ0QsT0FBTyxJQUFJLENBQUM7UUFDZCxDQUFDLEVBQ0QsRUFBRSxDQUNILENBQUM7SUFDSixDQUFDLENBQUM7SUFFTSxTQUFTLEdBQUcsQ0FDbEIsSUFBWSxFQUNaLElBQXlCLEVBQ2IsRUFBRSxDQUFDLENBQUM7UUFDaEIsSUFBSSxFQUFFLEdBQUcsSUFBSSxHQUFHLElBQUksS0FBSyxRQUFRLENBQUMsQ0FBQyxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUMsWUFBWSxFQUFFO1FBQ2pFLGNBQWMsRUFBRSxJQUFJO1FBQ3BCLFFBQVEsRUFBRSxFQUFFLGNBQWMsRUFBRSxXQUFXLEVBQUUsWUFBWSxFQUFFLElBQUksRUFBRTtRQUM3RCxNQUFNLEVBQUUsRUFBRTtRQUNWLGlCQUFpQixFQUFFLEVBQUU7UUFDckIsS0FBSyxFQUFFLEVBQUU7UUFDVCxHQUFHLEVBQUUsRUFBRTtLQUNSLENBQUMsQ0FBQztJQUVLLGlCQUFpQixHQUFHLENBQUMsUUFFNUIsRUFBZ0IsRUFBRTtRQUNqQixNQUFNLE9BQU8sR0FBaUIsRUFBRSxDQUFDO1FBQ2pDLE1BQU0sQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxJQUFJLEVBQUUsR0FBRyxDQUFDLEVBQUUsRUFBRTtZQUMvQyxHQUFHLENBQUMsT0FBTyxDQUFDLENBQUMsSUFBSSxFQUFFLEVBQUUsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNsRSxDQUFDLENBQUMsQ0FBQztRQUNILE9BQU8sT0FBTyxDQUFDO0lBQ2pCLENBQUMsQ0FBQztJQUVNLGlCQUFpQixHQUFHLENBQzFCLFNBQTRFLEVBQzVFLEVBQUU7UUFDRixNQUFNLFdBQVcsR0FBRyxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUMsVUFBVSxJQUFJLFNBQVMsRUFBRSxDQUFDO1FBQ3BFLHNKQUFzSjtRQUN0SixJQUFJLFdBQVcsQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDLEVBQUU7WUFDL0IsT0FBTyxXQUFXLENBQUM7U0FDcEI7UUFDRCxPQUFPLEtBQUssV0FBVyxFQUFFLENBQUM7SUFDNUIsQ0FBQyxDQUFDO0lBRUY7O09BRUc7SUFDSCxJQUFZLE1BQU07UUFDaEIsT0FBTztZQUNMLE1BQU0sRUFBRSxVQUFVLENBQUMsTUFBTTtZQUN6QixNQUFNLEVBQUUsWUFBWSxDQUFDLE1BQU07WUFDM0IsTUFBTSxFQUFFLFVBQVUsQ0FBQyxHQUFHO1lBQ3RCLHlCQUF5QixFQUFFLElBQUk7WUFDL0Isc0JBQXNCLEVBQUUsSUFBSTtZQUM1QixnQkFBZ0IsRUFBRTtnQkFDaEIsT0FBTyxFQUFFLFNBQVM7Z0JBQ2xCLGlCQUFpQixFQUFFLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxXQUFXLENBQUM7Z0JBQ3RELGlCQUFpQixFQUFFLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxXQUFXLENBQUM7Z0JBQ3RELGVBQWUsRUFBRSxJQUFJLENBQUMsaUJBQWlCLENBQUMsU0FBUyxDQUFDO2dCQUNsRCxxQkFBcUIsRUFBRSxJQUFJLENBQUMsaUJBQWlCLENBQUMsZUFBZSxDQUFDO2dCQUM5RCxhQUFhLEVBQUUsSUFBSSxDQUFDLGlCQUFpQixDQUFDLE9BQU8sQ0FBQzthQUMvQztZQUNELFlBQVksRUFBRTtnQkFDWiw4REFBOEQ7Z0JBQzlELGFBQWEsRUFBRSxRQUFRO2FBQ3hCO1NBQ0YsQ0FBQztJQUNKLENBQUM7SUFDTyxtQkFBbUIsR0FBRyxDQUM1QixNQUFrQixFQUNsQixVQUE4QixFQUM5QixnQkFBbUMsRUFDbkMsRUFBRTtRQUNGLE1BQU0sUUFBUSxHQUFHLElBQUksbUJBQW1CLENBQ3RDLE1BQU0sRUFDTixVQUFVLEVBQ1YsSUFBSSxDQUFDLE1BQU0sRUFDWCxnQkFBZ0IsQ0FDakIsQ0FBQztRQUNGLE1BQU0sRUFBRSxhQUFhLEVBQUUsV0FBVyxFQUFFLEdBQUcsUUFBUSxDQUFDLHVCQUF1QixFQUFFLENBQUM7UUFDMUUsTUFBTSxLQUFLLEdBQUc7WUFDWjtnQkFDRSxhQUFhO2dCQUNiLFFBQVEsRUFBRSxRQUFRLENBQUMsUUFBUTthQUM1QjtTQUNGLENBQUM7UUFDRixJQUFJLFdBQVcsRUFBRTtZQUNmLEtBQUssQ0FBQyxJQUFJLENBQUM7Z0JBQ1QsYUFBYSxFQUFFLFdBQVc7Z0JBQzFCLFFBQVEsRUFBRSxzQkFBc0IsQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDO2FBQ3BELENBQUMsQ0FBQztTQUNKO1FBRUQsT0FBTyxLQUFLLENBQUM7SUFDZixDQUFDLENBQUM7SUFDTSxrQkFBa0IsR0FBRyxDQUMzQixrQkFBNEIsRUFDNUIsV0FBd0IsRUFDeEIsRUFBRTtRQUNGLE1BQU0sa0JBQWtCLEdBQUcsSUFBSSxHQUFHLENBQ2hDLE1BQU0sQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsV0FBVyxFQUFFLENBQUMsQ0FDckQsQ0FBQztRQUNGLE1BQU0sWUFBWSxHQUFHLE1BQU0sQ0FBQyxPQUFPLENBQUMsV0FBVyxDQUFDLENBQUM7UUFDakQsT0FBTyxrQkFBa0IsQ0FBQyxNQUFNLENBQzlCLENBQUMsSUFBSSxFQUFFLEtBQUssRUFBRSxFQUFFO1lBQ2QsSUFBSSxrQkFBa0IsRUFBRSxHQUFHLENBQUMsS0FBSyxDQUFDLFdBQVcsRUFBRSxDQUFDLEVBQUU7Z0JBQ2hELE1BQU0sS0FBSyxHQUFHLFlBQVksQ0FBQyxJQUFJLENBQzdCLENBQUMsQ0FBQyxHQUFHLENBQUMsRUFBRSxFQUFFLENBQUMsR0FBRyxDQUFDLFdBQVcsRUFBRSxLQUFLLEtBQUssQ0FBQyxXQUFXLEVBQUUsQ0FDckQsQ0FBQztnQkFDRixJQUFJLENBQUMsS0FBSyxFQUFFO29CQUNWLE1BQU0sSUFBSSxLQUFLLENBQUMsa0NBQWtDLEtBQUssRUFBRSxDQUFDLENBQUM7aUJBQzVEO2dCQUNELElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7Z0JBQ2pCLE9BQU8sSUFBSSxDQUFDO2FBQ2I7WUFDRCxNQUFNLElBQUksS0FBSyxDQUFDLGtDQUFrQyxLQUFLLEVBQUUsQ0FBQyxDQUFDO1FBQzdELENBQUMsRUFDRCxFQUFFLENBQ0gsQ0FBQztJQUNKLENBQUMsQ0FBQztJQUNNLFdBQVcsR0FBRyxDQUNwQixVQUE2QixFQUM3QixVQUFzQixFQUN0QixFQUFFO1FBQ0YsT0FBTyxJQUFJLENBQUMsbUJBQW1CLENBQUMsVUFBVSxFQUFFLFVBQVUsRUFBRSxFQUFFLENBQUMsQ0FBQztJQUM5RCxDQUFDLENBQUM7SUFFTSxpQkFBaUIsR0FBRyxDQUMxQixVQUE2QixFQUM3QixrQkFBNkIsRUFDN0IsRUFBRTtRQUNGLE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyx3QkFBd0IsQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUMzRCxNQUFNLGNBQWMsR0FBNkIsRUFBRSxDQUFDO1FBQ3BELElBQUksQ0FBQyxrQkFBa0IsSUFBSSxDQUFDLGtCQUFrQixFQUFFLE1BQU0sRUFBRTtZQUN0RCxjQUFjLENBQUMsSUFBSSxDQUFDLEdBQUcsTUFBTSxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDO1NBQ2xEO2FBQU07WUFDTCxjQUFjLENBQUMsSUFBSSxDQUNqQixHQUFHLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxrQkFBa0IsRUFBRSxRQUFRLENBQUMsQ0FDekQsQ0FBQztTQUNIO1FBQ0QsT0FBTyxjQUFjLENBQUM7SUFDeEIsQ0FBQyxDQUFDO0lBQ00sdUJBQXVCLEdBQUcsQ0FBQyxNQUFnQyxFQUFFLEVBQUU7UUFDckUsT0FBTyxNQUFNLENBQUMsTUFBTSxDQUNsQixDQUFDLElBQUksRUFBRSxDQUFDLEdBQUcsRUFBRSxLQUFLLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxFQUFFLEdBQUcsSUFBSSxFQUFFLENBQUMsR0FBRyxDQUFDLEVBQUUsS0FBSyxFQUFFLENBQUMsRUFDbkQsRUFBRSxDQUNILENBQUM7SUFDSixDQUFDLENBQUM7SUFDTSxNQUFNLENBQUMsYUFBYSxHQUFHO1FBQzdCLE1BQU0sRUFBRSxVQUFVLENBQUMsTUFBTTtRQUN6QixNQUFNLEVBQUUsWUFBWSxDQUFDLE1BQU07UUFDM0IsTUFBTSxFQUFFLFVBQVUsQ0FBQyxHQUFHO1FBQ3RCLHNCQUFzQixFQUFFLElBQUk7S0FDN0IsQ0FBQztJQUNNLGNBQWMsR0FBRyxDQUFDLEtBQXlCLEVBQUUsRUFBRTtRQUNyRCxNQUFNLFFBQVEsR0FBRyxJQUFJLGdDQUFnQyxDQUNuRCxLQUFLLEVBQ0wseUJBQXlCLENBQUMsYUFBYSxDQUN4QyxDQUFDO1FBQ0YsTUFBTSxFQUFFLGFBQWEsRUFBRSxHQUFHLFFBQVEsQ0FBQyx1QkFBdUIsRUFBRSxDQUFDO1FBQzdELE9BQU87WUFDTCxhQUFhO1lBQ2IsUUFBUSxFQUFFLFFBQVEsQ0FBQyxRQUFRO1NBQzVCLENBQUM7SUFDSixDQUFDLENBQUM7SUFFRjs7T0FFRztJQUNLLGdCQUFnQixHQUFHLEdBQUcsRUFBRTtRQUM5QixNQUFNLEtBQUssR0FBdUI7WUFDaEMsWUFBWTtZQUNaLFdBQVc7WUFDWCxhQUFhO1lBQ2IsYUFBYTtTQUNkLENBQUM7UUFDRixNQUFNLEVBQUUsYUFBYSxFQUFFLFFBQVEsRUFBRSxHQUFHLElBQUksQ0FBQyxjQUFjLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDL0QsT0FBTztZQUNMLFVBQVUsRUFBRSx1QkFBdUI7WUFDbkMsYUFBYTtZQUNiLFFBQVE7WUFDUixXQUFXLEVBQUUsU0FBUztZQUN0QixLQUFLLEVBQUUsU0FBUztTQUNqQixDQUFDO0lBQ0osQ0FBQyxDQUFDO0lBRU0sZUFBZSxHQUFHLENBQUMsT0FBdUIsRUFBRSxFQUFFO1FBQ3BELE1BQU0sUUFBUSxHQUFHLElBQUksZ0NBQWdDLENBQ25ELE9BQU8sRUFDUCx5QkFBeUIsQ0FBQyxhQUFhLENBQ3hDLENBQUM7UUFDRixNQUFNLEVBQUUsYUFBYSxFQUFFLEdBQUcsUUFBUSxDQUFDLHVCQUF1QixFQUFFLENBQUM7UUFDN0QsT0FBTztZQUNMLGFBQWE7WUFDYixRQUFRLEVBQUUsUUFBUSxDQUFDLFFBQVE7U0FDNUIsQ0FBQztJQUNKLENBQUMsQ0FBQztJQUVGLGlCQUFpQixHQUFHLENBQUMsT0FBMkIsRUFBRSxFQUFFO1FBQ2xELE1BQU0sRUFBRSxhQUFhLEVBQUUsUUFBUSxFQUFFLEdBQUcsSUFBSSxDQUFDLGVBQWUsQ0FDdEQsT0FBeUIsQ0FDMUIsQ0FBQztRQUNGLE9BQU87WUFDTCxVQUFVLEVBQUUsd0JBQXdCO1lBQ3BDLGFBQWE7WUFDYixRQUFRO1lBQ1IsV0FBVyxFQUFFLFNBQVM7WUFDdEIsS0FBSyxFQUFFLFNBQVM7U0FDakIsQ0FBQztJQUNKLENBQUMsQ0FBQztJQUVGLGFBQWEsR0FBRyxLQUFLLEVBQ25CLE9BQStCLEVBQ0csRUFBRTtRQUNwQyxNQUFNLFVBQVUsR0FBRyxNQUFNLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztRQUM5QyxNQUFNLGNBQWMsR0FBRyxJQUFJLENBQUMsaUJBQWlCLENBQUMsVUFBVSxFQUFFLE9BQU8sRUFBRSxNQUFNLENBQUMsQ0FBQztRQUMzRSxNQUFNLGNBQWMsR0FBRyxJQUFJLENBQUMsdUJBQXVCLENBQUMsY0FBYyxDQUFDLENBQUM7UUFDcEUsTUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDLGdCQUFnQixFQUFFLENBQUM7UUFDekMsTUFBTSxTQUFTLEdBQUcsSUFBSSxDQUFDLGlCQUFpQixDQUFDLGNBQWMsQ0FBQyxDQUFDO1FBQ3pELE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxpQkFBaUIsQ0FDdEMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUUsSUFBSSxFQUFFLEVBQUUsRUFBRSxDQUFDLENBQUM7WUFDM0IsSUFBSTtTQUNMLENBQUMsQ0FBQyxDQUNKLENBQUM7UUFFRixVQUFVLENBQUMsTUFBTSxHQUFHLE1BQU0sQ0FBQyxPQUFPLENBQUMsVUFBVSxDQUFDLE1BQU0sQ0FBQyxDQUFDLE1BQU0sQ0FFMUQsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxHQUFHLEVBQUUsS0FBSyxDQUFDLEVBQUUsRUFBRTtZQUN2Qix5Q0FBeUM7WUFDekMsZ0VBQWdFO1lBQ2hFLE1BQU0sRUFBRSxTQUFTLEVBQUUsU0FBUyxFQUFFLEdBQUcsTUFBTSxFQUFFLEdBQUcsS0FBSyxDQUFDLE1BQU0sQ0FBQztZQUV6RCxNQUFNLDZCQUE2QixHQUFHO2dCQUNwQyxHQUFHLEtBQUs7Z0JBQ1IsTUFBTTthQUNQLENBQUM7WUFFRixJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsNkJBQTZCLENBQUM7WUFFMUMsT0FBTyxJQUFJLENBQUM7UUFDZCxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFFUCxNQUFNLEtBQUssR0FBRyxTQUFTLENBQUMsTUFBTSxDQUM1QixDQUFDLElBQUksRUFBRSxVQUFVLEVBQUUsRUFBRTtZQUNuQixNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLFVBQVUsRUFBRSxVQUFVLENBQUMsQ0FBQztZQUN6RCxPQUFPLENBQUMsT0FBTyxDQUFDLENBQUMsTUFBTSxFQUFFLEVBQUU7Z0JBQ3pCLElBQUksQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLEdBQUcsTUFBTSxDQUFDLGFBQWEsQ0FBQztZQUMvQyxDQUFDLENBQUMsQ0FBQztZQUNILE9BQU8sSUFBSSxDQUFDO1FBQ2QsQ0FBQyxFQUNELEVBQUUsQ0FDSCxDQUFDO1FBQ0YsS0FBSyxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUMsR0FBRyxRQUFRLENBQUMsYUFBYSxDQUFDO1FBQ2xELEtBQUssQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDLEdBQUcsU0FBUyxDQUFDLGFBQWEsQ0FBQztRQUNwRCxPQUFPLElBQUksQ0FBQyxhQUFhLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDbkMsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgRm9ybUZlYXR1cmVGbGFncyxcbiAgR2VuZXJpY0RhdGFTY2hlbWEsXG4gIFN0dWRpb0Zvcm0sXG4gIFN0dWRpb1NjaGVtYSxcbn0gZnJvbSAnQGF3cy1hbXBsaWZ5L2NvZGVnZW4tdWknO1xuaW1wb3J0IHtcbiAgQW1wbGlmeUZvcm1SZW5kZXJlcixcbiAgTW9kdWxlS2luZCxcbiAgUmVhY3RJbmRleFN0dWRpb1RlbXBsYXRlUmVuZGVyZXIsXG4gIFJlYWN0UmVuZGVyQ29uZmlnLFxuICBSZWFjdFV0aWxzU3R1ZGlvVGVtcGxhdGVSZW5kZXJlcixcbiAgU2NyaXB0S2luZCxcbiAgU2NyaXB0VGFyZ2V0LFxuICBVdGlsVGVtcGxhdGVUeXBlLFxuICBnZXREZWNsYXJhdGlvbkZpbGVuYW1lLFxufSBmcm9tICdAYXdzLWFtcGxpZnkvY29kZWdlbi11aS1yZWFjdCc7XG5pbXBvcnQge1xuICBGb3JtR2VuZXJhdGlvbk9wdGlvbnMsXG4gIEdyYXBocWxGb3JtR2VuZXJhdG9yLFxuICBHcmFwaHFsR2VuZXJhdGlvblJlc3VsdCxcbn0gZnJvbSAnLi9ncmFwaHFsX2Zvcm1fZ2VuZXJhdG9yLmpzJztcblxudHlwZSBGb3JtRGVmID0gU2V0PCdjcmVhdGUnIHwgJ3VwZGF0ZSc+O1xudHlwZSBNb2RlbFJlY29yZCA9IFJlY29yZDxzdHJpbmcsIEZvcm1EZWY+O1xuXG4vKipcbiAqIFJlbmRlciBDb25maWd1cmF0aW9uIE9wdGlvbnMgZm9yIHJlYWN0IGZvcm1zXG4gKi9cbmV4cG9ydCB0eXBlIFJlbmRlck9wdGlvbnMgPSB7XG4gIGdyYXBocWxEaXI6IHN0cmluZztcbn07XG5cbmV4cG9ydCB0eXBlIFJlc3VsdEJ1aWxkZXIgPSAoXG4gIGZpbGVNYXA6IFJlY29yZDxzdHJpbmcsIHN0cmluZz5cbikgPT4gR3JhcGhxbEdlbmVyYXRpb25SZXN1bHQ7XG5cbmV4cG9ydCB0eXBlIFNjaGVtYUZldGNoZXIgPSAoKSA9PiBQcm9taXNlPEdlbmVyaWNEYXRhU2NoZW1hPjtcbi8qKlxuICogR2VuZXJhdGVzIEdyYXBoUUwtY29tcGF0aWJsZSBmb3JtcyBpbiBSZWFjdCBieSBkaXJlY3RseSBsZXZlcmFnaW5nIEBhd3MtYW1wbGlmeS9jb2RlZ2VuLXVpLXJlYWN0XG4gKi9cbmV4cG9ydCBjbGFzcyBMb2NhbEdyYXBocWxGb3JtR2VuZXJhdG9yIGltcGxlbWVudHMgR3JhcGhxbEZvcm1HZW5lcmF0b3Ige1xuICAvKipcbiAgICogSW5zdGFudGlhdGVzIGEgTG9jYWxHcmFwaHFsRm9ybUdlbmVyYXRvciBmb3IgYSBwcm92aWRlZCBzY2hlbWFcbiAgICovXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgc2NoZW1hRmV0Y2hlcjogU2NoZW1hRmV0Y2hlcixcbiAgICBwcml2YXRlIHJlbmRlck9wdGlvbnM6IFJlbmRlck9wdGlvbnMsXG4gICAgcHJpdmF0ZSByZXN1bHRCdWlsZGVyOiBSZXN1bHRCdWlsZGVyXG4gICkge31cbiAgLyoqXG4gICAqIHJlZHVjZXMgdGhlIGRhdGFTY2hlbWEgdG8gYSBtYXAgb2YgbW9kZWxzXG4gICAqL1xuICBwcml2YXRlIGdldE1vZGVsTWFwRm9yRGF0YVNjaGVtYSA9IChkYXRhU2NoZW1hOiBHZW5lcmljRGF0YVNjaGVtYSkgPT4ge1xuICAgIHJldHVybiBPYmplY3QuZW50cmllcyhkYXRhU2NoZW1hLm1vZGVscykucmVkdWNlPE1vZGVsUmVjb3JkPihcbiAgICAgIChwcmV2LCBbbmFtZSwgbW9kZWxdKSA9PiB7XG4gICAgICAgIGlmICghbW9kZWwuaXNKb2luVGFibGUpIHtcbiAgICAgICAgICBwcmV2W25hbWVdID0gbmV3IFNldChbJ2NyZWF0ZScsICd1cGRhdGUnXSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHByZXY7XG4gICAgICB9LFxuICAgICAge31cbiAgICApO1xuICB9O1xuXG4gIHByaXZhdGUgZ2V0U2NoZW1hID0gKFxuICAgIG5hbWU6IHN0cmluZyxcbiAgICB0eXBlOiAnY3JlYXRlJyB8ICd1cGRhdGUnXG4gICk6IFN0dWRpb0Zvcm0gPT4gKHtcbiAgICBuYW1lOiBgJHtuYW1lfSR7dHlwZSA9PT0gJ2NyZWF0ZScgPyAnQ3JlYXRlRm9ybScgOiAnVXBkYXRlRm9ybSd9YCxcbiAgICBmb3JtQWN0aW9uVHlwZTogdHlwZSxcbiAgICBkYXRhVHlwZTogeyBkYXRhU291cmNlVHlwZTogJ0RhdGFTdG9yZScsIGRhdGFUeXBlTmFtZTogbmFtZSB9LFxuICAgIGZpZWxkczoge30sXG4gICAgc2VjdGlvbmFsRWxlbWVudHM6IHt9LFxuICAgIHN0eWxlOiB7fSxcbiAgICBjdGE6IHt9LFxuICB9KTtcblxuICBwcml2YXRlIGdlbmVyYXRlQmFzZUZvcm1zID0gKG1vZGVsTWFwOiB7XG4gICAgW21vZGVsOiBzdHJpbmddOiBTZXQ8J2NyZWF0ZScgfCAndXBkYXRlJz47XG4gIH0pOiBTdHVkaW9Gb3JtW10gPT4ge1xuICAgIGNvbnN0IHNjaGVtYXM6IFN0dWRpb0Zvcm1bXSA9IFtdO1xuICAgIE9iamVjdC5lbnRyaWVzKG1vZGVsTWFwKS5mb3JFYWNoKChbbmFtZSwgc2V0XSkgPT4ge1xuICAgICAgc2V0LmZvckVhY2goKHR5cGUpID0+IHNjaGVtYXMucHVzaCh0aGlzLmdldFNjaGVtYShuYW1lLCB0eXBlKSkpO1xuICAgIH0pO1xuICAgIHJldHVybiBzY2hlbWFzO1xuICB9O1xuXG4gIHByaXZhdGUgcmVuZGVyR3JhcGhxbFBhdGggPSAoXG4gICAgc3VibW9kdWxlOiAnZnJhZ21lbnRzJyB8ICdtdXRhdGlvbnMnIHwgJ3F1ZXJpZXMnIHwgJ3R5cGVzJyB8ICdzdWJzY3JpcHRpb25zJ1xuICApID0+IHtcbiAgICBjb25zdCBncmFwaHFsUGF0aCA9IGAke3RoaXMucmVuZGVyT3B0aW9ucy5ncmFwaHFsRGlyfS8ke3N1Ym1vZHVsZX1gO1xuICAgIC8vIGlmIHRoZSBwYXRoIGRvZXMgbm90IHN0YXJ0IHdpdGggYSBsZWFkaW5nIC4vIG9yIC4uLywgYXNzdW1lIHRoYXQgdGhlIGdyYXBocWwgZm9sZGVyIGlzIGluIHRoZSBzYW1lIGRpcmVjdG9yeSByZWxhdGl2ZSB0byB0aGUgdWksIGFuZCBwcmVwZW5kIGEgYC4vYFxuICAgIGlmIChncmFwaHFsUGF0aC5zdGFydHNXaXRoKCcuJykpIHtcbiAgICAgIHJldHVybiBncmFwaHFsUGF0aDtcbiAgICB9XG4gICAgcmV0dXJuIGAuLyR7Z3JhcGhxbFBhdGh9YDtcbiAgfTtcblxuICAvKipcbiAgICogR2V0cyB0aGUgcmVhY3QgcmVuZGVyIGNvbmZpZ1xuICAgKi9cbiAgcHJpdmF0ZSBnZXQgY29uZmlnKCk6IFJlYWN0UmVuZGVyQ29uZmlnIHtcbiAgICByZXR1cm4ge1xuICAgICAgbW9kdWxlOiBNb2R1bGVLaW5kLkVTMjAyMCxcbiAgICAgIHRhcmdldDogU2NyaXB0VGFyZ2V0LkVTMjAyMCxcbiAgICAgIHNjcmlwdDogU2NyaXB0S2luZC5KU1gsXG4gICAgICBpbmNsdWRlVXNlQ2xpZW50RGlyZWN0aXZlOiB0cnVlLFxuICAgICAgcmVuZGVyVHlwZURlY2xhcmF0aW9uczogdHJ1ZSxcbiAgICAgIGFwaUNvbmZpZ3VyYXRpb246IHtcbiAgICAgICAgZGF0YUFwaTogJ0dyYXBoUUwnLFxuICAgICAgICBmcmFnbWVudHNGaWxlUGF0aDogdGhpcy5yZW5kZXJHcmFwaHFsUGF0aCgnZnJhZ21lbnRzJyksXG4gICAgICAgIG11dGF0aW9uc0ZpbGVQYXRoOiB0aGlzLnJlbmRlckdyYXBocWxQYXRoKCdtdXRhdGlvbnMnKSxcbiAgICAgICAgcXVlcmllc0ZpbGVQYXRoOiB0aGlzLnJlbmRlckdyYXBocWxQYXRoKCdxdWVyaWVzJyksXG4gICAgICAgIHN1YnNjcmlwdGlvbnNGaWxlUGF0aDogdGhpcy5yZW5kZXJHcmFwaHFsUGF0aCgnc3Vic2NyaXB0aW9ucycpLFxuICAgICAgICB0eXBlc0ZpbGVQYXRoOiB0aGlzLnJlbmRlckdyYXBocWxQYXRoKCd0eXBlcycpLFxuICAgICAgfSxcbiAgICAgIGRlcGVuZGVuY2llczoge1xuICAgICAgICAvLyBUZWxsIHRoZSByZW5kZXJlciB0byBnZW5lcmF0ZSBhbXBsaWZ5IGpzIHY2IGNvbXBhdGlibGUgY29kZVxuICAgICAgICAnYXdzLWFtcGxpZnknOiAnXjYuMC4wJyxcbiAgICAgIH0sXG4gICAgfTtcbiAgfVxuICBwcml2YXRlIGNyZWF0ZVVpQnVpbGRlckZvcm0gPSAoXG4gICAgc2NoZW1hOiBTdHVkaW9Gb3JtLFxuICAgIGRhdGFTY2hlbWE/OiBHZW5lcmljRGF0YVNjaGVtYSxcbiAgICBmb3JtRmVhdHVyZUZsYWdzPzogRm9ybUZlYXR1cmVGbGFnc1xuICApID0+IHtcbiAgICBjb25zdCByZW5kZXJlciA9IG5ldyBBbXBsaWZ5Rm9ybVJlbmRlcmVyKFxuICAgICAgc2NoZW1hLFxuICAgICAgZGF0YVNjaGVtYSxcbiAgICAgIHRoaXMuY29uZmlnLFxuICAgICAgZm9ybUZlYXR1cmVGbGFnc1xuICAgICk7XG4gICAgY29uc3QgeyBjb21wb25lbnRUZXh0LCBkZWNsYXJhdGlvbiB9ID0gcmVuZGVyZXIucmVuZGVyQ29tcG9uZW50SW50ZXJuYWwoKTtcbiAgICBjb25zdCBmaWxlcyA9IFtcbiAgICAgIHtcbiAgICAgICAgY29tcG9uZW50VGV4dCxcbiAgICAgICAgZmlsZU5hbWU6IHJlbmRlcmVyLmZpbGVOYW1lLFxuICAgICAgfSxcbiAgICBdO1xuICAgIGlmIChkZWNsYXJhdGlvbikge1xuICAgICAgZmlsZXMucHVzaCh7XG4gICAgICAgIGNvbXBvbmVudFRleHQ6IGRlY2xhcmF0aW9uLFxuICAgICAgICBmaWxlTmFtZTogZ2V0RGVjbGFyYXRpb25GaWxlbmFtZShyZW5kZXJlci5maWxlTmFtZSksXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICByZXR1cm4gZmlsZXM7XG4gIH07XG4gIHByaXZhdGUgZmlsdGVyTW9kZWxzQnlOYW1lID0gKFxuICAgIGZpbHRlcmVkTW9kZWxOYW1lczogc3RyaW5nW10sXG4gICAgc2NoZW1hTW9kZWw6IE1vZGVsUmVjb3JkXG4gICkgPT4ge1xuICAgIGNvbnN0IGxvd2VyQ2FzZU1vZGVsS2V5cyA9IG5ldyBTZXQoXG4gICAgICBPYmplY3Qua2V5cyhzY2hlbWFNb2RlbCkubWFwKChrKSA9PiBrLnRvTG93ZXJDYXNlKCkpXG4gICAgKTtcbiAgICBjb25zdCBtb2RlbEVudHJpZXMgPSBPYmplY3QuZW50cmllcyhzY2hlbWFNb2RlbCk7XG4gICAgcmV0dXJuIGZpbHRlcmVkTW9kZWxOYW1lcy5yZWR1Y2U8QXJyYXk8W3N0cmluZywgRm9ybURlZl0+PihcbiAgICAgIChwcmV2LCBtb2RlbCkgPT4ge1xuICAgICAgICBpZiAobG93ZXJDYXNlTW9kZWxLZXlzPy5oYXMobW9kZWwudG9Mb3dlckNhc2UoKSkpIHtcbiAgICAgICAgICBjb25zdCBlbnRyeSA9IG1vZGVsRW50cmllcy5maW5kKFxuICAgICAgICAgICAgKFtrZXldKSA9PiBrZXkudG9Mb3dlckNhc2UoKSA9PT0gbW9kZWwudG9Mb3dlckNhc2UoKVxuICAgICAgICAgICk7XG4gICAgICAgICAgaWYgKCFlbnRyeSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBDb3VsZCBub3QgZmluZCBzcGVjaWZpZWQgbW9kZWwgJHttb2RlbH1gKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgcHJldi5wdXNoKGVudHJ5KTtcbiAgICAgICAgICByZXR1cm4gcHJldjtcbiAgICAgICAgfVxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYENvdWxkIG5vdCBmaW5kIHNwZWNpZmllZCBtb2RlbCAke21vZGVsfWApO1xuICAgICAgfSxcbiAgICAgIFtdXG4gICAgKTtcbiAgfTtcbiAgcHJpdmF0ZSBjb2RlZ2VuRm9ybSA9IChcbiAgICBkYXRhU2NoZW1hOiBHZW5lcmljRGF0YVNjaGVtYSxcbiAgICBmb3JtU2NoZW1hOiBTdHVkaW9Gb3JtXG4gICkgPT4ge1xuICAgIHJldHVybiB0aGlzLmNyZWF0ZVVpQnVpbGRlckZvcm0oZm9ybVNjaGVtYSwgZGF0YVNjaGVtYSwge30pO1xuICB9O1xuXG4gIHByaXZhdGUgZ2V0RmlsdGVyZWRNb2RlbHMgPSAoXG4gICAgZGF0YVNjaGVtYTogR2VuZXJpY0RhdGFTY2hlbWEsXG4gICAgZmlsdGVyZWRNb2RlbE5hbWVzPzogc3RyaW5nW11cbiAgKSA9PiB7XG4gICAgY29uc3QgbW9kZWxNYXAgPSB0aGlzLmdldE1vZGVsTWFwRm9yRGF0YVNjaGVtYShkYXRhU2NoZW1hKTtcbiAgICBjb25zdCBmaWx0ZXJlZE1vZGVsczogQXJyYXk8W3N0cmluZywgRm9ybURlZl0+ID0gW107XG4gICAgaWYgKCFmaWx0ZXJlZE1vZGVsTmFtZXMgfHwgIWZpbHRlcmVkTW9kZWxOYW1lcz8ubGVuZ3RoKSB7XG4gICAgICBmaWx0ZXJlZE1vZGVscy5wdXNoKC4uLk9iamVjdC5lbnRyaWVzKG1vZGVsTWFwKSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGZpbHRlcmVkTW9kZWxzLnB1c2goXG4gICAgICAgIC4uLnRoaXMuZmlsdGVyTW9kZWxzQnlOYW1lKGZpbHRlcmVkTW9kZWxOYW1lcywgbW9kZWxNYXApXG4gICAgICApO1xuICAgIH1cbiAgICByZXR1cm4gZmlsdGVyZWRNb2RlbHM7XG4gIH07XG4gIHByaXZhdGUgdHJhbnNmb3JtTW9kZWxMaXN0VG9NYXAgPSAobW9kZWxzOiBBcnJheTxbc3RyaW5nLCBGb3JtRGVmXT4pID0+IHtcbiAgICByZXR1cm4gbW9kZWxzLnJlZHVjZShcbiAgICAgIChwcmV2LCBba2V5LCB2YWx1ZV0pID0+ICh7IC4uLnByZXYsIFtrZXldOiB2YWx1ZSB9KSxcbiAgICAgIHt9XG4gICAgKTtcbiAgfTtcbiAgcHJpdmF0ZSBzdGF0aWMgZGVmYXVsdENvbmZpZyA9IHtcbiAgICBtb2R1bGU6IE1vZHVsZUtpbmQuRVMyMDIwLFxuICAgIHRhcmdldDogU2NyaXB0VGFyZ2V0LkVTMjAyMCxcbiAgICBzY3JpcHQ6IFNjcmlwdEtpbmQuSlNYLFxuICAgIHJlbmRlclR5cGVEZWNsYXJhdGlvbnM6IHRydWUsXG4gIH07XG4gIHByaXZhdGUgY3JlYXRlVXRpbEZpbGUgPSAodXRpbHM6IFV0aWxUZW1wbGF0ZVR5cGVbXSkgPT4ge1xuICAgIGNvbnN0IHJlbmRlcmVyID0gbmV3IFJlYWN0VXRpbHNTdHVkaW9UZW1wbGF0ZVJlbmRlcmVyKFxuICAgICAgdXRpbHMsXG4gICAgICBMb2NhbEdyYXBocWxGb3JtR2VuZXJhdG9yLmRlZmF1bHRDb25maWdcbiAgICApO1xuICAgIGNvbnN0IHsgY29tcG9uZW50VGV4dCB9ID0gcmVuZGVyZXIucmVuZGVyQ29tcG9uZW50SW50ZXJuYWwoKTtcbiAgICByZXR1cm4ge1xuICAgICAgY29tcG9uZW50VGV4dCxcbiAgICAgIGZpbGVOYW1lOiByZW5kZXJlci5maWxlTmFtZSxcbiAgICB9O1xuICB9O1xuXG4gIC8qKlxuICAgKiBSZXR1cm4gdXRpbHMgZmlsZSB0ZXh0XG4gICAqL1xuICBwcml2YXRlIGdlbmVyYXRlVXRpbEZpbGUgPSAoKSA9PiB7XG4gICAgY29uc3QgdXRpbHM6IFV0aWxUZW1wbGF0ZVR5cGVbXSA9IFtcbiAgICAgICd2YWxpZGF0aW9uJyxcbiAgICAgICdmb3JtYXR0ZXInLFxuICAgICAgJ2ZldGNoQnlQYXRoJyxcbiAgICAgICdwcm9jZXNzRmlsZScsXG4gICAgXTtcbiAgICBjb25zdCB7IGNvbXBvbmVudFRleHQsIGZpbGVOYW1lIH0gPSB0aGlzLmNyZWF0ZVV0aWxGaWxlKHV0aWxzKTtcbiAgICByZXR1cm4ge1xuICAgICAgc2NoZW1hTmFtZTogJ0FtcGxpZnlTdHVkaW9VdGlsRmlsZScsXG4gICAgICBjb21wb25lbnRUZXh0LFxuICAgICAgZmlsZU5hbWUsXG4gICAgICBkZWNsYXJhdGlvbjogdW5kZWZpbmVkLFxuICAgICAgZXJyb3I6IHVuZGVmaW5lZCxcbiAgICB9O1xuICB9O1xuXG4gIHByaXZhdGUgY3JlYXRlSW5kZXhGaWxlID0gKHNjaGVtYXM6IFN0dWRpb1NjaGVtYVtdKSA9PiB7XG4gICAgY29uc3QgcmVuZGVyZXIgPSBuZXcgUmVhY3RJbmRleFN0dWRpb1RlbXBsYXRlUmVuZGVyZXIoXG4gICAgICBzY2hlbWFzLFxuICAgICAgTG9jYWxHcmFwaHFsRm9ybUdlbmVyYXRvci5kZWZhdWx0Q29uZmlnXG4gICAgKTtcbiAgICBjb25zdCB7IGNvbXBvbmVudFRleHQgfSA9IHJlbmRlcmVyLnJlbmRlckNvbXBvbmVudEludGVybmFsKCk7XG4gICAgcmV0dXJuIHtcbiAgICAgIGNvbXBvbmVudFRleHQsXG4gICAgICBmaWxlTmFtZTogcmVuZGVyZXIuZmlsZU5hbWUsXG4gICAgfTtcbiAgfTtcblxuICBnZW5lcmF0ZUluZGV4RmlsZSA9IChzY2hlbWFzOiB7IG5hbWU6IHN0cmluZyB9W10pID0+IHtcbiAgICBjb25zdCB7IGNvbXBvbmVudFRleHQsIGZpbGVOYW1lIH0gPSB0aGlzLmNyZWF0ZUluZGV4RmlsZShcbiAgICAgIHNjaGVtYXMgYXMgU3R1ZGlvU2NoZW1hW11cbiAgICApO1xuICAgIHJldHVybiB7XG4gICAgICBzY2hlbWFOYW1lOiAnQW1wbGlmeVN0dWRpb0luZGV4RmlsZScsXG4gICAgICBjb21wb25lbnRUZXh0LFxuICAgICAgZmlsZU5hbWUsXG4gICAgICBkZWNsYXJhdGlvbjogdW5kZWZpbmVkLFxuICAgICAgZXJyb3I6IHVuZGVmaW5lZCxcbiAgICB9O1xuICB9O1xuXG4gIGdlbmVyYXRlRm9ybXMgPSBhc3luYyAoXG4gICAgb3B0aW9ucz86IEZvcm1HZW5lcmF0aW9uT3B0aW9uc1xuICApOiBQcm9taXNlPEdyYXBocWxHZW5lcmF0aW9uUmVzdWx0PiA9PiB7XG4gICAgY29uc3QgZGF0YVNjaGVtYSA9IGF3YWl0IHRoaXMuc2NoZW1hRmV0Y2hlcigpO1xuICAgIGNvbnN0IGZpbHRlcmVkTW9kZWxzID0gdGhpcy5nZXRGaWx0ZXJlZE1vZGVscyhkYXRhU2NoZW1hLCBvcHRpb25zPy5tb2RlbHMpO1xuICAgIGNvbnN0IGZpbHRlcmVkU2NoZW1hID0gdGhpcy50cmFuc2Zvcm1Nb2RlbExpc3RUb01hcChmaWx0ZXJlZE1vZGVscyk7XG4gICAgY29uc3QgdXRpbEZpbGUgPSB0aGlzLmdlbmVyYXRlVXRpbEZpbGUoKTtcbiAgICBjb25zdCBiYXNlRm9ybXMgPSB0aGlzLmdlbmVyYXRlQmFzZUZvcm1zKGZpbHRlcmVkU2NoZW1hKTtcbiAgICBjb25zdCBpbmRleEZpbGUgPSB0aGlzLmdlbmVyYXRlSW5kZXhGaWxlKFxuICAgICAgYmFzZUZvcm1zLm1hcCgoeyBuYW1lIH0pID0+ICh7XG4gICAgICAgIG5hbWUsXG4gICAgICB9KSlcbiAgICApO1xuXG4gICAgZGF0YVNjaGVtYS5tb2RlbHMgPSBPYmplY3QuZW50cmllcyhkYXRhU2NoZW1hLm1vZGVscykucmVkdWNlPFxuICAgICAgKHR5cGVvZiBkYXRhU2NoZW1hKVsnbW9kZWxzJ11cbiAgICA+KChwcmV2LCBba2V5LCB2YWx1ZV0pID0+IHtcbiAgICAgIC8vIERpc2NhcmQgY3JlYXRlZEF0IGFuZCB1cGRhdGVkQXQgZmllbGRzXG4gICAgICAvKiBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLXVudXNlZC12YXJzICovXG4gICAgICBjb25zdCB7IGNyZWF0ZWRBdCwgdXBkYXRlZEF0LCAuLi5maWVsZHMgfSA9IHZhbHVlLmZpZWxkcztcblxuICAgICAgY29uc3QgdmFsdWVFeGNsdWRpbmdUaW1lc3RhbXBGaWVsZHMgPSB7XG4gICAgICAgIC4uLnZhbHVlLFxuICAgICAgICBmaWVsZHMsXG4gICAgICB9O1xuXG4gICAgICBwcmV2W2tleV0gPSB2YWx1ZUV4Y2x1ZGluZ1RpbWVzdGFtcEZpZWxkcztcblxuICAgICAgcmV0dXJuIHByZXY7XG4gICAgfSwge30pO1xuXG4gICAgY29uc3QgZm9ybXMgPSBiYXNlRm9ybXMucmVkdWNlPFJlY29yZDxzdHJpbmcsIHN0cmluZz4+KFxuICAgICAgKHByZXYsIGZvcm1TY2hlbWEpID0+IHtcbiAgICAgICAgY29uc3QgcmVzdWx0cyA9IHRoaXMuY29kZWdlbkZvcm0oZGF0YVNjaGVtYSwgZm9ybVNjaGVtYSk7XG4gICAgICAgIHJlc3VsdHMuZm9yRWFjaCgocmVzdWx0KSA9PiB7XG4gICAgICAgICAgcHJldltyZXN1bHQuZmlsZU5hbWVdID0gcmVzdWx0LmNvbXBvbmVudFRleHQ7XG4gICAgICAgIH0pO1xuICAgICAgICByZXR1cm4gcHJldjtcbiAgICAgIH0sXG4gICAgICB7fVxuICAgICk7XG4gICAgZm9ybXNbdXRpbEZpbGUuZmlsZU5hbWVdID0gdXRpbEZpbGUuY29tcG9uZW50VGV4dDtcbiAgICBmb3Jtc1tpbmRleEZpbGUuZmlsZU5hbWVdID0gaW5kZXhGaWxlLmNvbXBvbmVudFRleHQ7XG4gICAgcmV0dXJuIHRoaXMucmVzdWx0QnVpbGRlcihmb3Jtcyk7XG4gIH07XG59XG4iXX0=