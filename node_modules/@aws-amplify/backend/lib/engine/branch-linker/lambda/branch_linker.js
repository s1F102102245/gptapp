import { randomUUID } from 'node:crypto';
import { AmplifyClient, GetBranchCommand, NotFoundException, UpdateBranchCommand, } from '@aws-sdk/client-amplify';
/**
 * Handles custom resource events.
 */
export class AmplifyBranchLinkerCustomResourceEventHandler {
    amplifyClient;
    /**
     * Creates the custom resource events handler.
     */
    constructor(amplifyClient) {
        this.amplifyClient = amplifyClient;
    }
    handleCustomResourceEvent = async (event) => {
        console.info(`Received '${event.RequestType}' event`);
        const physicalId = event.RequestType === 'Create' ? randomUUID() : event.PhysicalResourceId;
        const props = event.ResourceProperties;
        switch (event.RequestType) {
            case 'Create':
            case 'Update':
                console.info(`Setting stack reference for appId=${props.appId},branchName=${props.branchName} to ${event.StackId}`);
                await this.updateOrUnsetStackReference(props.appId, props.branchName, event.StackId);
                break;
            case 'Delete':
                console.info(`Un-setting stack reference for appId=${props.appId},branchName=${props.branchName}`);
                try {
                    await this.updateOrUnsetStackReference(props.appId, props.branchName, undefined);
                }
                catch (e) {
                    if (e instanceof NotFoundException) {
                        console.info(`Branch branchName=${props.branchName} of appId=${props.appId} was not found while handling delete event`);
                    }
                    else {
                        throw e;
                    }
                }
                break;
        }
        return {
            RequestId: event.RequestId,
            LogicalResourceId: event.LogicalResourceId,
            PhysicalResourceId: physicalId,
            StackId: event.StackId,
            Status: 'SUCCESS',
        };
    };
    updateOrUnsetStackReference = async (appId, branchName, stackId) => {
        // Stack id is in ARN format.
        if (stackId && !stackId?.startsWith('arn:')) {
            throw new Error(`Provided stackId ${stackId} is not in ARN format`);
        }
        const branch = await this.getBranch(appId, branchName);
        console.info(`Received branch details ${JSON.stringify(branch)}`);
        // Populate update command input with existing values, so we don't lose them.
        const updateBranchCommandInput = {
            appId,
            ...branch,
        };
        // This is a known bug in the service. I.e. branch can be created without stage
        // but service returns 'NONE' instead of undefined which is not part of
        // Stage enum...
        if (updateBranchCommandInput.stage === 'NONE') {
            updateBranchCommandInput.stage = undefined;
        }
        // Set or unset stackId
        if (stackId) {
            if (!updateBranchCommandInput.backend) {
                updateBranchCommandInput.backend = {};
            }
            updateBranchCommandInput.backend.stackArn = stackId;
        }
        else {
            if (updateBranchCommandInput.backend?.stackArn) {
                delete updateBranchCommandInput.backend.stackArn;
            }
        }
        console.info(`Sending branch update ${JSON.stringify(updateBranchCommandInput)}`);
        await this.amplifyClient.send(new UpdateBranchCommand(updateBranchCommandInput));
    };
    getBranch = async (appId, branchName) => {
        const branch = (await this.amplifyClient.send(new GetBranchCommand({ appId, branchName }))).branch;
        if (!branch) {
            throw new Error(`Unable to get branch ${branchName} for app ${appId}`);
        }
        return branch;
    };
}
const customResourceEventHandler = new AmplifyBranchLinkerCustomResourceEventHandler(new AmplifyClient());
/**
 * Entry point for the lambda-backend custom resource to link deployment to branch.
 */
export const handler = (event) => {
    return customResourceEventHandler.handleCustomResourceEvent(event);
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYnJhbmNoX2xpbmtlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9lbmdpbmUvYnJhbmNoLWxpbmtlci9sYW1iZGEvYnJhbmNoX2xpbmtlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFJQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sYUFBYSxDQUFDO0FBQ3pDLE9BQU8sRUFDTCxhQUFhLEVBRWIsZ0JBQWdCLEVBQ2hCLGlCQUFpQixFQUNqQixtQkFBbUIsR0FFcEIsTUFBTSx5QkFBeUIsQ0FBQztBQUdqQzs7R0FFRztBQUNILE1BQU0sT0FBTyw2Q0FBNkM7SUFJM0I7SUFIN0I7O09BRUc7SUFDSCxZQUE2QixhQUE0QjtRQUE1QixrQkFBYSxHQUFiLGFBQWEsQ0FBZTtJQUFHLENBQUM7SUFFN0QseUJBQXlCLEdBQUcsS0FBSyxFQUMvQixLQUF3QyxFQUNjLEVBQUU7UUFDeEQsT0FBTyxDQUFDLElBQUksQ0FBQyxhQUFhLEtBQUssQ0FBQyxXQUFXLFNBQVMsQ0FBQyxDQUFDO1FBRXRELE1BQU0sVUFBVSxHQUNkLEtBQUssQ0FBQyxXQUFXLEtBQUssUUFBUSxDQUFDLENBQUMsQ0FBQyxVQUFVLEVBQUUsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLGtCQUFrQixDQUFDO1FBRTNFLE1BQU0sS0FBSyxHQUNULEtBQUssQ0FBQyxrQkFBdUUsQ0FBQztRQUVoRixRQUFRLEtBQUssQ0FBQyxXQUFXLEVBQUU7WUFDekIsS0FBSyxRQUFRLENBQUM7WUFDZCxLQUFLLFFBQVE7Z0JBQ1gsT0FBTyxDQUFDLElBQUksQ0FDVixxQ0FBcUMsS0FBSyxDQUFDLEtBQUssZUFBZSxLQUFLLENBQUMsVUFBVSxPQUFPLEtBQUssQ0FBQyxPQUFPLEVBQUUsQ0FDdEcsQ0FBQztnQkFDRixNQUFNLElBQUksQ0FBQywyQkFBMkIsQ0FDcEMsS0FBSyxDQUFDLEtBQUssRUFDWCxLQUFLLENBQUMsVUFBVSxFQUNoQixLQUFLLENBQUMsT0FBTyxD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QyxNQUFNLEVBQUU7WUFDWCxNQUFNLElBQUksS0FBSyxDQUFDLHdCQUF3QixVQUFVLFlBQVksS0FBSyxFQUFFLENBQUMsQ0FBQztTQUN4RTtRQUNELE9BQU8sTUFBTSxDQUFDO0lBQ2hCLENBQUMsQ0FBQztDQUNIO0FBRUQsTUFBTSwwQkFBMEIsR0FDOUIsSUFBSSw2Q0FBNkMsQ0FBQyxJQUFJLGFBQWEsRUFBRSxDQUFDLENBQUM7QUFFekU7O0dBRUc7QUFDSCxNQUFNLENBQUMsTUFBTSxPQUFPLEdBQUcsQ0FDckIsS0FBd0MsRUFDYyxFQUFFO0lBQ3hELE9BQU8sMEJBQTBCLENBQUMseUJBQXlCLENBQUMsS0FBSyxDQUFDLENBQUM7QUFDckUsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgQ2xvdWRGb3JtYXRpb25DdXN0b21SZXNvdXJjZUV2ZW50LFxuICBDbG91ZEZvcm1hdGlvbkN1c3RvbVJlc291cmNlU3VjY2Vzc1Jlc3BvbnNlLFxufSBmcm9tICdhd3MtbGFtYmRhJztcbmltcG9ydCB7IHJhbmRvbVVVSUQgfSBmcm9tICdub2RlOmNyeXB0byc7XG5pbXBvcnQge1xuICBBbXBsaWZ5Q2xpZW50LFxuICBCcmFuY2gsXG4gIEdldEJyYW5jaENvbW1hbmQsXG4gIE5vdEZvdW5kRXhjZXB0aW9uLFxuICBVcGRhdGVCcmFuY2hDb21tYW5kLFxuICBVcGRhdGVCcmFuY2hDb21tYW5kSW5wdXQsXG59IGZyb20gJ0Bhd3Mtc2RrL2NsaWVudC1hbXBsaWZ5JztcbmltcG9ydCB7IEFtcGxpZnlCcmFuY2hMaW5rZXJDdXN0b21SZXNvdXJjZVByb3BzIH0gZnJvbSAnLi9icmFuY2hfbGlua2VyX3R5cGVzLmpzJztcblxuLyoqXG4gKiBIYW5kbGVzIGN1c3RvbSByZXNvdXJjZSBldmVudHMuXG4gKi9cbmV4cG9ydCBjbGFzcyBBbXBsaWZ5QnJhbmNoTGlua2VyQ3VzdG9tUmVzb3VyY2VFdmVudEhhbmRsZXIge1xuICAvKipcbiAgICogQ3JlYXRlcyB0aGUgY3VzdG9tIHJlc291cmNlIGV2ZW50cyBoYW5kbGVyLlxuICAgKi9cbiAgY29uc3RydWN0b3IocHJpdmF0ZSByZWFkb25seSBhbXBsaWZ5Q2xpZW50OiBBbXBsaWZ5Q2xpZW50KSB7fVxuXG4gIGhhbmRsZUN1c3RvbVJlc291cmNlRXZlbnQgPSBhc3luYyAoXG4gICAgZXZlbnQ6IENsb3VkRm9ybWF0aW9uQ3VzdG9tUmVzb3VyY2VFdmVudFxuICApOiBQcm9taXNlPENsb3VkRm9ybWF0aW9uQ3VzdG9tUmVzb3VyY2VTdWNjZXNzUmVzcG9uc2U+ID0+IHtcbiAgICBjb25zb2xlLmluZm8oYFJlY2VpdmVkICcke2V2ZW50LlJlcXVlc3RUeXBlfScgZXZlbnRgKTtcblxuICAgIGNvbnN0IHBoeXNpY2FsSWQgPVxuICAgICAgZXZlbnQuUmVxdWVzdFR5cGUgPT09ICdDcmVhdGUnID8gcmFuZG9tVVVJRCgpIDogZXZlbnQuUGh5c2ljYWxSZXNvdXJjZUlkO1xuXG4gICAgY29uc3QgcHJvcHMgPVxuICAgICAgZXZlbnQuUmVzb3VyY2VQcm9wZXJ0aWVzIGFzIHVua25vd24gYXMgQW1wbGlmeUJyYW5jaExpbmtlckN1c3RvbVJlc291cmNlUHJvcHM7XG5cbiAgICBzd2l0Y2ggKGV2ZW50LlJlcXVlc3RUeXBlKSB7XG4gICAgICBjYXNlICdDcmVhdGUnOlxuICAgICAgY2FzZSAnVXBkYXRlJzpcbiAgICAgICAgY29uc29sZS5pbmZvKFxuICAgICAgICAgIGBTZXR0aW5nIHN0YWNrIHJlZmVyZW5jZSBmb3IgYXBwSWQ9JHtwcm9wcy5hcHBJZH0sYnJhbmNoTmFtZT0ke3Byb3BzLmJyYW5jaE5hbWV9IHRvICR7ZXZlbnQuU3RhY2tJZH1gXG4gICAgICAgICk7XG4gICAgICAgIGF3YWl0IHRoaXMudXBkYXRlT3JVbnNldFN0YWNrUmVmZXJlbmNlKFxuICAgICAgICAgIHByb3BzLmFwcElkLFxuICAgICAgICAgIHByb3BzLmJyYW5jaE5hbWUsXG4gICAgICAgICAgZXZlbnQuU3RhY2tJZFxuICAgICAgICApO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgJ0RlbGV0ZSc6XG4gICAgICAgIGNvbnNvbGUuaW5mbyhcbiAgICAgICAgICBgVW4tc2V0dGluZyBzdGFjayByZWZlcmVuY2UgZm9yIGFwcElkPSR7cHJvcHMuYXBwSWR9LGJyYW5jaE5hbWU9JHtwcm9wcy5icmFuY2hOYW1lfWBcbiAgICAgICAgKTtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICBhd2FpdCB0aGlzLnVwZGF0ZU9yVW5zZXRTdGFja1JlZmVyZW5jZShcbiAgICAgICAgICAgIHByb3BzLmFwcElkLFxuICAgICAgICAgICAgcHJvcHMuYnJhbmNoTmFtZSxcbiAgICAgICAgICAgIHVuZGVmaW5lZFxuICAgICAgICAgICk7XG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICBpZiAoZSBpbnN0YW5jZW9mIE5vdEZvdW5kRXhjZXB0aW9uKSB7XG4gICAgICAgICAgICBjb25zb2xlLmluZm8oXG4gICAgICAgICAgICAgIGBCcmFuY2ggYnJhbmNoTmFtZT0ke3Byb3BzLmJyYW5jaE5hbWV9IG9mIGFwcElkPSR7cHJvcHMuYXBwSWR9IHdhcyBub3QgZm91bmQgd2hpbGUgaGFuZGxpbmcgZGVsZXRlIGV2ZW50YFxuICAgICAgICAgICAgKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhyb3cgZTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgYnJlYWs7XG4gICAgfVxuXG4gICAgcmV0dXJuIHtcbiAgICAgIFJlcXVlc3RJZDogZXZlbnQuUmVxdWVzdElkLFxuICAgICAgTG9naWNhbFJlc291cmNlSWQ6IGV2ZW50LkxvZ2ljYWxSZXNvdXJjZUlkLFxuICAgICAgUGh5c2ljYWxSZXNvdXJjZUlkOiBwaHlzaWNhbElkLFxuICAgICAgU3RhY2tJZDogZXZlbnQuU3RhY2tJZCxcbiAgICAgIFN0YXR1czogJ1NVQ0NFU1MnLFxuICAgIH0gYXMgQ2xvdWRGb3JtYXRpb25DdXN0b21SZXNvdXJjZVN1Y2Nlc3NSZXNwb25zZTtcbiAgfTtcblxuICBwcml2YXRlIHVwZGF0ZU9yVW5zZXRTdGFja1JlZmVyZW5jZSA9IGFzeW5jIChcbiAgICBhcHBJZDogc3RyaW5nLFxuICAgIGJyYW5jaE5hbWU6IHN0cmluZyxcbiAgICBzdGFja0lkOiBzdHJpbmcgfCB1bmRlZmluZWRcbiAgKTogUHJvbWlzZTx2b2lkPiA9PiB7XG4gICAgLy8gU3RhY2sgaWQgaXMgaW4gQVJOIGZvcm1hdC5cbiAgICBpZiAoc3RhY2tJZCAmJiAhc3RhY2tJZD8uc3RhcnRzV2l0aCgnYXJuOicpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYFByb3ZpZGVkIHN0YWNrSWQgJHtzdGFja0lkfSBpcyBub3QgaW4gQVJOIGZvcm1hdGApO1xuICAgIH1cblxuICAgIGNvbnN0IGJyYW5jaDogQnJhbmNoID0gYXdhaXQgdGhpcy5nZXRCcmFuY2goYXBwSWQsIGJyYW5jaE5hbWUpO1xuICAgIGNvbnNvbGUuaW5mbyhgUmVjZWl2ZWQgYnJhbmNoIGRldGFpbHMgJHtKU09OLnN0cmluZ2lmeShicmFuY2gpfWApO1xuICAgIC8vIFBvcHVsYXRlIHVwZGF0ZSBjb21tYW5kIGlucHV0IHdpdGggZXhpc3RpbmcgdmFsdWVzLCBzbyB3ZSBkb24ndCBsb3NlIHRoZW0uXG4gICAgY29uc3QgdXBkYXRlQnJhbmNoQ29tbWFuZElucHV0OiBVcGRhdGVCcmFuY2hDb21tYW5kSW5wdXQgPSB7XG4gICAgICBhcHBJZCxcbiAgICAgIC4uLmJyYW5jaCxcbiAgICB9O1xuXG4gICAgLy8gVGhpcyBpcyBhIGtub3duIGJ1ZyBpbiB0aGUgc2VydmljZS4gSS5lLiBicmFuY2ggY2FuIGJlIGNyZWF0ZWQgd2l0aG91dCBzdGFnZVxuICAgIC8vIGJ1dCBzZXJ2aWNlIHJldHVybnMgJ05PTkUnIGluc3RlYWQgb2YgdW5kZWZpbmVkIHdoaWNoIGlzIG5vdCBwYXJ0IG9mXG4gICAgLy8gU3RhZ2UgZW51bS4uLlxuICAgIGlmICgodXBkYXRlQnJhbmNoQ29tbWFuZElucHV0LnN0YWdlIGFzIHN0cmluZykgPT09ICdOT05FJykge1xuICAgICAgdXBkYXRlQnJhbmNoQ29tbWFuZElucHV0LnN0YWdlID0gdW5kZWZpbmVkO1xuICAgIH1cblxuICAgIC8vIFNldCBvciB1bnNldCBzdGFja0lkXG4gICAgaWYgKHN0YWNrSWQpIHtcbiAgICAgIGlmICghdXBkYXRlQnJhbmNoQ29tbWFuZElucHV0LmJhY2tlbmQpIHtcbiAgICAgICAgdXBkYXRlQnJhbmNoQ29tbWFuZElucHV0LmJhY2tlbmQgPSB7fTtcbiAgICAgIH1cbiAgICAgIHVwZGF0ZUJyYW5jaENvbW1hbmRJbnB1dC5iYWNrZW5kLnN0YWNrQXJuID0gc3RhY2tJZDtcbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKHVwZGF0ZUJyYW5jaENvbW1hbmRJbnB1dC5iYWNrZW5kPy5zdGFja0Fybikge1xuICAgICAgICBkZWxldGUgdXBkYXRlQnJhbmNoQ29tbWFuZElucHV0LmJhY2tlbmQuc3RhY2tBcm47XG4gICAgICB9XG4gICAgfVxuXG4gICAgY29uc29sZS5pbmZvKFxuICAgICAgYFNlbmRpbmcgYnJhbmNoIHVwZGF0ZSAke0pTT04uc3RyaW5naWZ5KHVwZGF0ZUJyYW5jaENvbW1hbmRJbnB1dCl9YFxuICAgICk7XG4gICAgYXdhaXQgdGhpcy5hbXBsaWZ5Q2xpZW50LnNlbmQoXG4gICAgICBuZXcgVXBkYXRlQnJhbmNoQ29tbWFuZCh1cGRhdGVCcmFuY2hDb21tYW5kSW5wdXQpXG4gICAgKTtcbiAgfTtcblxuICBwcml2YXRlIGdldEJyYW5jaCA9IGFzeW5jIChcbiAgICBhcHBJZDogc3RyaW5nLFxuICAgIGJyYW5jaE5hbWU6IHN0cmluZ1xuICApOiBQcm9taXNlPEJyYW5jaD4gPT4ge1xuICAgIGNvbnN0IGJyYW5jaDogQnJhbmNoIHwgdW5kZWZpbmVkID0gKFxuICAgICAgYXdhaXQgdGhpcy5hbXBsaWZ5Q2xpZW50LnNlbmQobmV3IEdldEJyYW5jaENvbW1hbmQoeyBhcHBJZCwgYnJhbmNoTmFtZSB9KSlcbiAgICApLmJyYW5jaDtcbiAgICBpZiAoIWJyYW5jaCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBVbmFibGUgdG8gZ2V0IGJyYW5jaCAke2JyYW5jaE5hbWV9IGZvciBhcHAgJHthcHBJZH1gKTtcbiAgICB9XG4gICAgcmV0dXJuIGJyYW5jaDtcbiAgfTtcbn1cblxuY29uc3QgY3VzdG9tUmVzb3VyY2VFdmVudEhhbmRsZXIgPVxuICBuZXcgQW1wbGlmeUJyYW5jaExpbmtlckN1c3RvbVJlc291cmNlRXZlbnRIYW5kbGVyKG5ldyBBbXBsaWZ5Q2xpZW50KCkpO1xuXG4vKipcbiAqIEVudHJ5IHBvaW50IGZvciB0aGUgbGFtYmRhLWJhY2tlbmQgY3VzdG9tIHJlc291cmNlIHRvIGxpbmsgZGVwbG95bWVudCB0byBicmFuY2guXG4gKi9cbmV4cG9ydCBjb25zdCBoYW5kbGVyID0gKFxuICBldmVudDogQ2xvdWRGb3JtYXRpb25DdXN0b21SZXNvdXJjZUV2ZW50XG4pOiBQcm9taXNlPENsb3VkRm9ybWF0aW9uQ3VzdG9tUmVzb3VyY2VTdWNjZXNzUmVzcG9uc2U+ID0+IHtcbiAgcmV0dXJuIGN1c3RvbVJlc291cmNlRXZlbnRIYW5kbGVyLmhhbmRsZUN1c3RvbVJlc291cmNlRXZlbnQoZXZlbnQpO1xufTtcbiJdfQ==