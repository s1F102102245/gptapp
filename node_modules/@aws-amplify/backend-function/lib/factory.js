import { AmplifyLambdaFunction, } from '@aws-amplify/function-construct-alpha';
import { execaCommand } from 'execa';
import * as path from 'path';
import { getCallerDirectory } from './get_caller_directory.js';
/**
 * Create Lambda functions in the context of an Amplify backend definition
 */
export class AmplifyFunctionFactory {
    props;
    // execaCommand is assigned to a static prop so that it can be mocked in tests
    static commandExecutor = execaCommand;
    generator;
    /**
     * Create a new AmplifyFunctionFactory
     */
    constructor(props) {
        this.props = props;
    }
    /**
     * Create a function from a directory that contains pre-built code
     */
    static fromDir = (props) => {
        const absoluteCodePath = path.isAbsolute(props.codePath)
            ? props.codePath
            : path.resolve(getCallerDirectory(new Error().stack), props.codePath);
        return new AmplifyFunctionFactory({
            name: props.name,
            absoluteCodePath,
            runtime: props.runtime,
            handler: props.handler,
        });
    };
    /**
     * Create a function by executing a build command that places build artifacts at a specified location
     *
     * TODO: Investigate long-term function building strategy: https://github.com/aws-amplify/amplify-backend/issues/92
     */
    static build = async (props) => {
        const importPath = getCallerDirectory(new Error().stack);
        await AmplifyFunctionFactory.commandExecutor(props.buildCommand, {
            cwd: importPath,
            stdio: 'inherit',
            shell: 'bash',
        });
        const absoluteCodePath = path.isAbsolute(props.outDir)
            ? props.outDir
            : path.resolve(importPath, props.outDir);
        return new AmplifyFunctionFactory({
            name: props.name,
            absoluteCodePath,
            runtime: props.runtime,
            handler: props.handler,
        });
    };
    /**
     * Creates an instance of AmplifyFunction within the provided Amplify context
     */
    getInstance = ({ constructContainer, }) => {
        if (!this.generator) {
            this.generator = new AmplifyFunctionGenerator(this.props);
        }
        return constructContainer.getOrCompute(this.generator);
    };
}
class AmplifyFunctionGenerator {
    props;
    resourceGroupName = 'function';
    constructor(props) {
        this.props = props;
    }
    generateContainerEntry = (scope) => {
        return new AmplifyLambdaFunction(scope, this.props.name, this.props);
    };
}
/**
 * Alias for AmplifyFunctionFactory
 */
export const Func = AmplifyFunctionFactory;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmFjdG9yeS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9mYWN0b3J5LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUtBLE9BQU8sRUFFTCxxQkFBcUIsR0FDdEIsTUFBTSx1Q0FBdUMsQ0FBQztBQUUvQyxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sT0FBTyxDQUFDO0FBQ3JDLE9BQU8sS0FBSyxJQUFJLE1BQU0sTUFBTSxDQUFDO0FBQzdCLE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLDJCQUEyQixDQUFDO0FBcUMvRDs7R0FFRztBQUNILE1BQU0sT0FBTyxzQkFBc0I7SUFVSTtJQVByQyw4RUFBOEU7SUFDdEUsTUFBTSxDQUFDLGVBQWUsR0FBRyxZQUFZLENBQUM7SUFFdEMsU0FBUyxDQUFtQztJQUNwRDs7T0FFRztJQUNILFlBQXFDLEtBQWtDO1FBQWxDLFVBQUssR0FBTCxLQUFLLENBQTZCO0lBQUcsQ0FBQztJQUUzRTs7T0FFRztJQUNILE1BQU0sQ0FBQyxPQUFPLEdBQUcsQ0FDZixLQUF5QyxFQUNqQixFQUFFO1FBQzFCLE1BQU0sZ0JBQWdCLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDO1lBQ3RELENBQUMsQ0FBQyxLQUFLLENBQUMsUUFBUTtZQUNoQixDQUFDLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxrQkFBa0IsQ0FBQyxJQUFJLEtBQUssRUFBRSxDQUFDLEtBQUssQ0FBQyxFQUFFLEtBQUssQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUN4RSxPQUFPLElBQUksc0JBQXNCLENBQUM7WUFDaEMsSUFBSSxFQUFFLEtBQUssQ0FBQyxJQUFJO1lBQ2hCLGdCQUFnQjtZQUNoQixPQUFPLEVBQUUsS0FBSyxDQUFDLE9BQU87WUFDdEIsT0FBTyxFQUFFLEtBQUssQ0FBQyxPQUFPO1NBQ3ZCLENBQUMsQ0FBQztJQUNMLENBQUMsQ0FBQztJQUVGOzs7O09BSUc7SUFDSCxNQUFNLENBQUMsS0FBSyxHQUFHLEtBQUssRUFDbEIsS0FBdUMsRUFDTixFQUFFO1FBQ25DLE1BQU0sVUFBVSxHQUFHLGtCQUFrQixDQUFDLElBQUksS0FBSyxFQUFFLENBQUMsS0FBSyxDQUFDLENBQUM7UUFFekQsTUFBTSxzQkFBc0IsQ0FBQyxlQUFlLENBQUMsS0FBSyxDQUFDLFlBQVksRUFBRTtZQUMvRCxHQUFHLEVBQUUsVUFBVTtZQUNmLEtBQUssRUFBRSxTQUFTO1lBQ2hCLEtBQUssRUFBRSxNQUFNO1NBQ2QsQ0FBQyxDQUFDO1FBRUgsTUFBTSxnQkFBZ0IsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUM7WUFDcEQsQ0FBQyxDQUFDLEtBQUssQ0FBQyxNQUFNO1lBQ2QsQ0FBQyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsVUFBVSxFQUFFLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUUzQyxPQUFPLElBQUksc0JBQXNCLENBQUM7WUFDaEMsSUFBSSxFQUFFLEtBQUssQ0FBQyxJQUFJO1lBQ2hCLGdCQUFnQjtZQUNoQixPQUFPLEVBQUUsS0FBSyxDQUFDLE9BQU87WUFDdEIsT0FBTyxFQUFFLEtBQUssQ0FBQyxPQUFPO1NBQ3ZCLENBQUMsQ0FBQztJQUNMLENBQUMsQ0FBQztJQUVGOztPQUVHO0lBQ0gsV0FBVyxHQUFHLENBQUMsRUFDYixrQkFBa0IsR0FDZSxFQUF5QixFQUFFO1FBQzVELElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFO1lBQ25CLElBQUksQ0FBQyxTQUFTLEdBQUcsSUFBSSx3QkFBd0IsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7U0FDM0Q7UUFDRCxPQUFPLGtCQUFrQixDQUFDLFlBQVksQ0FDcEMsSUFBSSxDQUFDLFNBQVMsQ0FDVSxDQUFDO0lBQzdCLENBQUMsQ0FBQzs7QUFHSixNQUFNLHdCQUF3QjtJQUdDO0lBRnBCLGlCQUFpQixHQUFHLFVBQVUsQ0FBQztJQUV4QyxZQUE2QixLQUFrQztRQUFsQyxVQUFLLEdBQUwsS0FBSyxDQUE2QjtJQUFHLENBQUM7SUFFbkUsc0JBQXNCLEdBQUcsQ0FBQyxLQUFnQixFQUFFLEVBQUU7UUFDNUMsT0FBTyxJQUFJLHFCQUFxQixDQUFDLEtBQUssRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDdkUsQ0FBQyxDQUFDO0NBQ0g7QUFFRDs7R0FFRztBQUNILE1BQU0sQ0FBQyxNQUFNLElBQUksR0FBRyxzQkFBc0IsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIENvbnN0cnVjdENvbnRhaW5lckVudHJ5R2VuZXJhdG9yLFxuICBDb25zdHJ1Y3RGYWN0b3J5LFxuICBDb25zdHJ1Y3RGYWN0b3J5R2V0SW5zdGFuY2VQcm9wcyxcbn0gZnJvbSAnQGF3cy1hbXBsaWZ5L3BsdWdpbi10eXBlcyc7XG5pbXBvcnQge1xuICBBbXBsaWZ5RnVuY3Rpb25Qcm9wcyxcbiAgQW1wbGlmeUxhbWJkYUZ1bmN0aW9uLFxufSBmcm9tICdAYXdzLWFtcGxpZnkvZnVuY3Rpb24tY29uc3RydWN0LWFscGhhJztcbmltcG9ydCB7IENvbnN0cnVjdCB9IGZyb20gJ2NvbnN0cnVjdHMnO1xuaW1wb3J0IHsgZXhlY2FDb21tYW5kIH0gZnJvbSAnZXhlY2EnO1xuaW1wb3J0ICogYXMgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB7IGdldENhbGxlckRpcmVjdG9yeSB9IGZyb20gJy4vZ2V0X2NhbGxlcl9kaXJlY3RvcnkuanMnO1xuXG5leHBvcnQgdHlwZSBBbXBsaWZ5RnVuY3Rpb25GYWN0b3J5QmFzZVByb3BzID0ge1xuICAvKipcbiAgICogQSBuYW1lIGZvciB0aGUgZnVuY3Rpb24gdGhhdCBpcyB1c2VkIHRvIGRpc2FtYmlndWF0ZSBpdCBmcm9tIG90aGVyIGZ1bmN0aW9ucyBpbiB0aGUgcHJvamVjdFxuICAgKi9cbiAgbmFtZTogc3RyaW5nO1xufTtcblxuZXhwb3J0IHR5cGUgQW1wbGlmeUZ1bmN0aW9uRmFjdG9yeUJ1aWxkUHJvcHMgPSBBbXBsaWZ5RnVuY3Rpb25GYWN0b3J5QmFzZVByb3BzICZcbiAgT21pdDxBbXBsaWZ5RnVuY3Rpb25Qcm9wcywgJ2Fic29sdXRlQ29kZVBhdGgnPiAmIHtcbiAgICAvKipcbiAgICAgKiBUaGUgY29tbWFuZCB0byBydW4gdGhhdCBnZW5lcmF0ZXMgYnVpbHQgZnVuY3Rpb24gY29kZS5cbiAgICAgKiBUaGlzIGNvbW1hbmQgaXMgcnVuIGZyb20gdGhlIGRpcmVjdG9yeSB3aGVyZSB0aGlzIGZhY3RvcnkgaXMgY2FsbGVkXG4gICAgICovXG4gICAgYnVpbGRDb21tYW5kOiBzdHJpbmc7XG4gICAgLyoqXG4gICAgICogVGhlIGJ1aWxkQ29tbWFuZCBpcyBleHBlY3RlZCB0byBwbGFjZSBidWlsZCBhcnRpZmFjdHMgYXQgdGhpcyBsb2NhdGlvbi5cbiAgICAgKiBUaGlzIHBhdGggY2FuIGJlIHJlbGF0aXZlIG9yIGFic29sdXRlLiBJZiByZWxhdGl2ZSwgdGhlIGFic29sdXRlIHBhdGggaXMgY2FsY3VsYXRlZCBiYXNlZCBvbiB0aGUgZGlyZWN0b3J5IHdoZXJlIHRoaXMgZmFjdG9yeSBpcyBjYWxsZWRcbiAgICAgKi9cbiAgICBvdXREaXI6IHN0cmluZztcbiAgfTtcblxuZXhwb3J0IHR5cGUgQW1wbGlmeUZ1bmN0aW9uRmFjdG9yeUZyb21EaXJQcm9wcyA9XG4gIEFtcGxpZnlGdW5jdGlvbkZhY3RvcnlCYXNlUHJvcHMgJlxuICAgIE9taXQ8QW1wbGlmeUZ1bmN0aW9uUHJvcHMsICdhYnNvbHV0ZUNvZGVQYXRoJz4gJiB7XG4gICAgICAvKipcbiAgICAgICAqIFRoZSBsb2NhdGlvbiBvZiB0aGUgcHJlLWJ1aWx0IGZ1bmN0aW9uIGNvZGUuXG4gICAgICAgKiBDYW4gYmUgYSBkaXJlY3Rvcnkgb3IgYSAuemlwIGZpbGUuXG4gICAgICAgKiBDYW4gYmUgYSByZWxhdGl2ZSBvciBhYnNvbHV0ZSBwYXRoLiBJZiByZWxhdGl2ZSwgdGhlIGFic29sdXRlIHBhdGggaXMgY2FsY3VsYXRlZCBiYXNlZCBvbiB0aGUgZGlyZWN0b3J5IHdoZXJlIHRoaXMgZmFjdG9yeSBpcyBjYWxsZWQuXG4gICAgICAgKi9cbiAgICAgIGNvZGVQYXRoOiBzdHJpbmc7XG4gICAgfTtcblxudHlwZSBBbXBsaWZ5RnVuY3Rpb25GYWN0b3J5UHJvcHMgPSBBbXBsaWZ5RnVuY3Rpb25GYWN0b3J5QmFzZVByb3BzICZcbiAgQW1wbGlmeUZ1bmN0aW9uUHJvcHM7XG5cbi8qKlxuICogQ3JlYXRlIExhbWJkYSBmdW5jdGlvbnMgaW4gdGhlIGNvbnRleHQgb2YgYW4gQW1wbGlmeSBiYWNrZW5kIGRlZmluaXRpb25cbiAqL1xuZXhwb3J0IGNsYXNzIEFtcGxpZnlGdW5jdGlvbkZhY3RvcnlcbiAgaW1wbGVtZW50cyBDb25zdHJ1Y3RGYWN0b3J5PEFtcGxpZnlMYW1iZGFGdW5jdGlvbj5cbntcbiAgLy8gZXhlY2FDb21tYW5kIGlzIGFzc2lnbmVkIHRvIGEgc3RhdGljIHByb3Agc28gdGhhdCBpdCBjYW4gYmUgbW9ja2VkIGluIHRlc3RzXG4gIHByaXZhdGUgc3RhdGljIGNvbW1hbmRFeGVjdXRvciA9IGV4ZWNhQ29tbWFuZDtcblxuICBwcml2YXRlIGdlbmVyYXRvcjogQ29uc3RydWN0Q29udGFpbmVyRW50cnlHZW5lcmF0b3I7XG4gIC8qKlxuICAgKiBDcmVhdGUgYSBuZXcgQW1wbGlmeUZ1bmN0aW9uRmFjdG9yeVxuICAgKi9cbiAgcHJpdmF0ZSBjb25zdHJ1Y3Rvcihwcml2YXRlIHJlYWRvbmx5IHByb3BzOiBBbXBsaWZ5RnVuY3Rpb25GYWN0b3J5UHJvcHMpIHt9XG5cbiAgLyoqXG4gICAqIENyZWF0ZSBhIGZ1bmN0aW9uIGZyb20gYSBkaXJlY3RvcnkgdGhhdCBjb250YWlucyBwcmUtYnVpbHQgY29kZVxuICAgKi9cbiAgc3RhdGljIGZyb21EaXIgPSAoXG4gICAgcHJvcHM6IEFtcGxpZnlGdW5jdGlvbkZhY3RvcnlGcm9tRGlyUHJvcHNcbiAgKTogQW1wbGlmeUZ1bmN0aW9uRmFjdG9yeSA9PiB7XG4gICAgY29uc3QgYWJzb2x1dGVDb2RlUGF0aCA9IHBhdGguaXNBYnNvbHV0ZShwcm9wcy5jb2RlUGF0aClcbiAgICAgID8gcHJvcHMuY29kZVBhdGhcbiAgICAgIDogcGF0aC5yZXNvbHZlKGdldENhbGxlckRpcmVjdG9yeShuZXcgRXJyb3IoKS5zdGFjayksIHByb3BzLmNvZGVQYXRoKTtcbiAgICByZXR1cm4gbmV3IEFtcGxpZnlGdW5jdGlvbkZhY3Rvcnkoe1xuICAgICAgbmFtZTogcHJvcHMubmFtZSxcbiAgICAgIGFic29sdXRlQ29kZVBhdGgsXG4gICAgICBydW50aW1lOiBwcm9wcy5ydW50aW1lLFxuICAgICAgaGFuZGxlcjogcHJvcHMuaGFuZGxlcixcbiAgICB9KTtcbiAgfTtcblxuICAvKipcbiAgICogQ3JlYXRlIGEgZnVuY3Rpb24gYnkgZXhlY3V0aW5nIGEgYnVpbGQgY29tbWFuZCB0aGF0IHBsYWNlcyBidWlsZCBhcnRpZmFjdHMgYXQgYSBzcGVjaWZpZWQgbG9jYXRpb25cbiAgICpcbiAgICogVE9ETzogSW52ZXN0aWdhdGUgbG9uZy10ZXJtIGZ1bmN0aW9uIGJ1aWxkaW5nIHN0cmF0ZWd5OiBodHRwczovL2dpdGh1Yi5jb20vYXdzLWFtcGxpZnkvYW1wbGlmeS1iYWNrZW5kL2lzc3Vlcy85MlxuICAgKi9cbiAgc3RhdGljIGJ1aWxkID0gYXN5bmMgKFxuICAgIHByb3BzOiBBbXBsaWZ5RnVuY3Rpb25GYWN0b3J5QnVpbGRQcm9wc1xuICApOiBQcm9taXNlPEFtcGxpZnlGdW5jdGlvbkZhY3Rvcnk+ID0+IHtcbiAgICBjb25zdCBpbXBvcnRQYXRoID0gZ2V0Q2FsbGVyRGlyZWN0b3J5KG5ldyBFcnJvcigpLnN0YWNrKTtcblxuICAgIGF3YWl0IEFtcGxpZnlGdW5jdGlvbkZhY3RvcnkuY29tbWFuZEV4ZWN1dG9yKHByb3BzLmJ1aWxkQ29tbWFuZCwge1xuICAgICAgY3dkOiBpbXBvcnRQYXRoLFxuICAgICAgc3RkaW86ICdpbmhlcml0JyxcbiAgICAgIHNoZWxsOiAnYmFzaCcsXG4gICAgfSk7XG5cbiAgICBjb25zdCBhYnNvbHV0ZUNvZGVQYXRoID0gcGF0aC5pc0Fic29sdXRlKHByb3BzLm91dERpcilcbiAgICAgID8gcHJvcHMub3V0RGlyXG4gICAgICA6IHBhdGgucmVzb2x2ZShpbXBvcnRQYXRoLCBwcm9wcy5vdXREaXIpO1xuXG4gICAgcmV0dXJuIG5ldyBBbXBsaWZ5RnVuY3Rpb25GYWN0b3J5KHtcbiAgICAgIG5hbWU6IHByb3BzLm5hbWUsXG4gICAgICBhYnNvbHV0ZUNvZGVQYXRoLFxuICAgICAgcnVudGltZTogcHJvcHMucnVudGltZSxcbiAgICAgIGhhbmRsZXI6IHByb3BzLmhhbmRsZXIsXG4gICAgfSk7XG4gIH07XG5cbiAgLyoqXG4gICAqIENyZWF0ZXMgYW4gaW5zdGFuY2Ugb2YgQW1wbGlmeUZ1bmN0aW9uIHdpdGhpbiB0aGUgcHJvdmlkZWQgQW1wbGlmeSBjb250ZXh0XG4gICAqL1xuICBnZXRJbnN0YW5jZSA9ICh7XG4gICAgY29uc3RydWN0Q29udGFpbmVyLFxuICB9OiBDb25zdHJ1Y3RGYWN0b3J5R2V0SW5zdGFuY2VQcm9wcyk6IEFtcGxpZnlMYW1iZGFGdW5jdGlvbiA9PiB7XG4gICAgaWYgKCF0aGlzLmdlbmVyYXRvcikge1xuICAgICAgdGhpcy5nZW5lcmF0b3IgPSBuZXcgQW1wbGlmeUZ1bmN0aW9uR2VuZXJhdG9yKHRoaXMucHJvcHMpO1xuICAgIH1cbiAgICByZXR1cm4gY29uc3RydWN0Q29udGFpbmVyLmdldE9yQ29tcHV0ZShcbiAgICAgIHRoaXMuZ2VuZXJhdG9yXG4gICAgKSBhcyBBbXBsaWZ5TGFtYmRhRnVuY3Rpb247XG4gIH07XG59XG5cbmNsYXNzIEFtcGxpZnlGdW5jdGlvbkdlbmVyYXRvciBpbXBsZW1lbnRzIENvbnN0cnVjdENvbnRhaW5lckVudHJ5R2VuZXJhdG9yIHtcbiAgcmVhZG9ubHkgcmVzb3VyY2VHcm91cE5hbWUgPSAnZnVuY3Rpb24nO1xuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgcmVhZG9ubHkgcHJvcHM6IEFtcGxpZnlGdW5jdGlvbkZhY3RvcnlQcm9wcykge31cblxuICBnZW5lcmF0ZUNvbnRhaW5lckVudHJ5ID0gKHNjb3BlOiBDb25zdHJ1Y3QpID0+IHtcbiAgICByZXR1cm4gbmV3IEFtcGxpZnlMYW1iZGFGdW5jdGlvbihzY29wZSwgdGhpcy5wcm9wcy5uYW1lLCB0aGlzLnByb3BzKTtcbiAgfTtcbn1cblxuLyoqXG4gKiBBbGlhcyBmb3IgQW1wbGlmeUZ1bmN0aW9uRmFjdG9yeVxuICovXG5leHBvcnQgY29uc3QgRnVuYyA9IEFtcGxpZnlGdW5jdGlvbkZhY3Rvcnk7XG4iXX0=