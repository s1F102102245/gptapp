"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.LocalConfigurationController = void 0;
const os_1 = __importDefault(require("os"));
const path_1 = __importDefault(require("path"));
const promises_1 = __importDefault(require("fs/promises"));
/**
 * Used to interact with config file based on OS.
 */
class LocalConfigurationController {
    projectName;
    configFileName;
    dirPath;
    configFilePath;
    _store;
    /**
     * Initializes paths to project config dir & config file.
     */
    constructor(projectName = 'amplify', configFileName = 'config.json') {
        this.projectName = projectName;
        this.configFileName = configFileName;
        this.dirPath = this.getConfigDirPath(this.projectName);
        this.configFilePath = path_1.default.join(this.dirPath, this.configFileName);
    }
    /**
     * Getter for cached config, retrieves config from disk if not cached already.
     * If the store is not cached & config file does not exist, it will create a blank one.
     */
    async store() {
        if (this._store) {
            return this._store;
        }
        // check if file exists & readable.
        let fd;
        try {
            fd = await promises_1.default.open(this.configFilePath, promises_1.default.constants.F_OK, promises_1.default.constants.O_RDWR);
            const fileContent = await promises_1.default.readFile(fd, 'utf-8');
            this._store = JSON.parse(fileContent);
        }
        catch {
            this._store = {};
            await this.write();
        }
        finally {
            await fd?.close();
        }
        return this._store;
    }
    /**
     * Creates project directory to store config if it doesn't exist yet.
     */
    mkConfigDir() {
        return promises_1.default.mkdir(this.dirPath, { recursive: true });
    }
    /**
     * Gets values from cached config by path.
     */
    async get(path) {
        return path
            .split('.')
            .reduce((acc, current) => {
            return acc?.[current];
        }, await this.store());
    }
    /**
     * Set value by path & update config file to disk.
     */
    async set(path, value) {
        let current = await this.store();
        path.split('.').forEach((key, index, keys) => {
            if (index === keys.length - 1) {
                current[key] = value;
            }
            else {
                if (current[key] == null) {
                    current[key] = {};
                }
                current = current[key];
            }
        });
        await this.write();
    }
    /**
     * Writes config file to disk if found.
     */
    async write() {
        // creates project directory if it doesn't exist.
        await this.mkConfigDir();
        const output = JSON.stringify(this._store ? this._store : {});
        await promises_1.default.writeFile(this.configFilePath, output, 'utf8');
    }
    /**
     * Reset cached config and delete the config file.
     */
    async clear() {
        this._store = {};
        await promises_1.default.rm(this.configFilePath);
    }
    /**
     * Returns the path to config directory depending on OS
     */
    getConfigDirPath(name) {
        const homedir = os_1.default.homedir();
        const macos = () => path_1.default.join(homedir, 'Library', 'Preferences', name);
        const windows = () => {
            return path_1.default.join(process.env.APPDATA || path_1.default.join(homedir, 'AppData', 'Roaming'), name, 'Config');
        };
        const linux = () => {
            return path_1.default.join(process.env.XDG_STATE_HOME || path_1.default.join(homedir, '.local', 'state'), name);
        };
        switch (process.platform) {
            case 'darwin':
                return macos();
            case 'win32':
                return windows();
            default:
                return linux();
        }
    }
}
exports.LocalConfigurationController = LocalConfigurationController;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibG9jYWxfY29uZmlndXJhdGlvbl9jb250cm9sbGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL2NvbmZpZy9sb2NhbF9jb25maWd1cmF0aW9uX2NvbnRyb2xsZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUEsNENBQW9CO0FBQ3BCLGdEQUF3QjtBQUN4QiwyREFBNkI7QUFHN0I7O0dBRUc7QUFDSCxNQUFhLDRCQUE0QjtJQVNwQjtJQUNBO0lBVG5CLE9BQU8sQ0FBUztJQUNoQixjQUFjLENBQVM7SUFDdkIsTUFBTSxDQUEwQjtJQUVoQzs7T0FFRztJQUNILFlBQ21CLGNBQWMsU0FBUyxFQUN2QixpQkFBaUIsYUFBYTtRQUQ5QixnQkFBVyxHQUFYLFdBQVcsQ0FBWTtRQUN2QixtQkFBYyxHQUFkLGNBQWMsQ0FBZ0I7UUFFL0MsSUFBSSxDQUFDLE9BQU8sR0FBRyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDO1FBQ3ZELElBQUksQ0FBQyxjQUFjLEdBQUcsY0FBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLElBQUksQ0FBQyxjQUFjLENBQUMsQ0FBQztJQUNyRSxDQUFDO0lBRUQ7OztPQUdHO0lBQ0ssS0FBSyxDQUFDLEtBQUs7UUFDakIsSUFBSSxJQUFJLENBQUMsTUFBTSxFQUFFO1lBQ2YsT0FBTyxJQUFJLENBQUMsTUFBTSxDQUFDO1NBQ3BCO1FBQ0QsbUNBQW1DO1FBQ25DLElBQUksRUFBRSxDQUFDO1FBRVAsSUFBSTtZQUNGLEVBQUUsR0FBRyxNQUFNLGtCQUFFLENBQUMsSUFBSSxDQUNoQixJQUFJLENBQUMsY0FBYyxFQUNuQixrQkFBRSxDQUFDLFNBQVMsQ0FBQyxJQUFJLEVBQ2pCLGtCQUFFLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FDcEIsQ0FBQztZQUNGLE1BQU0sV0FBVyxHQUFHLE1BQU0sa0JBQUUsQ0FBQyxRQUFRLENBQUMsRUFBRSxF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T0FBTyxJQUFJLGNBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLFNBQVMsRUFBRSxTQUFTLENBQUMsRUFDL0QsSUFBSSxFQUNKLFFBQVEsQ0FDVCxDQUFDO1FBQ0osQ0FBQyxDQUFDO1FBQ0YsTUFBTSxLQUFLLEdBQUcsR0FBRyxFQUFFO1lBQ2pCLE9BQU8sY0FBSSxDQUFDLElBQUksQ0FDZCxPQUFPLENBQUMsR0FBRyxDQUFDLGNBQWMsSUFBSSxjQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRSxRQUFRLEVBQUUsT0FBTyxDQUFDLEVBQ25FLElBQUksQ0FDTCxDQUFDO1FBQ0osQ0FBQyxDQUFDO1FBRUYsUUFBUSxPQUFPLENBQUMsUUFBUSxFQUFFO1lBQ3hCLEtBQUssUUFBUTtnQkFDWCxPQUFPLEtBQUssRUFBRSxDQUFDO1lBQ2pCLEtBQUssT0FBTztnQkFDVixPQUFPLE9BQU8sRUFBRSxDQUFDO1lBQ25CO2dCQUNFLE9BQU8sS0FBSyxFQUFFLENBQUM7U0FDbEI7SUFDSCxDQUFDO0NBQ0Y7QUFuSUQsb0VBbUlDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IG9zIGZyb20gJ29zJztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IGZzIGZyb20gJ2ZzL3Byb21pc2VzJztcbmltcG9ydCB7IENvbmZpZ3VyYXRpb25Db250cm9sbGVyIH0gZnJvbSAnLi9sb2NhbF9jb25maWd1cmF0aW9uX2NvbnRyb2xsZXJfZmFjdG9yeSc7XG5cbi8qKlxuICogVXNlZCB0byBpbnRlcmFjdCB3aXRoIGNvbmZpZyBmaWxlIGJhc2VkIG9uIE9TLlxuICovXG5leHBvcnQgY2xhc3MgTG9jYWxDb25maWd1cmF0aW9uQ29udHJvbGxlciBpbXBsZW1lbnRzIENvbmZpZ3VyYXRpb25Db250cm9sbGVyIHtcbiAgZGlyUGF0aDogc3RyaW5nO1xuICBjb25maWdGaWxlUGF0aDogc3RyaW5nO1xuICBfc3RvcmU6IFJlY29yZDxzdHJpbmcsIHVua25vd24+O1xuXG4gIC8qKlxuICAgKiBJbml0aWFsaXplcyBwYXRocyB0byBwcm9qZWN0IGNvbmZpZyBkaXIgJiBjb25maWcgZmlsZS5cbiAgICovXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgcmVhZG9ubHkgcHJvamVjdE5hbWUgPSAnYW1wbGlmeScsXG4gICAgcHJpdmF0ZSByZWFkb25seSBjb25maWdGaWxlTmFtZSA9ICdjb25maWcuanNvbidcbiAgKSB7XG4gICAgdGhpcy5kaXJQYXRoID0gdGhpcy5nZXRDb25maWdEaXJQYXRoKHRoaXMucHJvamVjdE5hbWUpO1xuICAgIHRoaXMuY29uZmlnRmlsZVBhdGggPSBwYXRoLmpvaW4odGhpcy5kaXJQYXRoLCB0aGlzLmNvbmZpZ0ZpbGVOYW1lKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXR0ZXIgZm9yIGNhY2hlZCBjb25maWcsIHJldHJpZXZlcyBjb25maWcgZnJvbSBkaXNrIGlmIG5vdCBjYWNoZWQgYWxyZWFkeS5cbiAgICogSWYgdGhlIHN0b3JlIGlzIG5vdCBjYWNoZWQgJiBjb25maWcgZmlsZSBkb2VzIG5vdCBleGlzdCwgaXQgd2lsbCBjcmVhdGUgYSBibGFuayBvbmUuXG4gICAqL1xuICBwcml2YXRlIGFzeW5jIHN0b3JlKCk6IFByb21pc2U8UmVjb3JkPHN0cmluZywgdW5rbm93bj4+IHtcbiAgICBpZiAodGhpcy5fc3RvcmUpIHtcbiAgICAgIHJldHVybiB0aGlzLl9zdG9yZTtcbiAgICB9XG4gICAgLy8gY2hlY2sgaWYgZmlsZSBleGlzdHMgJiByZWFkYWJsZS5cbiAgICBsZXQgZmQ7XG5cbiAgICB0cnkge1xuICAgICAgZmQgPSBhd2FpdCBmcy5vcGVuKFxuICAgICAgICB0aGlzLmNvbmZpZ0ZpbGVQYXRoLFxuICAgICAgICBmcy5jb25zdGFudHMuRl9PSyxcbiAgICAgICAgZnMuY29uc3RhbnRzLk9fUkRXUlxuICAgICAgKTtcbiAgICAgIGNvbnN0IGZpbGVDb250ZW50ID0gYXdhaXQgZnMucmVhZEZpbGUoZmQsICd1dGYtOCcpO1xuICAgICAgdGhpcy5fc3RvcmUgPSBKU09OLnBhcnNlKGZpbGVDb250ZW50KTtcbiAgICB9IGNhdGNoIHtcbiAgICAgIHRoaXMuX3N0b3JlID0ge307XG4gICAgICBhd2FpdCB0aGlzLndyaXRlKCk7XG4gICAgfSBmaW5hbGx5IHtcbiAgICAgIGF3YWl0IGZkPy5jbG9zZSgpO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy5fc3RvcmU7XG4gIH1cblxuICAvKipcbiAgICogQ3JlYXRlcyBwcm9qZWN0IGRpcmVjdG9yeSB0byBzdG9yZSBjb25maWcgaWYgaXQgZG9lc24ndCBleGlzdCB5ZXQuXG4gICAqL1xuICBwcml2YXRlIG1rQ29uZmlnRGlyKCkge1xuICAgIHJldHVybiBmcy5ta2Rpcih0aGlzLmRpclBhdGgsIHsgcmVjdXJzaXZlOiB0cnVlIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldHMgdmFsdWVzIGZyb20gY2FjaGVkIGNvbmZpZyBieSBwYXRoLlxuICAgKi9cbiAgYXN5bmMgZ2V0PFQ+KHBhdGg6IHN0cmluZykge1xuICAgIHJldHVybiBwYXRoXG4gICAgICAuc3BsaXQoJy4nKVxuICAgICAgLnJlZHVjZSgoYWNjOiBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPiwgY3VycmVudDogc3RyaW5nKSA9PiB7XG4gICAgICAgIHJldHVybiBhY2M/LltjdXJyZW50XSBhcyBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPjtcbiAgICAgIH0sIGF3YWl0IHRoaXMuc3RvcmUoKSkgYXMgVDtcbiAgfVxuXG4gIC8qKlxuICAgKiBTZXQgdmFsdWUgYnkgcGF0aCAmIHVwZGF0ZSBjb25maWcgZmlsZSB0byBkaXNrLlxuICAgKi9cbiAgYXN5bmMgc2V0KHBhdGg6IHN0cmluZywgdmFsdWU6IHN0cmluZyB8IGJvb2xlYW4gfCBudW1iZXIpIHtcbiAgICBsZXQgY3VycmVudDogUmVjb3JkPHN0cmluZywgdW5rbm93bj4gPSBhd2FpdCB0aGlzLnN0b3JlKCk7XG5cbiAgICBwYXRoLnNwbGl0KCcuJykuZm9yRWFjaCgoa2V5LCBpbmRleCwga2V5cykgPT4ge1xuICAgICAgaWYgKGluZGV4ID09PSBrZXlzLmxlbmd0aCAtIDEpIHtcbiAgICAgICAgY3VycmVudFtrZXldID0gdmFsdWU7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBpZiAoY3VycmVudFtrZXldID09IG51bGwpIHtcbiAgICAgICAgICBjdXJyZW50W2tleV0gPSB7fTtcbiAgICAgICAgfVxuICAgICAgICBjdXJyZW50ID0gY3VycmVudFtrZXldIGFzIFJlY29yZDxzdHJpbmcsIHVua25vd24+O1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgYXdhaXQgdGhpcy53cml0ZSgpO1xuICB9XG5cbiAgLyoqXG4gICAqIFdyaXRlcyBjb25maWcgZmlsZSB0byBkaXNrIGlmIGZvdW5kLlxuICAgKi9cbiAgYXN5bmMgd3JpdGUoKSB7XG4gICAgLy8gY3JlYXRlcyBwcm9qZWN0IGRpcmVjdG9yeSBpZiBpdCBkb2Vzbid0IGV4aXN0LlxuICAgIGF3YWl0IHRoaXMubWtDb25maWdEaXIoKTtcblxuICAgIGNvbnN0IG91dHB1dCA9IEpTT04uc3RyaW5naWZ5KHRoaXMuX3N0b3JlID8gdGhpcy5fc3RvcmUgOiB7fSk7XG4gICAgYXdhaXQgZnMud3JpdGVGaWxlKHRoaXMuY29uZmlnRmlsZVBhdGgsIG91dHB1dCwgJ3V0ZjgnKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXNldCBjYWNoZWQgY29uZmlnIGFuZCBkZWxldGUgdGhlIGNvbmZpZyBmaWxlLlxuICAgKi9cbiAgYXN5bmMgY2xlYXIoKSB7XG4gICAgdGhpcy5fc3RvcmUgPSB7fTtcbiAgICBhd2FpdCBmcy5ybSh0aGlzLmNvbmZpZ0ZpbGVQYXRoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXR1cm5zIHRoZSBwYXRoIHRvIGNvbmZpZyBkaXJlY3RvcnkgZGVwZW5kaW5nIG9uIE9TXG4gICAqL1xuICBwcml2YXRlIGdldENvbmZpZ0RpclBhdGgobmFtZTogc3RyaW5nKTogc3RyaW5nIHtcbiAgICBjb25zdCBob21lZGlyID0gb3MuaG9tZWRpcigpO1xuXG4gICAgY29uc3QgbWFjb3MgPSAoKSA9PiBwYXRoLmpvaW4oaG9tZWRpciwgJ0xpYnJhcnknLCAnUHJlZmVyZW5jZXMnLCBuYW1lKTtcbiAgICBjb25zdCB3aW5kb3dzID0gKCkgPT4ge1xuICAgICAgcmV0dXJuIHBhdGguam9pbihcbiAgICAgICAgcHJvY2Vzcy5lbnYuQVBQREFUQSB8fCBwYXRoLmpvaW4oaG9tZWRpciwgJ0FwcERhdGEnLCAnUm9hbWluZycpLFxuICAgICAgICBuYW1lLFxuICAgICAgICAnQ29uZmlnJ1xuICAgICAgKTtcbiAgICB9O1xuICAgIGNvbnN0IGxpbnV4ID0gKCkgPT4ge1xuICAgICAgcmV0dXJuIHBhdGguam9pbihcbiAgICAgICAgcHJvY2Vzcy5lbnYuWERHX1NUQVRFX0hPTUUgfHwgcGF0aC5qb2luKGhvbWVkaXIsICcubG9jYWwnLCAnc3RhdGUnKSxcbiAgICAgICAgbmFtZVxuICAgICAgKTtcbiAgICB9O1xuXG4gICAgc3dpdGNoIChwcm9jZXNzLnBsYXRmb3JtKSB7XG4gICAgICBjYXNlICdkYXJ3aW4nOlxuICAgICAgICByZXR1cm4gbWFjb3MoKTtcbiAgICAgIGNhc2UgJ3dpbjMyJzpcbiAgICAgICAgcmV0dXJuIHdpbmRvd3MoKTtcbiAgICAgIGRlZmF1bHQ6XG4gICAgICAgIHJldHVybiBsaW51eCgpO1xuICAgIH1cbiAgfVxufVxuIl19