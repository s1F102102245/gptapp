"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.DefaultUsageDataEmitter = void 0;
const uuid_1 = require("uuid");
const account_id_fetcher_js_1 = require("./account_id_fetcher.js");
const os_1 = __importDefault(require("os"));
const https_1 = __importDefault(require("https"));
const get_installation_id_js_1 = require("./get_installation_id.js");
const constants_js_1 = require("./constants.js");
const get_usage_data_url_js_1 = require("./get_usage_data_url.js");
const is_ci_1 = __importDefault(require("is-ci"));
const serializable_error_js_1 = require("./serializable_error.js");
/**
 * Entry point for sending usage data metrics
 */
class DefaultUsageDataEmitter {
    libraryVersion;
    sessionUuid;
    url;
    accountIdFetcher;
    /**
     * Constructor for UsageDataEmitter
     */
    constructor(libraryVersion, sessionUuid = (0, uuid_1.v4)(), url = (0, get_usage_data_url_js_1.getUrl)(), accountIdFetcher = new account_id_fetcher_js_1.AccountIdFetcher()) {
        this.libraryVersion = libraryVersion;
        this.sessionUuid = sessionUuid;
        this.url = url;
        this.accountIdFetcher = accountIdFetcher;
    }
    emitSuccess = async (metrics, dimensions) => {
        const data = await this.getUsageData({
            state: 'SUCCEEDED',
            metrics,
            dimensions,
        });
        await this.send(data);
    };
    emitFailure = async (error, dimensions) => {
        const data = await this.getUsageData({
            state: 'FAILED',
            error,
            dimensions,
        });
        await this.send(data);
    };
    getUsageData = async (options) => {
        return {
            accountId: await this.accountIdFetcher.fetch(),
            sessionUuid: this.sessionUuid,
            installationUuid: await (0, get_installation_id_js_1.getInstallationUuid)(),
            amplifyCliVersion: this.libraryVersion,
            timestamp: new Date().toISOString(),
            error: options.error ? new serializable_error_js_1.SerializableError(options.error) : undefined,
            downstreamException: options.error &&
                options.error.cause &&
                options.error.cause instanceof Error
                ? new serializable_error_js_1.SerializableError(options.error.cause)
                : undefined,
            payloadVersion: constants_js_1.latestPayloadVersion,
            osPlatform: os_1.default.platform(),
            osRelease: os_1.default.release(),
            nodeVersion: process.versions.node,
            state: options.state,
            codePathDurations: this.translateMetricsToUsageData(options.metrics),
            input: this.translateDimensionsToUsageData(options.dimensions),
            isCi: is_ci_1.default,
        };
    };
    send = (data) => {
        return new Promise((resolve) => {
            const payload = JSON.stringify(data);
            const req = https_1.default.request({
                hostname: this.url.hostname,
                port: this.url.port,
                path: this.url.path,
                method: 'POST',
                headers: {
                    'content-type': 'application/json',
                    'content-length': payload.length,
                },
            });
            req.on('error', () => {
                /* noop */
            });
            req.setTimeout(2000, () => {
                // 2 seconds
                resolve();
            });
            req.write(payload);
            req.end(() => {
                resolve();
            });
        });
    };
    translateMetricsToUsageData = (metrics) => {
        if (!metrics)
            return {};
        let totalDuration, platformStartup;
        for (const [name, data] of Object.entries(metrics)) {
            if (name === 'totalTime') {
                totalDuration = Math.round(data);
            }
            else if (name === 'synthesisTime') {
                platformStartup = Math.round(data);
            }
        }
        return { totalDuration, platformStartup };
    };
    translateDimensionsToUsageData = (dimensions) => {
        let command = '';
        if (dimensions) {
            for (const [name, data] of Object.entries(dimensions)) {
                if (name === 'command') {
                    command = data;
                }
            }
        }
        return { command, plugin: 'Gen2' };
    };
}
exports.DefaultUsageDataEmitter = DefaultUsageDataEmitter;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXNhZ2VfZGF0YV9lbWl0dGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL3VzYWdlLWRhdGEvdXNhZ2VfZGF0YV9lbWl0dGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7OztBQUFBLCtCQUFrQztBQUNsQyxtRUFBMkQ7QUFFM0QsNENBQW9CO0FBQ3BCLGtEQUEwQjtBQUMxQixxRUFBK0Q7QUFDL0QsaURBQXNEO0FBQ3RELG1FQUFpRDtBQUNqRCxrREFBeUI7QUFDekIsbUVBQTREO0FBRzVEOztHQUVHO0FBQ0gsTUFBYSx1QkFBdUI7SUFLZjtJQUNBO0lBQ0E7SUFDQTtJQVBuQjs7T0FFRztJQUNILFlBQ21CLGNBQXNCLEVBQ3RCLGNBQWMsSUFBQSxTQUFJLEdBQUUsRUFDcEIsTUFBTSxJQUFBLDhCQUFNLEdBQUUsRUFDZCxtQkFBbUIsSUFBSSx3Q0FBZ0IsRUFBRTtRQUh6QyxtQkFBYyxHQUFkLGNBQWMsQ0FBUTtRQUN0QixnQkFBVyxHQUFYLFdBQVcsQ0FBUztRQUNwQixRQUFHLEdBQUgsR0FBRyxDQUFXO1FBQ2QscUJBQWdCLEdBQWhCLGdCQUFnQixDQUF5QjtJQUN6RCxDQUFDO0lBRUosV0FBVyxHQUFHLEtBQUssRUFDakIsT0FBZ0MsRUFDaEMsVUFBbUMsRUFDbkMsRUFBRTtRQUNGLE1BQU0sSUFBSSxHQUFHLE1BQU0sSUFBSSxDQUFDLFlBQVksQ0FBQztZQUNuQyxLQUFLLEVBQUUsV0FBVztZQUNsQixPQUFPO1lBQ1AsVUFBVTtTQUNYLENBQUMsQ0FBQztRQUNILE1BQU0sSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUN4QixDQUFDLENBQUM7SUFFRixXQUFXLEdBQUcsS0FBSyxFQUFFLEtBQVksRUFBRSxVQUFtQyxFQUFFLEVBQUU7UUFDeEUsTUFBTSxJQUFJLEdBQUcsTUFBTSxJQUFJLENBQUMsWUFBWSxDQUFDO1lBQ25DLEtBQUssRUFBRSxRQUFRO1lBQ2YsS0FBSztZQUNMLFVBQVU7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QUUsZUFBZSxDQUFDO1FBQ25DLEtBQUssTUFBTSxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsSUFBSSxNQUFNLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxFQUFFO1lBQ2xELElBQUksSUFBSSxLQUFLLFdBQVcsRUFBRTtnQkFDeEIsYUFBYSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUM7YUFDbEM7aUJBQU0sSUFBSSxJQUFJLEtBQUssZUFBZSxFQUFFO2dCQUNuQyxlQUFlLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQzthQUNwQztTQUNGO1FBQ0QsT0FBTyxFQUFFLGFBQWEsRUFBRSxlQUFlLEVBQUUsQ0FBQztJQUM1QyxDQUFDLENBQUM7SUFFTSw4QkFBOEIsR0FBRyxDQUN2QyxVQUFtQyxFQUNuQyxFQUFFO1FBQ0YsSUFBSSxPQUFPLEdBQUcsRUFBRSxDQUFDO1FBQ2pCLElBQUksVUFBVSxFQUFFO1lBQ2QsS0FBSyxNQUFNLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxJQUFJLE1BQU0sQ0FBQyxPQUFPLENBQUMsVUFBVSxDQUFDLEVBQUU7Z0JBQ3JELElBQUksSUFBSSxLQUFLLFNBQVMsRUFBRTtvQkFDdEIsT0FBTyxHQUFHLElBQUksQ0FBQztpQkFDaEI7YUFDRjtTQUNGO1FBQ0QsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxFQUFFLENBQUM7SUFDckMsQ0FBQyxDQUFDO0NBQ0g7QUFwSEQsMERBb0hDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgdjQgYXMgdXVpZCB9IGZyb20gJ3V1aWQnO1xuaW1wb3J0IHsgQWNjb3VudElkRmV0Y2hlciB9IGZyb20gJy4vYWNjb3VudF9pZF9mZXRjaGVyLmpzJztcbmltcG9ydCB7IFVzYWdlRGF0YSB9IGZyb20gJy4vdXNhZ2VfZGF0YS5qcyc7XG5pbXBvcnQgb3MgZnJvbSAnb3MnO1xuaW1wb3J0IGh0dHBzIGZyb20gJ2h0dHBzJztcbmltcG9ydCB7IGdldEluc3RhbGxhdGlvblV1aWQgfSBmcm9tICcuL2dldF9pbnN0YWxsYXRpb25faWQuanMnO1xuaW1wb3J0IHsgbGF0ZXN0UGF5bG9hZFZlcnNpb24gfSBmcm9tICcuL2NvbnN0YW50cy5qcyc7XG5pbXBvcnQgeyBnZXRVcmwgfSBmcm9tICcuL2dldF91c2FnZV9kYXRhX3VybC5qcyc7XG5pbXBvcnQgaXNDSSBmcm9tICdpcy1jaSc7XG5pbXBvcnQgeyBTZXJpYWxpemFibGVFcnJvciB9IGZyb20gJy4vc2VyaWFsaXphYmxlX2Vycm9yLmpzJztcbmltcG9ydCB7IFVzYWdlRGF0YUVtaXR0ZXIgfSBmcm9tICcuL3VzYWdlX2RhdGFfZW1pdHRlcl9mYWN0b3J5LmpzJztcblxuLyoqXG4gKiBFbnRyeSBwb2ludCBmb3Igc2VuZGluZyB1c2FnZSBkYXRhIG1ldHJpY3NcbiAqL1xuZXhwb3J0IGNsYXNzIERlZmF1bHRVc2FnZURhdGFFbWl0dGVyIGltcGxlbWVudHMgVXNhZ2VEYXRhRW1pdHRlciB7XG4gIC8qKlxuICAgKiBDb25zdHJ1Y3RvciBmb3IgVXNhZ2VEYXRhRW1pdHRlclxuICAgKi9cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSByZWFkb25seSBsaWJyYXJ5VmVyc2lvbjogc3RyaW5nLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgc2Vzc2lvblV1aWQgPSB1dWlkKCksXG4gICAgcHJpdmF0ZSByZWFkb25seSB1cmwgPSBnZXRVcmwoKSxcbiAgICBwcml2YXRlIHJlYWRvbmx5IGFjY291bnRJZEZldGNoZXIgPSBuZXcgQWNjb3VudElkRmV0Y2hlcigpXG4gICkge31cblxuICBlbWl0U3VjY2VzcyA9IGFzeW5jIChcbiAgICBtZXRyaWNzPzogUmVjb3JkPHN0cmluZywgbnVtYmVyPixcbiAgICBkaW1lbnNpb25zPzogUmVjb3JkPHN0cmluZywgc3RyaW5nPlxuICApID0+IHtcbiAgICBjb25zdCBkYXRhID0gYXdhaXQgdGhpcy5nZXRVc2FnZURhdGEoe1xuICAgICAgc3RhdGU6ICdTVUNDRUVERUQnLFxuICAgICAgbWV0cmljcyxcbiAgICAgIGRpbWVuc2lvbnMsXG4gICAgfSk7XG4gICAgYXdhaXQgdGhpcy5zZW5kKGRhdGEpO1xuICB9O1xuXG4gIGVtaXRGYWlsdXJlID0gYXN5bmMgKGVycm9yOiBFcnJvciwgZGltZW5zaW9ucz86IFJlY29yZDxzdHJpbmcsIHN0cmluZz4pID0+IHtcbiAgICBjb25zdCBkYXRhID0gYXdhaXQgdGhpcy5nZXRVc2FnZURhdGEoe1xuICAgICAgc3RhdGU6ICdGQUlMRUQnLFxuICAgICAgZXJyb3IsXG4gICAgICBkaW1lbnNpb25zLFxuICAgIH0pO1xuICAgIGF3YWl0IHRoaXMuc2VuZChkYXRhKTtcbiAgfTtcblxuICBwcml2YXRlIGdldFVzYWdlRGF0YSA9IGFzeW5jIChvcHRpb25zOiB7XG4gICAgc3RhdGU6ICdTVUNDRUVERUQnIHwgJ0ZBSUxFRCc7XG4gICAgbWV0cmljcz86IFJlY29yZDxzdHJpbmcsIG51bWJlcj47XG4gICAgZGltZW5zaW9ucz86IFJlY29yZDxzdHJpbmcsIHN0cmluZz47XG4gICAgZXJyb3I/OiBFcnJvcjtcbiAgfSkgPT4ge1xuICAgIHJldHVybiB7XG4gICAgICBhY2NvdW50SWQ6IGF3YWl0IHRoaXMuYWNjb3VudElkRmV0Y2hlci5mZXRjaCgpLFxuICAgICAgc2Vzc2lvblV1aWQ6IHRoaXMuc2Vzc2lvblV1aWQsXG4gICAgICBpbnN0YWxsYXRpb25VdWlkOiBhd2FpdCBnZXRJbnN0YWxsYXRpb25VdWlkKCksXG4gICAgICBhbXBsaWZ5Q2xpVmVyc2lvbjogdGhpcy5saWJyYXJ5VmVyc2lvbixcbiAgICAgIHRpbWVzdGFtcDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpLFxuICAgICAgZXJyb3I6IG9wdGlvbnMuZXJyb3IgPyBuZXcgU2VyaWFsaXphYmxlRXJyb3Iob3B0aW9ucy5lcnJvcikgOiB1bmRlZmluZWQsXG4gICAgICBkb3duc3RyZWFtRXhjZXB0aW9uOlxuICAgICAgICBvcHRpb25zLmVycm9yICYmXG4gICAgICAgIG9wdGlvbnMuZXJyb3IuY2F1c2UgJiZcbiAgICAgICAgb3B0aW9ucy5lcnJvci5jYXVzZSBpbnN0YW5jZW9mIEVycm9yXG4gICAgICAgICAgPyBuZXcgU2VyaWFsaXphYmxlRXJyb3Iob3B0aW9ucy5lcnJvci5jYXVzZSlcbiAgICAgICAgICA6IHVuZGVmaW5lZCxcbiAgICAgIHBheWxvYWRWZXJzaW9uOiBsYXRlc3RQYXlsb2FkVmVyc2lvbixcbiAgICAgIG9zUGxhdGZvcm06IG9zLnBsYXRmb3JtKCksXG4gICAgICBvc1JlbGVhc2U6IG9zLnJlbGVhc2UoKSxcbiAgICAgIG5vZGVWZXJzaW9uOiBwcm9jZXNzLnZlcnNpb25zLm5vZGUsXG4gICAgICBzdGF0ZTogb3B0aW9ucy5zdGF0ZSxcbiAgICAgIGNvZGVQYXRoRHVyYXRpb25zOiB0aGlzLnRyYW5zbGF0ZU1ldHJpY3NUb1VzYWdlRGF0YShvcHRpb25zLm1ldHJpY3MpLFxuICAgICAgaW5wdXQ6IHRoaXMudHJhbnNsYXRlRGltZW5zaW9uc1RvVXNhZ2VEYXRhKG9wdGlvbnMuZGltZW5zaW9ucyksXG4gICAgICBpc0NpOiBpc0NJLFxuICAgIH07XG4gIH07XG5cbiAgcHJpdmF0ZSBzZW5kID0gKGRhdGE6IFVzYWdlRGF0YSkgPT4ge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZTx2b2lkPigocmVzb2x2ZSkgPT4ge1xuICAgICAgY29uc3QgcGF5bG9hZDogc3RyaW5nID0gSlNPTi5zdHJpbmdpZnkoZGF0YSk7XG4gICAgICBjb25zdCByZXEgPSBodHRwcy5yZXF1ZXN0KHtcbiAgICAgICAgaG9zdG5hbWU6IHRoaXMudXJsLmhvc3RuYW1lLFxuICAgICAgICBwb3J0OiB0aGlzLnVybC5wb3J0LFxuICAgICAgICBwYXRoOiB0aGlzLnVybC5wYXRoLFxuICAgICAgICBtZXRob2Q6ICdQT1NUJyxcbiAgICAgICAgaGVhZGVyczoge1xuICAgICAgICAgICdjb250ZW50LXR5cGUnOiAnYXBwbGljYXRpb24vanNvbicsXG4gICAgICAgICAgJ2NvbnRlbnQtbGVuZ3RoJzogcGF5bG9hZC5sZW5ndGgsXG4gICAgICAgIH0sXG4gICAgICB9KTtcbiAgICAgIHJlcS5vbignZXJyb3InLCAoKSA9PiB7XG4gICAgICAgIC8qIG5vb3AgKi9cbiAgICAgIH0pO1xuICAgICAgcmVxLnNldFRpbWVvdXQoMjAwMCwgKCkgPT4ge1xuICAgICAgICAvLyAyIHNlY29uZHNcbiAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgfSk7XG5cbiAgICAgIHJlcS53cml0ZShwYXlsb2FkKTtcbiAgICAgIHJlcS5lbmQoKCkgPT4ge1xuICAgICAgICByZXNvbHZlKCk7XG4gICAgICB9KTtcbiAgICB9KTtcbiAgfTtcblxuICBwcml2YXRlIHRyYW5zbGF0ZU1ldHJpY3NUb1VzYWdlRGF0YSA9IChtZXRyaWNzPzogUmVjb3JkPHN0cmluZywgbnVtYmVyPikgPT4ge1xuICAgIGlmICghbWV0cmljcykgcmV0dXJuIHt9O1xuICAgIGxldCB0b3RhbER1cmF0aW9uLCBwbGF0Zm9ybVN0YXJ0dXA7XG4gICAgZm9yIChjb25zdCBbbmFtZSwgZGF0YV0gb2YgT2JqZWN0LmVudHJpZXMobWV0cmljcykpIHtcbiAgICAgIGlmIChuYW1lID09PSAndG90YWxUaW1lJykge1xuICAgICAgICB0b3RhbER1cmF0aW9uID0gTWF0aC5yb3VuZChkYXRhKTtcbiAgICAgIH0gZWxzZSBpZiAobmFtZSA9PT0gJ3N5bnRoZXNpc1RpbWUnKSB7XG4gICAgICAgIHBsYXRmb3JtU3RhcnR1cCA9IE1hdGgucm91bmQoZGF0YSk7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiB7IHRvdGFsRHVyYXRpb24sIHBsYXRmb3JtU3RhcnR1cCB9O1xuICB9O1xuXG4gIHByaXZhdGUgdHJhbnNsYXRlRGltZW5zaW9uc1RvVXNhZ2VEYXRhID0gKFxuICAgIGRpbWVuc2lvbnM/OiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+XG4gICkgPT4ge1xuICAgIGxldCBjb21tYW5kID0gJyc7XG4gICAgaWYgKGRpbWVuc2lvbnMpIHtcbiAgICAgIGZvciAoY29uc3QgW25hbWUsIGRhdGFdIG9mIE9iamVjdC5lbnRyaWVzKGRpbWVuc2lvbnMpKSB7XG4gICAgICAgIGlmIChuYW1lID09PSAnY29tbWFuZCcpIHtcbiAgICAgICAgICBjb21tYW5kID0gZGF0YTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4geyBjb21tYW5kLCBwbHVnaW46ICdHZW4yJyB9O1xuICB9O1xufVxuIl19