"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.getGeneratedFunctionSlots = exports.getGeneratedResources = void 0;
const aws_appsync_1 = require("aws-cdk-lib/aws-appsync");
const aws_dynamodb_1 = require("aws-cdk-lib/aws-dynamodb");
const aws_iam_1 = require("aws-cdk-lib/aws-iam");
const aws_cdk_lib_1 = require("aws-cdk-lib");
const graphql_transformer_core_1 = require("@aws-amplify/graphql-transformer-core");
const aws_lambda_1 = require("aws-cdk-lib/aws-lambda");
const amplify_dynamodb_table_wrapper_1 = require("../amplify-dynamodb-table-wrapper");
const construct_tree_1 = require("./construct-tree");
/**
 * Everything below here is intended to help us gather the
 * output values and render out the L1 resources for access.
 *
 * This is done by recursing along the construct tree, and classifying the generated resources.
 *
 * @param scope root to search for generated resource against
 * @returns a mapping of L1 and L2 constructs generated by the Graphql Transformer.
 */
const getGeneratedResources = (scope) => {
    let cfnGraphqlApi;
    let cfnGraphqlSchema;
    let cfnApiKey;
    const cfnResolvers = {};
    const cfnFunctionConfigurations = {};
    const cfnDataSources = {};
    const tables = {};
    const cfnTables = {};
    const amplifyDynamoDbTables = {};
    const roles = {};
    const cfnRoles = {};
    const functions = {};
    const cfnFunctions = {};
    const additionalCfnResources = {};
    const classifyConstruct = (currentScope) => {
        if (currentScope instanceof aws_appsync_1.CfnGraphQLApi) {
            cfnGraphqlApi = currentScope;
            return;
        }
        if (currentScope instanceof aws_appsync_1.CfnGraphQLSchema) {
            cfnGraphqlSchema = currentScope;
            return;
        }
        if (currentScope instanceof aws_appsync_1.CfnApiKey) {
            cfnApiKey = currentScope;
            return;
        }
        // Retrieve reference name for indexed resources, and bail if none is found.
        const resourceName = (0, graphql_transformer_core_1.getResourceName)(currentScope);
        if (!resourceName)
            return;
        if (currentScope instanceof aws_appsync_1.CfnDataSource) {
            cfnDataSources[resourceName] = currentScope;
            return;
        }
        if (currentScope instanceof aws_appsync_1.CfnResolver) {
            cfnResolvers[resourceName] = currentScope;
            return;
        }
        if (currentScope instanceof aws_appsync_1.CfnFunctionConfiguration) {
            cfnFunctionConfigurations[resourceName] = currentScope;
            return;
        }
        if (currentScope instanceof aws_dynamodb_1.Table) {
            tables[resourceName] = currentScope;
            return;
        }
        if (currentScope instanceof aws_dynamodb_1.CfnTable) {
            cfnTables[resourceName] = currentScope;
            return;
        }
        if (amplify_dynamodb_table_wrapper_1.AmplifyDynamoDbTableWrapper.isAmplifyDynamoDbTableResource(currentScope)) {
            amplifyDynamoDbTables[resourceName] = new amplify_dynamodb_table_wrapper_1.AmplifyDynamoDbTableWrapper(currentScope);
            return;
        }
        if (currentScope instanceof aws_iam_1.Role) {
            roles[resourceName] = currentScope;
            return;
        }
        if (currentScope instanceof aws_iam_1.CfnRole) {
            cfnRoles[resourceName] = currentScope;
            return;
        }
        if (currentScope instanceof aws_lambda_1.Function) {
            functions[resourceName] = currentScope;
            return;
        }
        if (currentScope instanceof aws_lambda_1.CfnFunction) {
            cfnFunctions[resourceName] = currentScope;
            return;
        }
        if (currentScope instanceof aws_cdk_lib_1.CfnResource) {
            additionalCfnResources[resourceName] = currentScope;
            return;
        }
    };
    scope.node.children.forEach((child) => (0, construct_tree_1.walkAndProcessNodes)(child, classifyConstruct));
    if (!cfnGraphqlApi) {
        throw new Error('Expected to find AWS::AppSync::GraphQLApi in the generated resource scope.');
    }
    if (!cfnGraphqlSchema) {
        throw new Error('Expected to find AWS::AppSync::GraphQLSchema in the generated resource scope.');
    }
    const nestedStacks = Object.fromEntries(scope.node.children.filter(aws_cdk_lib_1.NestedStack.isNestedStack).map((nestedStack) => [nestedStack.node.id, nestedStack]));
    return {
        graphqlApi: aws_appsync_1.GraphqlApi.fromGraphqlApiAttributes(scope, 'L2GraphqlApi', { graphqlApiId: cfnGraphqlApi.attrApiId }),
        tables,
        amplifyDynamoDbTables,
        roles,
        functions,
        nestedStacks,
        cfnResources: {
            cfnGraphqlApi,
            cfnGraphqlSchema,
            cfnApiKey,
            cfnResolvers,
            cfnFunctionConfigurations,
            cfnDataSources,
            cfnTables,
            cfnRoles,
            cfnFunctions,
            additionalCfnResources,
        },
    };
};
exports.getGeneratedResources = getGeneratedResources;
/**
 * Get the function slots generated by the Graphql transform operation, adhering to the FunctionSlot interface.
 * @param generatedResolvers the resolvers generated by the transformer to spit back out.
 * @returns the list of generated function slots in the transformer, in order to facilitate overrides.
 */
const getGeneratedFunctionSlots = (generatedResolvers) => Object.entries(generatedResolvers)
    .filter(([name]) => name.split('.').length === 6)
    .map(([name, resolverCode]) => {
    const [typeName, fieldName, slotName, slotIndex, templateType] = name.split('.');
    return {
        typeName,
        fieldName,
        slotName,
        slotIndex: Number.parseInt(slotIndex, 10),
        function: {
            // TODO: this should consolidate req/req values back together
            ...(templateType === 'req' ? { requestMappingTemplate: resolverCode } : {}),
            ...(templateType === 'res' ? { responseMappingTemplate: resolverCode } : {}),
        },
    };
});
exports.getGeneratedFunctionSlots = getGeneratedFunctionSlots;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29uc3RydWN0LWV4cG9ydHMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvaW50ZXJuYWwvY29uc3RydWN0LWV4cG9ydHMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQ0EseURBUWlDO0FBQ2pDLDJEQUEyRDtBQUMzRCxpREFBb0Q7QUFDcEQsNkNBQXVEO0FBQ3ZELG9GQUF3RTtBQUN4RSx1REFBaUY7QUFFakYsc0ZBQWdGO0FBQ2hGLHFEQUF1RDtBQUV2RDs7Ozs7Ozs7R0FRRztBQUNJLE1BQU0scUJBQXFCLEdBQUcsQ0FBQyxLQUFnQixFQUE4QixFQUFFO0lBQ3BGLElBQUksYUFBd0MsQ0FBQztJQUM3QyxJQUFJLGdCQUE4QyxDQUFDO0lBQ25ELElBQUksU0FBZ0MsQ0FBQztJQUNyQyxNQUFNLFlBQVksR0FBZ0MsRUFBRSxDQUFDO0lBQ3JELE1BQU0seUJBQXlCLEdBQTZDLEVBQUUsQ0FBQztJQUMvRSxNQUFNLGNBQWMsR0FBa0MsRUFBRSxDQUFDO0lBQ3pELE1BQU0sTUFBTSxHQUEwQixFQUFFLENBQUM7SUFDekMsTUFBTSxTQUFTLEdBQTZCLEVBQUUsQ0FBQztJQUMvQyxNQUFNLHFCQUFxQixHQUFnRCxFQUFFLENBQUM7SUFDOUUsTUFBTSxLQUFLLEdBQXlCLEVBQUUsQ0FBQztJQUN2QyxNQUFNLFFBQVEsR0FBNEIsRUFBRSxDQUFDO0lBQzdDLE1BQU0sU0FBUyxHQUFtQyxFQUFFLENBQUM7SUFDckQsTUFBTSxZQUFZLEdBQWdDLEVBQUUsQ0FBQztJQUNyRCxNQUFNLHNCQUFzQixHQUFnQyxFQUFFLENBQUM7SUFFL0QsTUFBTSxpQkFBaUIsR0FBRyxDQUFDLFlBQXVCLEVBQVEsRUFBRTtRQUMxRCxJQUFJLFlBQVksWUFBWSwyQkFBYSxFQUFFO1lBQ3pDLGFBQWEsR0FBRyxZQUFZLENBQUM7WUFDN0IsT0FBTztTQUNSO1FBQ0QsSUFBSSxZQUFZLFlBQVksOEJBQWdCLEVBQUU7WUFDNUMsZ0JBQWdCLEdBQUcsWUFB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QyxDQUFDLENBQUMsRUFBRSxDQUFDO1NBQzdFO0tBQ2MsQ0FBQztBQUNwQixDQUFDLENBQUMsQ0FBQztBQWhCTSxRQUFBLHlCQUF5Qiw2QkFnQi9CIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29uc3RydWN0IH0gZnJvbSAnY29uc3RydWN0cyc7XG5pbXBvcnQge1xuICBDZm5HcmFwaFFMQXBpLFxuICBDZm5HcmFwaFFMU2NoZW1hLFxuICBDZm5BcGlLZXksXG4gIENmblJlc29sdmVyLFxuICBDZm5GdW5jdGlvbkNvbmZpZ3VyYXRpb24sXG4gIENmbkRhdGFTb3VyY2UsXG4gIEdyYXBocWxBcGksXG59IGZyb20gJ2F3cy1jZGstbGliL2F3cy1hcHBzeW5jJztcbmltcG9ydCB7IENmblRhYmxlLCBUYWJsZSB9IGZyb20gJ2F3cy1jZGstbGliL2F3cy1keW5hbW9kYic7XG5pbXBvcnQgeyBDZm5Sb2xlLCBSb2xlIH0gZnJvbSAnYXdzLWNkay1saWIvYXdzLWlhbSc7XG5pbXBvcnQgeyBDZm5SZXNvdXJjZSwgTmVzdGVkU3RhY2sgfSBmcm9tICdhd3MtY2RrLWxpYic7XG5pbXBvcnQgeyBnZXRSZXNvdXJjZU5hbWUgfSBmcm9tICdAYXdzLWFtcGxpZnkvZ3JhcGhxbC10cmFuc2Zvcm1lci1jb3JlJztcbmltcG9ydCB7IENmbkZ1bmN0aW9uLCBGdW5jdGlvbiBhcyBMYW1iZGFGdW5jdGlvbiB9IGZyb20gJ2F3cy1jZGstbGliL2F3cy1sYW1iZGEnO1xuaW1wb3J0IHsgQW1wbGlmeUdyYXBocWxBcGlSZXNvdXJjZXMsIEZ1bmN0aW9uU2xvdCB9IGZyb20gJy4uL3R5cGVzJztcbmltcG9ydCB7IEFtcGxpZnlEeW5hbW9EYlRhYmxlV3JhcHBlciB9IGZyb20gJy4uL2FtcGxpZnktZHluYW1vZGItdGFibGUtd3JhcHBlcic7XG5pbXBvcnQgeyB3YWxrQW5kUHJvY2Vzc05vZGVzIH0gZnJvbSAnLi9jb25zdHJ1Y3QtdHJlZSc7XG5cbi8qKlxuICogRXZlcnl0aGluZyBiZWxvdyBoZXJlIGlzIGludGVuZGVkIHRvIGhlbHAgdXMgZ2F0aGVyIHRoZVxuICogb3V0cHV0IHZhbHVlcyBhbmQgcmVuZGVyIG91dCB0aGUgTDEgcmVzb3VyY2VzIGZvciBhY2Nlc3MuXG4gKlxuICogVGhpcyBpcyBkb25lIGJ5IHJlY3Vyc2luZyBhbG9uZyB0aGUgY29uc3RydWN0IHRyZWUsIGFuZCBjbGFzc2lmeWluZyB0aGUgZ2VuZXJhdGVkIHJlc291cmNlcy5cbiAqXG4gKiBAcGFyYW0gc2NvcGUgcm9vdCB0byBzZWFyY2ggZm9yIGdlbmVyYXRlZCByZXNvdXJjZSBhZ2FpbnN0XG4gKiBAcmV0dXJucyBhIG1hcHBpbmcgb2YgTDEgYW5kIEwyIGNvbnN0cnVjdHMgZ2VuZXJhdGVkIGJ5IHRoZSBHcmFwaHFsIFRyYW5zZm9ybWVyLlxuICovXG5leHBvcnQgY29uc3QgZ2V0R2VuZXJhdGVkUmVzb3VyY2VzID0gKHNjb3BlOiBDb25zdHJ1Y3QpOiBBbXBsaWZ5R3JhcGhxbEFwaVJlc291cmNlcyA9PiB7XG4gIGxldCBjZm5HcmFwaHFsQXBpOiBDZm5HcmFwaFFMQXBpIHwgdW5kZWZpbmVkO1xuICBsZXQgY2ZuR3JhcGhxbFNjaGVtYTogQ2ZuR3JhcGhRTFNjaGVtYSB8IHVuZGVmaW5lZDtcbiAgbGV0IGNmbkFwaUtleTogQ2ZuQXBpS2V5IHwgdW5kZWZpbmVkO1xuICBjb25zdCBjZm5SZXNvbHZlcnM6IFJlY29yZDxzdHJpbmcsIENmblJlc29sdmVyPiA9IHt9O1xuICBjb25zdCBjZm5GdW5jdGlvbkNvbmZpZ3VyYXRpb25zOiBSZWNvcmQ8c3RyaW5nLCBDZm5GdW5jdGlvbkNvbmZpZ3VyYXRpb24+ID0ge307XG4gIGNvbnN0IGNmbkRhdGFTb3VyY2VzOiBSZWNvcmQ8c3RyaW5nLCBDZm5EYXRhU291cmNlPiA9IHt9O1xuICBjb25zdCB0YWJsZXM6IFJlY29yZDxzdHJpbmcsIFRhYmxlPiA9IHt9O1xuICBjb25zdCBjZm5UYWJsZXM6IFJlY29yZDxzdHJpbmcsIENmblRhYmxlPiA9IHt9O1xuICBjb25zdCBhbXBsaWZ5RHluYW1vRGJUYWJsZXM6IFJlY29yZDxzdHJpbmcsIEFtcGxpZnlEeW5hbW9EYlRhYmxlV3JhcHBlcj4gPSB7fTtcbiAgY29uc3Qgcm9sZXM6IFJlY29yZDxzdHJpbmcsIFJvbGU+ID0ge307XG4gIGNvbnN0IGNmblJvbGVzOiBSZWNvcmQ8c3RyaW5nLCBDZm5Sb2xlPiA9IHt9O1xuICBjb25zdCBmdW5jdGlvbnM6IFJlY29yZDxzdHJpbmcsIExhbWJkYUZ1bmN0aW9uPiA9IHt9O1xuICBjb25zdCBjZm5GdW5jdGlvbnM6IFJlY29yZDxzdHJpbmcsIENmbkZ1bmN0aW9uPiA9IHt9O1xuICBjb25zdCBhZGRpdGlvbmFsQ2ZuUmVzb3VyY2VzOiBSZWNvcmQ8c3RyaW5nLCBDZm5SZXNvdXJjZT4gPSB7fTtcblxuICBjb25zdCBjbGFzc2lmeUNvbnN0cnVjdCA9IChjdXJyZW50U2NvcGU6IENvbnN0cnVjdCk6IHZvaWQgPT4ge1xuICAgIGlmIChjdXJyZW50U2NvcGUgaW5zdGFuY2VvZiBDZm5HcmFwaFFMQXBpKSB7XG4gICAgICBjZm5HcmFwaHFsQXBpID0gY3VycmVudFNjb3BlO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBpZiAoY3VycmVudFNjb3BlIGluc3RhbmNlb2YgQ2ZuR3JhcGhRTFNjaGVtYSkge1xuICAgICAgY2ZuR3JhcGhxbFNjaGVtYSA9IGN1cnJlbnRTY29wZTtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgaWYgKGN1cnJlbnRTY29wZSBpbnN0YW5jZW9mIENmbkFwaUtleSkge1xuICAgICAgY2ZuQXBpS2V5ID0gY3VycmVudFNjb3BlO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIC8vIFJldHJpZXZlIHJlZmVyZW5jZSBuYW1lIGZvciBpbmRleGVkIHJlc291cmNlcywgYW5kIGJhaWwgaWYgbm9uZSBpcyBmb3VuZC5cbiAgICBjb25zdCByZXNvdXJjZU5hbWUgPSBnZXRSZXNvdXJjZU5hbWUoY3VycmVudFNjb3BlKTtcbiAgICBpZiAoIXJlc291cmNlTmFtZSkgcmV0dXJuO1xuXG4gICAgaWYgKGN1cnJlbnRTY29wZSBpbnN0YW5jZW9mIENmbkRhdGFTb3VyY2UpIHtcbiAgICAgIGNmbkRhdGFTb3VyY2VzW3Jlc291cmNlTmFtZV0gPSBjdXJyZW50U2NvcGU7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGlmIChjdXJyZW50U2NvcGUgaW5zdGFuY2VvZiBDZm5SZXNvbHZlcikge1xuICAgICAgY2ZuUmVzb2x2ZXJzW3Jlc291cmNlTmFtZV0gPSBjdXJyZW50U2NvcGU7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGlmIChjdXJyZW50U2NvcGUgaW5zdGFuY2VvZiBDZm5GdW5jdGlvbkNvbmZpZ3VyYXRpb24pIHtcbiAgICAgIGNmbkZ1bmN0aW9uQ29uZmlndXJhdGlvbnNbcmVzb3VyY2VOYW1lXSA9IGN1cnJlbnRTY29wZTtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgaWYgKGN1cnJlbnRTY29wZSBpbnN0YW5jZW9mIFRhYmxlKSB7XG4gICAgICB0YWJsZXNbcmVzb3VyY2VOYW1lXSA9IGN1cnJlbnRTY29wZTtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgaWYgKGN1cnJlbnRTY29wZSBpbnN0YW5jZW9mIENmblRhYmxlKSB7XG4gICAgICBjZm5UYWJsZXNbcmVzb3VyY2VOYW1lXSA9IGN1cnJlbnRTY29wZTtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgaWYgKEFtcGxpZnlEeW5hbW9EYlRhYmxlV3JhcHBlci5pc0FtcGxpZnlEeW5hbW9EYlRhYmxlUmVzb3VyY2UoY3VycmVudFNjb3BlKSkge1xuICAgICAgYW1wbGlmeUR5bmFtb0RiVGFibGVzW3Jlc291cmNlTmFtZV0gPSBuZXcgQW1wbGlmeUR5bmFtb0RiVGFibGVXcmFwcGVyKGN1cnJlbnRTY29wZSk7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGlmIChjdXJyZW50U2NvcGUgaW5zdGFuY2VvZiBSb2xlKSB7XG4gICAgICByb2xlc1tyZXNvdXJjZU5hbWVdID0gY3VycmVudFNjb3BlO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBpZiAoY3VycmVudFNjb3BlIGluc3RhbmNlb2YgQ2ZuUm9sZSkge1xuICAgICAgY2ZuUm9sZXNbcmVzb3VyY2VOYW1lXSA9IGN1cnJlbnRTY29wZTtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgaWYgKGN1cnJlbnRTY29wZSBpbnN0YW5jZW9mIExhbWJkYUZ1bmN0aW9uKSB7XG4gICAgICBmdW5jdGlvbnNbcmVzb3VyY2VOYW1lXSA9IGN1cnJlbnRTY29wZTtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgaWYgKGN1cnJlbnRTY29wZSBpbnN0YW5jZW9mIENmbkZ1bmN0aW9uKSB7XG4gICAgICBjZm5GdW5jdGlvbnNbcmVzb3VyY2VOYW1lXSA9IGN1cnJlbnRTY29wZTtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgaWYgKGN1cnJlbnRTY29wZSBpbnN0YW5jZW9mIENmblJlc291cmNlKSB7XG4gICAgICBhZGRpdGlvbmFsQ2ZuUmVzb3VyY2VzW3Jlc291cmNlTmFtZV0gPSBjdXJyZW50U2NvcGU7XG4gICAgICByZXR1cm47XG4gICAgfVxuICB9O1xuXG4gIHNjb3BlLm5vZGUuY2hpbGRyZW4uZm9yRWFjaCgoY2hpbGQpID0+IHdhbGtBbmRQcm9jZXNzTm9kZXMoY2hpbGQsIGNsYXNzaWZ5Q29uc3RydWN0KSk7XG5cbiAgaWYgKCFjZm5HcmFwaHFsQXBpKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdFeHBlY3RlZCB0byBmaW5kIEFXUzo6QXBwU3luYzo6R3JhcGhRTEFwaSBpbiB0aGUgZ2VuZXJhdGVkIHJlc291cmNlIHNjb3BlLicpO1xuICB9XG5cbiAgaWYgKCFjZm5HcmFwaHFsU2NoZW1hKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdFeHBlY3RlZCB0byBmaW5kIEFXUzo6QXBwU3luYzo6R3JhcGhRTFNjaGVtYSBpbiB0aGUgZ2VuZXJhdGVkIHJlc291cmNlIHNjb3BlLicpO1xuICB9XG5cbiAgY29uc3QgbmVzdGVkU3RhY2tzOiBSZWNvcmQ8c3RyaW5nLCBOZXN0ZWRTdGFjaz4gPSBPYmplY3QuZnJvbUVudHJpZXMoXG4gICAgc2NvcGUubm9kZS5jaGlsZHJlbi5maWx0ZXIoTmVzdGVkU3RhY2suaXNOZXN0ZWRTdGFjaykubWFwKChuZXN0ZWRTdGFjazogTmVzdGVkU3RhY2spID0+IFtuZXN0ZWRTdGFjay5ub2RlLmlkLCBuZXN0ZWRTdGFja10pLFxuICApO1xuXG4gIHJldHVybiB7XG4gICAgZ3JhcGhxbEFwaTogR3JhcGhxbEFwaS5mcm9tR3JhcGhxbEFwaUF0dHJpYnV0ZXMoc2NvcGUsICdMMkdyYXBocWxBcGknLCB7IGdyYXBocWxBcGlJZDogY2ZuR3JhcGhxbEFwaS5hdHRyQXBpSWQgfSksXG4gICAgdGFibGVzLFxuICAgIGFtcGxpZnlEeW5hbW9EYlRhYmxlcyxcbiAgICByb2xlcyxcbiAgICBmdW5jdGlvbnMsXG4gICAgbmVzdGVkU3RhY2tzLFxuICAgIGNmblJlc291cmNlczoge1xuICAgICAgY2ZuR3JhcGhxbEFwaSxcbiAgICAgIGNmbkdyYXBocWxTY2hlbWEsXG4gICAgICBjZm5BcGlLZXksXG4gICAgICBjZm5SZXNvbHZlcnMsXG4gICAgICBjZm5GdW5jdGlvbkNvbmZpZ3VyYXRpb25zLFxuICAgICAgY2ZuRGF0YVNvdXJjZXMsXG4gICAgICBjZm5UYWJsZXMsXG4gICAgICBjZm5Sb2xlcyxcbiAgICAgIGNmbkZ1bmN0aW9ucyxcbiAgICAgIGFkZGl0aW9uYWxDZm5SZXNvdXJjZXMsXG4gICAgfSxcbiAgfTtcbn07XG5cbi8qKlxuICogR2V0IHRoZSBmdW5jdGlvbiBzbG90cyBnZW5lcmF0ZWQgYnkgdGhlIEdyYXBocWwgdHJhbnNmb3JtIG9wZXJhdGlvbiwgYWRoZXJpbmcgdG8gdGhlIEZ1bmN0aW9uU2xvdCBpbnRlcmZhY2UuXG4gKiBAcGFyYW0gZ2VuZXJhdGVkUmVzb2x2ZXJzIHRoZSByZXNvbHZlcnMgZ2VuZXJhdGVkIGJ5IHRoZSB0cmFuc2Zvcm1lciB0byBzcGl0IGJhY2sgb3V0LlxuICogQHJldHVybnMgdGhlIGxpc3Qgb2YgZ2VuZXJhdGVkIGZ1bmN0aW9uIHNsb3RzIGluIHRoZSB0cmFuc2Zvcm1lciwgaW4gb3JkZXIgdG8gZmFjaWxpdGF0ZSBvdmVycmlkZXMuXG4gKi9cbmV4cG9ydCBjb25zdCBnZXRHZW5lcmF0ZWRGdW5jdGlvblNsb3RzID0gKGdlbmVyYXRlZFJlc29sdmVyczogUmVjb3JkPHN0cmluZywgc3RyaW5nPik6IEZ1bmN0aW9uU2xvdFtdID0+XG4gIE9iamVjdC5lbnRyaWVzKGdlbmVyYXRlZFJlc29sdmVycylcbiAgICAuZmlsdGVyKChbbmFtZV0pID0+IG5hbWUuc3BsaXQoJy4nKS5sZW5ndGggPT09IDYpXG4gICAgLm1hcCgoW25hbWUsIHJlc29sdmVyQ29kZV0pID0+IHtcbiAgICAgIGNvbnN0IFt0eXBlTmFtZSwgZmllbGROYW1lLCBzbG90TmFtZSwgc2xvdEluZGV4LCB0ZW1wbGF0ZVR5cGVdID0gbmFtZS5zcGxpdCgnLicpO1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgdHlwZU5hbWUsXG4gICAgICAgIGZpZWxkTmFtZSxcbiAgICAgICAgc2xvdE5hbWUsXG4gICAgICAgIHNsb3RJbmRleDogTnVtYmVyLnBhcnNlSW50KHNsb3RJbmRleCwgMTApLFxuICAgICAgICBmdW5jdGlvbjoge1xuICAgICAgICAgIC8vIFRPRE86IHRoaXMgc2hvdWxkIGNvbnNvbGlkYXRlIHJlcS9yZXEgdmFsdWVzIGJhY2sgdG9nZXRoZXJcbiAgICAgICAgICAuLi4odGVtcGxhdGVUeXBlID09PSAncmVxJyA/IHsgcmVxdWVzdE1hcHBpbmdUZW1wbGF0ZTogcmVzb2x2ZXJDb2RlIH0gOiB7fSksXG4gICAgICAgICAgLi4uKHRlbXBsYXRlVHlwZSA9PT0gJ3JlcycgPyB7IHJlc3BvbnNlTWFwcGluZ1RlbXBsYXRlOiByZXNvbHZlckNvZGUgfSA6IHt9KSxcbiAgICAgICAgfSxcbiAgICAgIH0gYXMgRnVuY3Rpb25TbG90O1xuICAgIH0pO1xuIl19