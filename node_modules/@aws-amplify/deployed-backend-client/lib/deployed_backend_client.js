import { BackendIdentifierConversions } from '@aws-amplify/platform-core';
import { DeleteStackCommand, DescribeStacksCommand, ListStackResourcesCommand, ListStacksCommand, StackStatus, } from '@aws-sdk/client-cloudformation';
import { GetObjectCommand } from '@aws-sdk/client-s3';
import { authOutputKey, graphqlOutputKey, platformOutputKey, storageOutputKey, } from '@aws-amplify/backend-output-schemas';
/**
 * Deployment Client
 */
export class DefaultDeployedBackendClient {
    cfnClient;
    s3Client;
    backendOutputClient;
    deployedResourcesEnumerator;
    stackStatusMapper;
    arnParser;
    /**
     * Constructor for deployment client
     */
    constructor(cfnClient, s3Client, backendOutputClient, deployedResourcesEnumerator, stackStatusMapper, arnParser) {
        this.cfnClient = cfnClient;
        this.s3Client = s3Client;
        this.backendOutputClient = backendOutputClient;
        this.deployedResourcesEnumerator = deployedResourcesEnumerator;
        this.stackStatusMapper = stackStatusMapper;
        this.arnParser = arnParser;
    }
    /**
     * Returns Amplify Sandboxes for the account and region. The number of sandboxes returned can vary
     */
    listSandboxes = async (listSandboxesRequest) => {
        const stackMetadata = [];
        let nextToken = listSandboxesRequest?.nextToken;
        do {
            const listStacksResponse = await this.listStacks(nextToken);
            const stackMetadataPromises = listStacksResponse.stackSummaries
                .filter((stackSummary) => {
                return stackSummary.StackStatus !== StackStatus.DELETE_COMPLETE;
            })
                .map(async (stackSummary) => {
                const deploymentType = await this.tryGetDeploymentType(stackSummary);
                return {
                    name: stackSummary.StackName,
                    backendId: BackendIdentifierConversions.fromStackName(stackSummary.StackName),
                    lastUpdated: stackSummary.LastUpdatedTime ?? stackSummary.CreationTime,
                    status: this.stackStatusMapper.translateStackStatus(stackSummary.StackStatus),
                    deploymentType,
                };
            });
            const stackMetadataResolvedPromises = await Promise.all(stackMetadataPromises);
            const filteredMetadata = stackMetadataResolvedPromises.filter((stackMetadata) => stackMetadata.deploymentType === 'sandbox');
            stackMetadata.push(...filteredMetadata);
            nextToken = listStacksResponse.nextToken;
        } while (stackMetadata.length === 0 && nextToken);
        return {
            sandboxes: stackMetadata,
            nextToken,
        };
    };
    tryGetDeploymentType = async (stackSummary) => {
        const backendIdentifier = {
            stackName: stackSummary.StackName,
        };
        try {
            const backendOutput = await this.backendOutputClient.getOutput(backendIdentifier);
            return backendOutput[platformOutputKey].payload
                .deploymentType;
        }
        catch {
            return;
        }
    };
    /**
     * Deletes a sandbox with the specified id
     */
    deleteSandbox = async (sandboxBackendIdentifier) => {
        const stackName = BackendIdentifierConversions.toStackName({
            ...sandboxBackendIdentifier,
            type: 'sandbox',
        });
        await this.cfnClient.send(new DeleteStackCommand({ StackName: stackName }));
    };
    /**
     * Fetches all backend metadata for a specified backend
     */
    getBackendMetadata = async (backendId) => {
        const stackName = BackendIdentifierConversions.toStackName(backendId);
        return this.buildBackendMetadata(stackName);
    };
    listStacks = async (nextToken) => {
        const stacks = await this.cfnClient.send(new ListStacksCommand({ NextToken: nextToken }));
        nextToken = stacks.NextToken;
        return { stackSummaries: stacks.StackSummaries ?? [], nextToken };
    };
    buildBackendMetadata = async (stackName) => {
        const stackBackendIdentifier = {
            stackName,
        };
        const backendOutput = await this.backendOutputClient.getOutput(stackBackendIdentifier);
        const stackDescription = await this.cfnClient.send(new DescribeStacksCommand({ StackName: stackName }));
        const stack = stackDescription?.Stacks?.[0];
        const status = this.stackStatusMapper.translateStackStatus(stack?.StackStatus);
        const lastUpdated = stack?.LastUpdatedTime ?? stack?.CreationTime;
        const stackResources = await this.cfnClient.send(new ListStackResourcesCommand({
            StackName: stackName,
        }));
        const childStackPromises = stackResources.StackResourceSummaries?.filter((stackResourceSummary) => {
            return (stackResourceSummary.ResourceType === 'AWS::CloudFormation::Stack');
        }).map(async (stackResourceSummary) => {
            // arn:aws:{service}:{region}:{account}:stack/{stackName}/{additionalFields}
            const arnParts = stackResourceSummary.PhysicalResourceId?.split('/');
            const childStackName = arnParts?.[1];
            if (!childStackName) {
                return;
            }
            const stackDescription = await this.cfnClient.send(new DescribeStacksCommand({ StackName: childStackName }));
            const stack = stackDescription?.Stacks?.[0];
            return stack;
        }) ?? [];
        const childStacks = await Promise.all(childStackPromises);
        const authStack = childStacks.find((nestedStack) => nestedStack?.StackName?.includes('auth'));
        const storageStack = childStacks.find((nestedStack) => nestedStack?.StackName?.includes('storage'));
        const apiStack = childStacks.find((nestedStack) => nestedStack?.StackName?.includes('data'));
        // stack?.StackId is the ARN of the stack
        const { accountId, region } = this.arnParser.tryParseArn(stack?.StackId);
        const backendMetadataObject = {
            deploymentType: backendOutput[platformOutputKey].payload
                .deploymentType,
            lastUpdated,
            status,
            name: stackName,
            resources: await this.deployedResourcesEnumerator.listDeployedResources(this.cfnClient, stackName, accountId, region),
        };
        if (authStack) {
            backendMetadataObject.authConfiguration = {
                status: this.stackStatusMapper.translateStackStatus(authStack.StackStatus),
                lastUpdated: authStack.LastUpdatedTime ?? authStack.CreationTime,
                userPoolId: backendOutput[authOutputKey]?.payload.userPoolId,
            };
        }
        if (storageStack) {
            backendMetadataObject.storageConfiguration = {
                status: this.stackStatusMapper.translateStackStatus(storageStack.StackStatus),
                lastUpdated: storageStack.LastUpdatedTime ?? storageStack.CreationTime,
                s3BucketName: backendOutput[storageOutputKey]?.payload
                    .bucketName,
            };
        }
        if (apiStack) {
            const additionalAuthTypesString = backendOutput[graphqlOutputKey]?.payload
                .awsAppsyncAdditionalAuthenticationTypes;
            const additionalAuthTypes = additionalAuthTypesString
                ? additionalAuthTypesString.split(',')
                : [];
            backendMetadataObject.apiConfiguration = {
                status: this.stackStatusMapper.translateStackStatus(apiStack.StackStatus),
                lastUpdated: apiStack.LastUpdatedTime ?? apiStack.CreationTime,
                graphqlEndpoint: backendOutput[graphqlOutputKey]?.payload
                    .awsAppsyncApiEndpoint,
                defaultAuthType: backendOutput[graphqlOutputKey]?.payload
                    .awsAppsyncAuthenticationType,
                additionalAuthTypes,
                conflictResolutionMode: backendOutput[graphqlOutputKey]?.payload
                    .awsAppsyncConflictResolutionMode,
                apiId: backendOutput[graphqlOutputKey]?.payload
                    .awsAppsyncApiId,
            };
        }
        return backendMetadataObject;
    };
    fetchSchema = async (schemaS3Uri) => {
        if (!schemaS3Uri) {
            throw new Error('schemaS3Uri output is not available');
        }
        // s3://{bucketName}/{fileName}
        const uriParts = schemaS3Uri.split('/');
        const bucketName = uriParts[2];
        const objectPath = uriParts.slice(3, uriParts.length).join('/');
        if (!bucketName || !objectPath) {
            throw new Error('schemaS3Uri is not valid');
        }
        const s3Response = await this.s3Client.send(new GetObjectCommand({ Bucket: bucketName, Key: objectPath }));
        if (!s3Response.Body) {
            throw new Error(`s3Response from ${schemaS3Uri} does not contain a Body`);
        }
        return await s3Response.Body?.transformToString();
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGVwbG95ZWRfYmFja2VuZF9jbGllbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvZGVwbG95ZWRfYmFja2VuZF9jbGllbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBY0EsT0FBTyxFQUFFLDRCQUE0QixFQUFFLE1BQU0sNEJBQTRCLENBQUM7QUFFMUUsT0FBTyxFQUVMLGtCQUFrQixFQUNsQixxQkFBcUIsRUFDckIseUJBQXlCLEVBQ3pCLGlCQUFpQixFQUlqQixXQUFXLEdBRVosTUFBTSxnQ0FBZ0MsQ0FBQztBQUV4QyxPQUFPLEVBQUUsZ0JBQWdCLEVBQVksTUFBTSxvQkFBb0IsQ0FBQztBQUNoRSxPQUFPLEVBQ0wsYUFBYSxFQUNiLGdCQUFnQixFQUNoQixpQkFBaUIsRUFDakIsZ0JBQWdCLEdBQ2pCLE1BQU0scUNBQXFDLENBQUM7QUFLN0M7O0dBRUc7QUFDSCxNQUFNLE9BQU8sNEJBQTRCO0lBS3BCO0lBQ0E7SUFDQTtJQUNBO0lBQ0E7SUFDQTtJQVRuQjs7T0FFRztJQUNILFlBQ21CLFNBQStCLEVBQy9CLFFBQWtCLEVBQ2xCLG1CQUF3QyxFQUN4QywyQkFBd0QsRUFDeEQsaUJBQW9DLEVBQ3BDLFNBQW9CO1FBTHBCLGNBQVMsR0FBVCxTQUFTLENBQXNCO1FBQy9CLGFBQVEsR0FBUixRQUFRLENBQVU7UUFDbEIsd0JBQW1CLEdBQW5CLG1CQUFtQixDQUFxQjtRQUN4QyxnQ0FBMkIsR0FBM0IsMkJBQTJCLENBQTZCO1FBQ3hELHNCQUFpQixHQUFqQixpQkFBaUIsQ0FBbUI7UUFDcEMsY0FBUyxHQUFULFNBQVMsQ0FBVztJQUNwQyxDQUFDO0lBRUo7O09BRUc7SUFDSCxhQUFhLEdBQUcsS0FBSyxFQUNuQixvQkFBMkMsRUFDWCxFQUFFO1FBQ2xDLE1BQU0sYUFBYSxHQUFzQixFQUFFLENBQUM7UUFDNUMsSUFBSSxTQUFTLEdBQUcsb0JBQW9CLEVBQUUsU0FBUyxDQUFDO1FBRWhELEdBQUc7WUFDRCxNQUFNLGtCQUFr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QUMsTUFBTSxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBRWhFLElBQUksQ0FBQyxVQUFVLElBQUksQ0FBQyxVQUFVLEVBQUU7WUFDOUIsTUFBTSxJQUFJLEtBQUssQ0FBQywwQkFBMEIsQ0FBQyxDQUFDO1NBQzdDO1FBRUQsTUFBTSxVQUFVLEdBQUcsTUFBTSxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FDekMsSUFBSSxnQkFBZ0IsQ0FBQyxFQUFFLE1BQU0sRUFBRSxVQUFVLEVBQUUsR0FBRyxFQUFFLFVBQVUsRUFBRSxDQUFDLENBQzlELENBQUM7UUFFRixJQUFJLENBQUMsVUFBVSxDQUFDLElBQUksRUFBRTtZQUNwQixNQUFNLElBQUksS0FBSyxDQUFDLG1CQUFtQixXQUFXLDBCQUEwQixDQUFDLENBQUM7U0FDM0U7UUFFRCxPQUFPLE1BQU0sVUFBVSxDQUFDLElBQUksRUFBRSxpQkFBaUIsRUFBRSxDQUFDO0lBQ3BELENBQUMsQ0FBQztDQUNIIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgQmFja2VuZElkZW50aWZpZXIsXG4gIEJhY2tlbmRPdXRwdXQsXG4gIERlcGxveW1lbnRUeXBlLFxufSBmcm9tICdAYXdzLWFtcGxpZnkvcGx1Z2luLXR5cGVzJztcbmltcG9ydCB7XG4gIEFwaUF1dGhUeXBlLFxuICBCYWNrZW5kTWV0YWRhdGEsXG4gIENvbmZsaWN0UmVzb2x1dGlvbk1vZGUsXG4gIERlcGxveWVkQmFja2VuZENsaWVudCxcbiAgTGlzdFNhbmRib3hlc1JlcXVlc3QsXG4gIExpc3RTYW5kYm94ZXNSZXNwb25zZSxcbiAgU2FuZGJveE1ldGFkYXRhLFxufSBmcm9tICcuL2RlcGxveWVkX2JhY2tlbmRfY2xpZW50X2ZhY3RvcnkuanMnO1xuaW1wb3J0IHsgQmFja2VuZElkZW50aWZpZXJDb252ZXJzaW9ucyB9IGZyb20gJ0Bhd3MtYW1wbGlmeS9wbGF0Zm9ybS1jb3JlJztcbmltcG9ydCB7IEJhY2tlbmRPdXRwdXRDbGllbnQgfSBmcm9tICcuL2JhY2tlbmRfb3V0cHV0X2NsaWVudF9mYWN0b3J5LmpzJztcbmltcG9ydCB7XG4gIENsb3VkRm9ybWF0aW9uQ2xpZW50LFxuICBEZWxldGVTdGFja0NvbW1hbmQsXG4gIERlc2NyaWJlU3RhY2tzQ29tbWFuZCxcbiAgTGlzdFN0YWNrUmVzb3VyY2VzQ29tbWFuZCxcbiAgTGlzdFN0YWNrc0NvbW1hbmQsXG4gIExpc3RTdGFja3NDb21tYW5kT3V0cHV0LFxuICBTdGFjayxcbiAgU3RhY2tSZXNvdXJjZVN1bW1hcnksXG4gIFN0YWNrU3RhdHVzLFxuICBTdGFja1N1bW1hcnksXG59IGZyb20gJ0Bhd3Mtc2RrL2NsaWVudC1jbG91ZGZvcm1hdGlvbic7XG5cbmltcG9ydCB7IEdldE9iamVjdENvbW1hbmQsIFMzQ2xpZW50IH0gZnJvbSAnQGF3cy1zZGsvY2xpZW50LXMzJztcbmltcG9ydCB7XG4gIGF1dGhPdXRwdXRLZXksXG4gIGdyYXBocWxPdXRwdXRLZXksXG4gIHBsYXRmb3JtT3V0cHV0S2V5LFxuICBzdG9yYWdlT3V0cHV0S2V5LFxufSBmcm9tICdAYXdzLWFtcGxpZnkvYmFja2VuZC1vdXRwdXQtc2NoZW1hcyc7XG5pbXBvcnQgeyBEZXBsb3llZFJlc291cmNlc0VudW1lcmF0b3IgfSBmcm9tICcuL2RlcGxveWVkLWJhY2tlbmQtY2xpZW50L2RlcGxveWVkX3Jlc291cmNlc19lbnVtZXJhdG9yLmpzJztcbmltcG9ydCB7IFN0YWNrU3RhdHVzTWFwcGVyIH0gZnJvbSAnLi9kZXBsb3llZC1iYWNrZW5kLWNsaWVudC9zdGFja19zdGF0dXNfbWFwcGVyLmpzJztcbmltcG9ydCB7IEFyblBhcnNlciB9IGZyb20gJy4vZGVwbG95ZWQtYmFja2VuZC1jbGllbnQvYXJuX3BhcnNlci5qcyc7XG5cbi8qKlxuICogRGVwbG95bWVudCBDbGllbnRcbiAqL1xuZXhwb3J0IGNsYXNzIERlZmF1bHREZXBsb3llZEJhY2tlbmRDbGllbnQgaW1wbGVtZW50cyBEZXBsb3llZEJhY2tlbmRDbGllbnQge1xuICAvKipcbiAgICogQ29uc3RydWN0b3IgZm9yIGRlcGxveW1lbnQgY2xpZW50XG4gICAqL1xuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIHJlYWRvbmx5IGNmbkNsaWVudDogQ2xvdWRGb3JtYXRpb25DbGllbnQsXG4gICAgcHJpdmF0ZSByZWFkb25seSBzM0NsaWVudDogUzNDbGllbnQsXG4gICAgcHJpdmF0ZSByZWFkb25seSBiYWNrZW5kT3V0cHV0Q2xpZW50OiBCYWNrZW5kT3V0cHV0Q2xpZW50LFxuICAgIHByaXZhdGUgcmVhZG9ubHkgZGVwbG95ZWRSZXNvdXJjZXNFbnVtZXJhdG9yOiBEZXBsb3llZFJlc291cmNlc0VudW1lcmF0b3IsXG4gICAgcHJpdmF0ZSByZWFkb25seSBzdGFja1N0YXR1c01hcHBlcjogU3RhY2tTdGF0dXNNYXBwZXIsXG4gICAgcHJpdmF0ZSByZWFkb25seSBhcm5QYXJzZXI6IEFyblBhcnNlclxuICApIHt9XG5cbiAgLyoqXG4gICAqIFJldHVybnMgQW1wbGlmeSBTYW5kYm94ZXMgZm9yIHRoZSBhY2NvdW50IGFuZCByZWdpb24uIFRoZSBudW1iZXIgb2Ygc2FuZGJveGVzIHJldHVybmVkIGNhbiB2YXJ5XG4gICAqL1xuICBsaXN0U2FuZGJveGVzID0gYXN5bmMgKFxuICAgIGxpc3RTYW5kYm94ZXNSZXF1ZXN0PzogTGlzdFNhbmRib3hlc1JlcXVlc3RcbiAgKTogUHJvbWlzZTxMaXN0U2FuZGJveGVzUmVzcG9uc2U+ID0+IHtcbiAgICBjb25zdCBzdGFja01ldGFkYXRhOiBTYW5kYm94TWV0YWRhdGFbXSA9IFtdO1xuICAgIGxldCBuZXh0VG9rZW4gPSBsaXN0U2FuZGJveGVzUmVxdWVzdD8ubmV4dFRva2VuO1xuXG4gICAgZG8ge1xuICAgICAgY29uc3QgbGlzdFN0YWNrc1Jlc3BvbnNlID0gYXdhaXQgdGhpcy5saXN0U3RhY2tzKG5leHRUb2tlbik7XG4gICAgICBjb25zdCBzdGFja01ldGFkYXRhUHJvbWlzZXMgPSBsaXN0U3RhY2tzUmVzcG9uc2Uuc3RhY2tTdW1tYXJpZXNcbiAgICAgICAgLmZpbHRlcigoc3RhY2tTdW1tYXJ5OiBTdGFja1N1bW1hcnkpID0+IHtcbiAgICAgICAgICByZXR1cm4gc3RhY2tTdW1tYXJ5LlN0YWNrU3RhdHVzICE9PSBTdGFja1N0YXR1cy5ERUxFVEVfQ09NUExFVEU7XG4gICAgICAgIH0pXG4gICAgICAgIC5tYXAoYXN5bmMgKHN0YWNrU3VtbWFyeTogU3RhY2tTdW1tYXJ5KSA9PiB7XG4gICAgICAgICAgY29uc3QgZGVwbG95bWVudFR5cGUgPSBhd2FpdCB0aGlzLnRyeUdldERlcGxveW1lbnRUeXBlKHN0YWNrU3VtbWFyeSk7XG5cbiAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgbmFtZTogc3RhY2tTdW1tYXJ5LlN0YWNrTmFtZSBhcyBzdHJpbmcsXG4gICAgICAgICAgICBiYWNrZW5kSWQ6IEJhY2tlbmRJZGVudGlmaWVyQ29udmVyc2lvbnMuZnJvbVN0YWNrTmFtZShcbiAgICAgICAgICAgICAgc3RhY2tTdW1tYXJ5LlN0YWNrTmFtZVxuICAgICAgICAgICAgKSxcbiAgICAgICAgICAgIGxhc3RVcGRhdGVkOlxuICAgICAgICAgICAgICBzdGFja1N1bW1hcnkuTGFzdFVwZGF0ZWRUaW1lID8/IHN0YWNrU3VtbWFyeS5DcmVhdGlvblRpbWUsXG4gICAgICAgICAgICBzdGF0dXM6IHRoaXMuc3RhY2tTdGF0dXNNYXBwZXIudHJhbnNsYXRlU3RhY2tTdGF0dXMoXG4gICAgICAgICAgICAgIHN0YWNrU3VtbWFyeS5TdGFja1N0YXR1c1xuICAgICAgICAgICAgKSxcbiAgICAgICAgICAgIGRlcGxveW1lbnRUeXBlLFxuICAgICAgICAgIH07XG4gICAgICAgIH0pO1xuXG4gICAgICBjb25zdCBzdGFja01ldGFkYXRhUmVzb2x2ZWRQcm9taXNlcyA9IGF3YWl0IFByb21pc2UuYWxsKFxuICAgICAgICBzdGFja01ldGFkYXRhUHJvbWlzZXNcbiAgICAgICk7XG4gICAgICBjb25zdCBmaWx0ZXJlZE1ldGFkYXRhID0gc3RhY2tNZXRhZGF0YVJlc29sdmVkUHJvbWlzZXMuZmlsdGVyKFxuICAgICAgICAoc3RhY2tNZXRhZGF0YSkgPT4gc3RhY2tNZXRhZGF0YS5kZXBsb3ltZW50VHlwZSA9PT0gJ3NhbmRib3gnXG4gICAgICApO1xuXG4gICAgICBzdGFja01ldGFkYXRhLnB1c2goLi4uZmlsdGVyZWRNZXRhZGF0YSk7XG4gICAgICBuZXh0VG9rZW4gPSBsaXN0U3RhY2tzUmVzcG9uc2UubmV4dFRva2VuO1xuICAgIH0gd2hpbGUgKHN0YWNrTWV0YWRhdGEubGVuZ3RoID09PSAwICYmIG5leHRUb2tlbik7XG5cbiAgICByZXR1cm4ge1xuICAgICAgc2FuZGJveGVzOiBzdGFja01ldGFkYXRhLFxuICAgICAgbmV4dFRva2VuLFxuICAgIH07XG4gIH07XG5cbiAgcHJpdmF0ZSB0cnlHZXREZXBsb3ltZW50VHlwZSA9IGFzeW5jIChcbiAgICBzdGFja1N1bW1hcnk6IFN0YWNrU3VtbWFyeVxuICApOiBQcm9taXNlPERlcGxveW1lbnRUeXBlIHwgdW5kZWZpbmVkPiA9PiB7XG4gICAgY29uc3QgYmFja2VuZElkZW50aWZpZXIgPSB7XG4gICAgICBzdGFja05hbWU6IHN0YWNrU3VtbWFyeS5TdGFja05hbWUgYXMgc3RyaW5nLFxuICAgIH07XG5cbiAgICB0cnkge1xuICAgICAgY29uc3QgYmFja2VuZE91dHB1dDogQmFja2VuZE91dHB1dCA9XG4gICAgICAgIGF3YWl0IHRoaXMuYmFja2VuZE91dHB1dENsaWVudC5nZXRPdXRwdXQoYmFja2VuZElkZW50aWZpZXIpO1xuXG4gICAgICByZXR1cm4gYmFja2VuZE91dHB1dFtwbGF0Zm9ybU91dHB1dEtleV0ucGF5bG9hZFxuICAgICAgICAuZGVwbG95bWVudFR5cGUgYXMgRGVwbG95bWVudFR5cGU7XG4gICAgfSBjYXRjaCB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICB9O1xuXG4gIC8qKlxuICAgKiBEZWxldGVzIGEgc2FuZGJveCB3aXRoIHRoZSBzcGVjaWZpZWQgaWRcbiAgICovXG4gIGRlbGV0ZVNhbmRib3ggPSBhc3luYyAoXG4gICAgc2FuZGJveEJhY2tlbmRJZGVudGlmaWVyOiBPbWl0PEJhY2tlbmRJZGVudGlmaWVyLCAndHlwZSc+XG4gICk6IFByb21pc2U8dm9pZD4gPT4ge1xuICAgIGNvbnN0IHN0YWNrTmFtZSA9IEJhY2tlbmRJZGVudGlmaWVyQ29udmVyc2lvbnMudG9TdGFja05hbWUoe1xuICAgICAgLi4uc2FuZGJveEJhY2tlbmRJZGVudGlmaWVyLFxuICAgICAgdHlwZTogJ3NhbmRib3gnLFxuICAgIH0pO1xuICAgIGF3YWl0IHRoaXMuY2ZuQ2xpZW50LnNlbmQobmV3IERlbGV0ZVN0YWNrQ29tbWFuZCh7IFN0YWNrTmFtZTogc3RhY2tOYW1lIH0pKTtcbiAgfTtcbiAgLyoqXG4gICAqIEZldGNoZXMgYWxsIGJhY2tlbmQgbWV0YWRhdGEgZm9yIGEgc3BlY2lmaWVkIGJhY2tlbmRcbiAgICovXG4gIGdldEJhY2tlbmRNZXRhZGF0YSA9IGFzeW5jIChcbiAgICBiYWNrZW5kSWQ6IEJhY2tlbmRJZGVudGlmaWVyXG4gICk6IFByb21pc2U8QmFja2VuZE1ldGFkYXRhPiA9PiB7XG4gICAgY29uc3Qgc3RhY2tOYW1lID0gQmFja2VuZElkZW50aWZpZXJDb252ZXJzaW9ucy50b1N0YWNrTmFtZShiYWNrZW5kSWQpO1xuICAgIHJldHVybiB0aGlzLmJ1aWxkQmFja2VuZE1ldGFkYXRhKHN0YWNrTmFtZSk7XG4gIH07XG5cbiAgcHJpdmF0ZSBsaXN0U3RhY2tzID0gYXN5bmMgKFxuICAgIG5leHRUb2tlbjogc3RyaW5nIHwgdW5kZWZpbmVkXG4gICk6IFByb21pc2U8e1xuICAgIHN0YWNrU3VtbWFyaWVzOiBTdGFja1N1bW1hcnlbXTtcbiAgICBuZXh0VG9rZW46IHN0cmluZyB8IHVuZGVmaW5lZDtcbiAgfT4gPT4ge1xuICAgIGNvbnN0IHN0YWNrczogTGlzdFN0YWNrc0NvbW1hbmRPdXRwdXQgPSBhd2FpdCB0aGlzLmNmbkNsaWVudC5zZW5kKFxuICAgICAgbmV3IExpc3RTdGFja3NDb21tYW5kKHsgTmV4dFRva2VuOiBuZXh0VG9rZW4gfSlcbiAgICApO1xuICAgIG5leHRUb2tlbiA9IHN0YWNrcy5OZXh0VG9rZW47XG4gICAgcmV0dXJuIHsgc3RhY2tTdW1tYXJpZXM6IHN0YWNrcy5TdGFja1N1bW1hcmllcyA/PyBbXSwgbmV4dFRva2VuIH07XG4gIH07XG5cbiAgcHJpdmF0ZSBidWlsZEJhY2tlbmRNZXRhZGF0YSA9IGFzeW5jIChcbiAgICBzdGFja05hbWU6IHN0cmluZ1xuICApOiBQcm9taXNlPEJhY2tlbmRNZXRhZGF0YT4gPT4ge1xuICAgIGNvbnN0IHN0YWNrQmFja2VuZElkZW50aWZpZXIgPSB7XG4gICAgICBzdGFja05hbWUsXG4gICAgfTtcblxuICAgIGNvbnN0IGJhY2tlbmRPdXRwdXQ6IEJhY2tlbmRPdXRwdXQgPVxuICAgICAgYXdhaXQgdGhpcy5iYWNrZW5kT3V0cHV0Q2xpZW50LmdldE91dHB1dChzdGFja0JhY2tlbmRJZGVudGlmaWVyKTtcbiAgICBjb25zdCBzdGFja0Rlc2NyaXB0aW9uID0gYXdhaXQgdGhpcy5jZm5DbGllbnQuc2VuZChcbiAgICAgIG5ldyBEZXNjcmliZVN0YWNrc0NvbW1hbmQoeyBTdGFja05hbWU6IHN0YWNrTmFtZSB9KVxuICAgICk7XG4gICAgY29uc3Qgc3RhY2sgPSBzdGFja0Rlc2NyaXB0aW9uPy5TdGFja3M/LlswXTtcbiAgICBjb25zdCBzdGF0dXMgPSB0aGlzLnN0YWNrU3RhdHVzTWFwcGVyLnRyYW5zbGF0ZVN0YWNrU3RhdHVzKFxuICAgICAgc3RhY2s/LlN0YWNrU3RhdHVzXG4gICAgKTtcbiAgICBjb25zdCBsYXN0VXBkYXRlZCA9IHN0YWNrPy5MYXN0VXBkYXRlZFRpbWUgPz8gc3RhY2s/LkNyZWF0aW9uVGltZTtcblxuICAgIGNvbnN0IHN0YWNrUmVzb3VyY2VzID0gYXdhaXQgdGhpcy5jZm5DbGllbnQuc2VuZChcbiAgICAgIG5ldyBMaXN0U3RhY2tSZXNvdXJjZXNDb21tYW5kKHtcbiAgICAgICAgU3RhY2tOYW1lOiBzdGFja05hbWUsXG4gICAgICB9KVxuICAgICk7XG4gICAgY29uc3QgY2hpbGRTdGFja1Byb21pc2VzOiBQcm9taXNlPFN0YWNrIHwgdW5kZWZpbmVkPltdID1cbiAgICAgIHN0YWNrUmVzb3VyY2VzLlN0YWNrUmVzb3VyY2VTdW1tYXJpZXM/LmZpbHRlcihcbiAgICAgICAgKHN0YWNrUmVzb3VyY2VTdW1tYXJ5OiBTdGFja1Jlc291cmNlU3VtbWFyeSkgPT4ge1xuICAgICAgICAgIHJldHVybiAoXG4gICAgICAgICAgICBzdGFja1Jlc291cmNlU3VtbWFyeS5SZXNvdXJjZVR5cGUgPT09ICdBV1M6OkNsb3VkRm9ybWF0aW9uOjpTdGFjaydcbiAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgICApLm1hcChhc3luYyAoc3RhY2tSZXNvdXJjZVN1bW1hcnk6IFN0YWNrUmVzb3VyY2VTdW1tYXJ5KSA9PiB7XG4gICAgICAgIC8vIGFybjphd3M6e3NlcnZpY2V9OntyZWdpb259OnthY2NvdW50fTpzdGFjay97c3RhY2tOYW1lfS97YWRkaXRpb25hbEZpZWxkc31cbiAgICAgICAgY29uc3QgYXJuUGFydHMgPSBzdGFja1Jlc291cmNlU3VtbWFyeS5QaHlzaWNhbFJlc291cmNlSWQ/LnNwbGl0KCcvJyk7XG4gICAgICAgIGNvbnN0IGNoaWxkU3RhY2tOYW1lID0gYXJuUGFydHM/LlsxXTtcbiAgICAgICAgaWYgKCFjaGlsZFN0YWNrTmFtZSkge1xuICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBzdGFja0Rlc2NyaXB0aW9uID0gYXdhaXQgdGhpcy5jZm5DbGllbnQuc2VuZChcbiAgICAgICAgICBuZXcgRGVzY3JpYmVTdGFja3NDb21tYW5kKHsgU3RhY2tOYW1lOiBjaGlsZFN0YWNrTmFtZSB9KVxuICAgICAgICApO1xuXG4gICAgICAgIGNvbnN0IHN0YWNrID0gc3RhY2tEZXNjcmlwdGlvbj8uU3RhY2tzPy5bMF07XG4gICAgICAgIHJldHVybiBzdGFjaztcbiAgICAgIH0pID8/IFtdO1xuXG4gICAgY29uc3QgY2hpbGRTdGFja3MgPSBhd2FpdCBQcm9taXNlLmFsbChjaGlsZFN0YWNrUHJvbWlzZXMpO1xuICAgIGNvbnN0IGF1dGhTdGFjayA9IGNoaWxkU3RhY2tzLmZpbmQoXG4gICAgICAobmVzdGVkU3RhY2s6IFN0YWNrU3VtbWFyeSB8IHVuZGVmaW5lZCkgPT5cbiAgICAgICAgbmVzdGVkU3RhY2s/LlN0YWNrTmFtZT8uaW5jbHVkZXMoJ2F1dGgnKVxuICAgICk7XG4gICAgY29uc3Qgc3RvcmFnZVN0YWNrID0gY2hpbGRTdGFja3MuZmluZChcbiAgICAgIChuZXN0ZWRTdGFjazogU3RhY2tTdW1tYXJ5IHwgdW5kZWZpbmVkKSA9PlxuICAgICAgICBuZXN0ZWRTdGFjaz8uU3RhY2tOYW1lPy5pbmNsdWRlcygnc3RvcmFnZScpXG4gICAgKTtcbiAgICBjb25zdCBhcGlTdGFjayA9IGNoaWxkU3RhY2tzLmZpbmQoKG5lc3RlZFN0YWNrOiBTdGFja1N1bW1hcnkgfCB1bmRlZmluZWQpID0+XG4gICAgICBuZXN0ZWRTdGFjaz8uU3RhY2tOYW1lPy5pbmNsdWRlcygnZGF0YScpXG4gICAgKTtcblxuICAgIC8vIHN0YWNrPy5TdGFja0lkIGlzIHRoZSBBUk4gb2YgdGhlIHN0YWNrXG4gICAgY29uc3QgeyBhY2NvdW50SWQsIHJlZ2lvbiB9ID0gdGhpcy5hcm5QYXJzZXIudHJ5UGFyc2VBcm4oXG4gICAgICBzdGFjaz8uU3RhY2tJZCBhcyBzdHJpbmdcbiAgICApO1xuICAgIGNvbnN0IGJhY2tlbmRNZXRhZGF0YU9iamVjdDogQmFja2VuZE1ldGFkYXRhID0ge1xuICAgICAgZGVwbG95bWVudFR5cGU6IGJhY2tlbmRPdXRwdXRbcGxhdGZvcm1PdXRwdXRLZXldLnBheWxvYWRcbiAgICAgICAgLmRlcGxveW1lbnRUeXBlIGFzIERlcGxveW1lbnRUeXBlLFxuICAgICAgbGFzdFVwZGF0ZWQsXG4gICAgICBzdGF0dXMsXG4gICAgICBuYW1lOiBzdGFja05hbWUsXG4gICAgICByZXNvdXJjZXM6IGF3YWl0IHRoaXMuZGVwbG95ZWRSZXNvdXJjZXNFbnVtZXJhdG9yLmxpc3REZXBsb3llZFJlc291cmNlcyhcbiAgICAgICAgdGhpcy5jZm5DbGllbnQsXG4gICAgICAgIHN0YWNrTmFtZSxcbiAgICAgICAgYWNjb3VudElkLFxuICAgICAgICByZWdpb25cbiAgICAgICksXG4gICAgfTtcblxuICAgIGlmIChhdXRoU3RhY2spIHtcbiAgICAgIGJhY2tlbmRNZXRhZGF0YU9iamVjdC5hdXRoQ29uZmlndXJhdGlvbiA9IHtcbiAgICAgICAgc3RhdHVzOiB0aGlzLnN0YWNrU3RhdHVzTWFwcGVyLnRyYW5zbGF0ZVN0YWNrU3RhdHVzKFxuICAgICAgICAgIGF1dGhTdGFjay5TdGFja1N0YXR1c1xuICAgICAgICApLFxuICAgICAgICBsYXN0VXBkYXRlZDogYXV0aFN0YWNrLkxhc3RVcGRhdGVkVGltZSA/PyBhdXRoU3RhY2suQ3JlYXRpb25UaW1lLFxuICAgICAgICB1c2VyUG9vbElkOiBiYWNrZW5kT3V0cHV0W2F1dGhPdXRwdXRLZXldPy5wYXlsb2FkLnVzZXJQb29sSWQgYXMgc3RyaW5nLFxuICAgICAgfTtcbiAgICB9XG5cbiAgICBpZiAoc3RvcmFnZVN0YWNrKSB7XG4gICAgICBiYWNrZW5kTWV0YWRhdGFPYmplY3Quc3RvcmFnZUNvbmZpZ3VyYXRpb24gPSB7XG4gICAgICAgIHN0YXR1czogdGhpcy5zdGFja1N0YXR1c01hcHBlci50cmFuc2xhdGVTdGFja1N0YXR1cyhcbiAgICAgICAgICBzdG9yYWdlU3RhY2suU3RhY2tTdGF0dXNcbiAgICAgICAgKSxcbiAgICAgICAgbGFzdFVwZGF0ZWQ6IHN0b3JhZ2VTdGFjay5MYXN0VXBkYXRlZFRpbWUgPz8gc3RvcmFnZVN0YWNrLkNyZWF0aW9uVGltZSxcbiAgICAgICAgczNCdWNrZXROYW1lOiBiYWNrZW5kT3V0cHV0W3N0b3JhZ2VPdXRwdXRLZXldPy5wYXlsb2FkXG4gICAgICAgICAgLmJ1Y2tldE5hbWUgYXMgc3RyaW5nLFxuICAgICAgfTtcbiAgICB9XG5cbiAgICBpZiAoYXBpU3RhY2spIHtcbiAgICAgIGNvbnN0IGFkZGl0aW9uYWxBdXRoVHlwZXNTdHJpbmcgPVxuICAgICAgICBiYWNrZW5kT3V0cHV0W2dyYXBocWxPdXRwdXRLZXldPy5wYXlsb2FkXG4gICAgICAgICAgLmF3c0FwcHN5bmNBZGRpdGlvbmFsQXV0aGVudGljYXRpb25UeXBlcztcbiAgICAgIGNvbnN0IGFkZGl0aW9uYWxBdXRoVHlwZXMgPSBhZGRpdGlvbmFsQXV0aFR5cGVzU3RyaW5nXG4gICAgICAgID8gKGFkZGl0aW9uYWxBdXRoVHlwZXNTdHJpbmcuc3BsaXQoJywnKSBhcyBBcGlBdXRoVHlwZVtdKVxuICAgICAgICA6IFtdO1xuICAgICAgYmFja2VuZE1ldGFkYXRhT2JqZWN0LmFwaUNvbmZpZ3VyYXRpb24gPSB7XG4gICAgICAgIHN0YXR1czogdGhpcy5zdGFja1N0YXR1c01hcHBlci50cmFuc2xhdGVTdGFja1N0YXR1cyhcbiAgICAgICAgICBhcGlTdGFjay5TdGFja1N0YXR1c1xuICAgICAgICApLFxuICAgICAgICBsYXN0VXBkYXRlZDogYXBpU3RhY2suTGFzdFVwZGF0ZWRUaW1lID8/IGFwaVN0YWNrLkNyZWF0aW9uVGltZSxcbiAgICAgICAgZ3JhcGhxbEVuZHBvaW50OiBiYWNrZW5kT3V0cHV0W2dyYXBocWxPdXRwdXRLZXldPy5wYXlsb2FkXG4gICAgICAgICAgLmF3c0FwcHN5bmNBcGlFbmRwb2ludCBhcyBzdHJpbmcsXG4gICAgICAgIGRlZmF1bHRBdXRoVHlwZTogYmFja2VuZE91dHB1dFtncmFwaHFsT3V0cHV0S2V5XT8ucGF5bG9hZFxuICAgICAgICAgIC5hd3NBcHBzeW5jQXV0aGVudGljYXRpb25UeXBlIGFzIEFwaUF1dGhUeXBlLFxuICAgICAgICBhZGRpdGlvbmFsQXV0aFR5cGVzLFxuICAgICAgICBjb25mbGljdFJlc29sdXRpb25Nb2RlOiBiYWNrZW5kT3V0cHV0W2dyYXBocWxPdXRwdXRLZXldPy5wYXlsb2FkXG4gICAgICAgICAgLmF3c0FwcHN5bmNDb25mbGljdFJlc29sdXRpb25Nb2RlIGFzIENvbmZsaWN0UmVzb2x1dGlvbk1vZGUsXG4gICAgICAgIGFwaUlkOiBiYWNrZW5kT3V0cHV0W2dyYXBocWxPdXRwdXRLZXldPy5wYXlsb2FkXG4gICAgICAgICAgLmF3c0FwcHN5bmNBcGlJZCBhcyBzdHJpbmcsXG4gICAgICB9O1xuICAgIH1cblxuICAgIHJldHVybiBiYWNrZW5kTWV0YWRhdGFPYmplY3Q7XG4gIH07XG5cbiAgcHJpdmF0ZSBmZXRjaFNjaGVtYSA9IGFzeW5jIChcbiAgICBzY2hlbWFTM1VyaTogc3RyaW5nIHwgdW5kZWZpbmVkXG4gICk6IFByb21pc2U8c3RyaW5nPiA9PiB7XG4gICAgaWYgKCFzY2hlbWFTM1VyaSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdzY2hlbWFTM1VyaSBvdXRwdXQgaXMgbm90IGF2YWlsYWJsZScpO1xuICAgIH1cblxuICAgIC8vIHMzOi8ve2J1Y2tldE5hbWV9L3tmaWxlTmFtZX1cbiAgICBjb25zdCB1cmlQYXJ0cyA9IHNjaGVtYVMzVXJpLnNwbGl0KCcvJyk7XG4gICAgY29uc3QgYnVja2V0TmFtZSA9IHVyaVBhcnRzWzJdO1xuICAgIGNvbnN0IG9iamVjdFBhdGggPSB1cmlQYXJ0cy5zbGljZSgzLCB1cmlQYXJ0cy5sZW5ndGgpLmpvaW4oJy8nKTtcblxuICAgIGlmICghYnVja2V0TmFtZSB8fCAhb2JqZWN0UGF0aCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdzY2hlbWFTM1VyaSBpcyBub3QgdmFsaWQnKTtcbiAgICB9XG5cbiAgICBjb25zdCBzM1Jlc3BvbnNlID0gYXdhaXQgdGhpcy5zM0NsaWVudC5zZW5kKFxuICAgICAgbmV3IEdldE9iamVjdENvbW1hbmQoeyBCdWNrZXQ6IGJ1Y2tldE5hbWUsIEtleTogb2JqZWN0UGF0aCB9KVxuICAgICk7XG5cbiAgICBpZiAoIXMzUmVzcG9uc2UuQm9keSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBzM1Jlc3BvbnNlIGZyb20gJHtzY2hlbWFTM1VyaX0gZG9lcyBub3QgY29udGFpbiBhIEJvZHlgKTtcbiAgICB9XG5cbiAgICByZXR1cm4gYXdhaXQgczNSZXNwb25zZS5Cb2R5Py50cmFuc2Zvcm1Ub1N0cmluZygpO1xuICB9O1xufVxuIl19