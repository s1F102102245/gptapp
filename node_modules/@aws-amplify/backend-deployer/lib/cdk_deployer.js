import { execa } from 'execa';
import stream from 'stream';
import readline from 'readline';
import { CDKContextKey } from '@aws-amplify/platform-core';
import { dirname } from 'path';
/**
 * Commands that can be invoked
 */
var InvokableCommand;
(function (InvokableCommand) {
    InvokableCommand["DEPLOY"] = "deploy";
    InvokableCommand["DESTROY"] = "destroy";
})(InvokableCommand || (InvokableCommand = {}));
/**
 * Invokes CDK command via execa
 */
export class CDKDeployer {
    cdkErrorMapper;
    backendLocator;
    /**
     * Instantiates instance of CDKDeployer
     */
    constructor(cdkErrorMapper, backendLocator) {
        this.cdkErrorMapper = cdkErrorMapper;
        this.backendLocator = backendLocator;
    }
    /**
     * Invokes cdk deploy command
     */
    deploy = async (backendId, deployProps) => {
        await this.invokeTsc(deployProps);
        const cdkCommandArgs = [];
        if (deployProps?.deploymentType === 'sandbox') {
            cdkCommandArgs.push('--hotswap-fallback');
            cdkCommandArgs.push('--method=direct');
            if (deployProps.secretLastUpdated) {
                cdkCommandArgs.push('--context', `secretLastUpdated=${deployProps.secretLastUpdated.getTime()}`);
            }
        }
        return this.invokeCdk(InvokableCommand.DEPLOY, backendId, deployProps?.deploymentType, cdkCommandArgs);
    };
    /**
     * Invokes cdk destroy command
     */
    destroy = async (backendId, destroyProps) => {
        return this.invokeCdk(InvokableCommand.DESTROY, backendId, destroyProps?.deploymentType, ['--force']);
    };
    invokeTsc = async (deployProps) => {
        if (!deployProps?.validateAppSources) {
            return;
        }
        try {
            await this.executeChildProcess('npx', [
                'tsc',
                '--showConfig',
                '--project',
                dirname(this.backendLocator.locate()),
            ], { printStdout: false });
        }
        catch (error) {
            // If we cannot load ts config, turn off type checking
            return;
        }
        await this.executeChildProcess('npx', [
            'tsc',
            '--noEmit',
            '--skipLibCheck',
            // pointing the project arg to the amplify backend directory will use the tsconfig present in that directory
            '--project',
            dirname(this.backendLocator.locate()),
        ]);
    };
    /**
     * Executes a CDK command
     */
    invokeCdk = async (invokableCommand, backendId, deploymentType, additionalArguments) => {
        // Basic args
        const cdkCommandArgs = [
            'cdk',
            invokableCommand.toString(),
            // This is unfortunate. CDK writes everything to stderr without `--ci` flag and we need to differentiate between the two.
            // See https://github.com/aws/aws-cdk/issues/7717 for more details.
            '--ci',
            '--app',
            `'npx tsx ${this.backendLocator.locate()}'`,
            '--all',
            '--output',
            '.amplify/artifacts/cdk.out',
        ];
        // Add context information if available
        if (backendId) {
            cdkCommandArgs.push('--context', `${CDKContextKey.BACKEND_NAMESPACE}=${backendId.namespace}`, '--context', `${CDKContextKey.BACKEND_NAME}=${backendId.name}`);
            if (deploymentType !== 'sandbox') {
                cdkCommandArgs.push('--require-approval', 'never');
            }
        }
        if (deploymentType) {
            cdkCommandArgs.push('--context', `${CDKContextKey.DEPLOYMENT_TYPE}=${deploymentType}`);
        }
        if (additionalArguments) {
            cdkCommandArgs.push(...additionalArguments);
        }
        try {
            return await this.executeChildProcess('npx', cdkCommandArgs);
        }
        catch (err) {
            throw this.cdkErrorMapper.getHumanReadableError(err);
        }
    };
    /**
     * Wrapper for the child process executor. Helps in unit testing as node:test framework
     * doesn't have capabilities to mock exported functions like `execa` as of right now.
     */
    executeChildProcess = async (command, commandArgs, options = { printStdout: true }) => {
        // We let the stdout and stdin inherit and streamed to parent process but pipe
        // the stderr and use it to throw on failure. This is to prevent actual
        // actionable errors being hidden among the stdout. Moreover execa errors are
        // useless when calling CLIs unless you made execa calling error.
        let aggregatedStderr = '';
        const aggregatorStderrStream = new stream.Writable();
        aggregatorStderrStream._write = function (chunk, encoding, done) {
            aggregatedStderr += chunk;
            done();
        };
        const childProcess = execa(command, commandArgs, {
            stdin: 'inherit',
            stdout: 'pipe',
            stderr: 'pipe',
            // Piping the output by default strips off the color. This is a workaround to
            // preserve the color being piped to parent process.
            extendEnv: true,
            env: { FORCE_COLOR: '1' },
        });
        childProcess.stderr?.pipe(aggregatorStderrStream);
        if (options?.printStdout) {
            childProcess.stdout?.pipe(process.stdout);
        }
        const cdkOutput = { deploymentTimes: {} };
        if (childProcess.stdout) {
            await this.populateCDKOutputFromStdout(cdkOutput, childProcess.stdout);
        }
        try {
            await childProcess;
            return cdkOutput;
        }
        catch (error) {
            // swallow execa error which is not really helpful, rather throw stderr
            throw new Error(aggregatedStderr);
        }
    };
    populateCDKOutputFromStdout = async (output, stdout) => {
        const regexTotalTime = /✨ {2}Total time: (\d*\.*\d*)s.*/;
        const regexSynthTime = /✨ {2}Synthesis time: (\d*\.*\d*)s/;
        const reader = readline.createInterface(stdout);
        for await (const line of reader) {
            if (line.includes('✨')) {
                // Good chance that it contains timing information
                const totalTime = line.match(regexTotalTime);
                if (totalTime && totalTime.length > 1 && !isNaN(+totalTime[1])) {
                    output.deploymentTimes.totalTime = +totalTime[1];
                }
                const synthTime = line.match(regexSynthTime);
                if (synthTime && synthTime.length > 1 && !isNaN(+synthTime[1])) {
                    output.deploymentTimes.synthesisTime = +synthTime[1];
                }
            }
        }
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2RrX2RlcGxveWVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL2Nka19kZXBsb3llci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsS0FBSyxFQUFFLE1BQU0sT0FBTyxDQUFDO0FBQzlCLE9BQU8sTUFBTSxNQUFNLFFBQVEsQ0FBQztBQUM1QixPQUFPLFFBQVEsTUFBTSxVQUFVLENBQUM7QUFVaEMsT0FBTyxFQUFrQixhQUFhLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUMzRSxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBRS9COztHQUVHO0FBQ0gsSUFBSyxnQkFHSjtBQUhELFdBQUssZ0JBQWdCO0lBQ25CLHFDQUFpQixDQUFBO0lBQ2pCLHVDQUFtQixDQUFBO0FBQ3JCLENBQUMsRUFISSxnQkFBZ0IsS0FBaEIsZ0JBQWdCLFFBR3BCO0FBRUQ7O0dBRUc7QUFDSCxNQUFNLE9BQU8sV0FBVztJQUtIO0lBQ0E7SUFMbkI7O09BRUc7SUFDSCxZQUNtQixjQUE4QixFQUM5QixjQUE4QjtRQUQ5QixtQkFBYyxHQUFkLGNBQWMsQ0FBZ0I7UUFDOUIsbUJBQWMsR0FBZCxjQUFjLENBQWdCO0lBQzlDLENBQUM7SUFDSjs7T0FFRztJQUNILE1BQU0sR0FBRyxLQUFLLEVBQUUsU0FBNkIsRUFBRSxXQUF5QixFQUFFLEVBQUU7UUFDMUUsTUFBTSxJQUFJLENBQUMsU0FBUyxDQUFDLFdBQVcsQ0FBQyxDQUFDO1FBRWxDLE1BQU0sY0FBYyxHQUFhLEVBQUUsQ0FBQztRQUNwQyxJQUFJLFdBQVcsRUFBRSxjQUFjLEtBQUssU0FBUyxFQUFFO1lBQzdDLGNBQWMsQ0FBQyxJQUFJLENBQUMsb0JBQW9CLENBQUMsQ0FBQztZQUMxQyxjQUFjLENBQUMsSUFBSSxDQUFDLGlCQUFpQixDQUFDLENBQUM7WUFDdkMsSUFBSSxXQUFXLENBQUMsaUJBQWlCLEVBQUU7Z0JBQ2pDLGNBQWMsQ0FBQyxJQUFJLENBQ2pC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QUFDLENBQUM7aUJBQ3REO2FBQ0Y7U0FDRjtJQUNILENBQUMsQ0FBQztDQUNIIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgZXhlY2EgfSBmcm9tICdleGVjYSc7XG5pbXBvcnQgc3RyZWFtIGZyb20gJ3N0cmVhbSc7XG5pbXBvcnQgcmVhZGxpbmUgZnJvbSAncmVhZGxpbmUnO1xuaW1wb3J0IHtcbiAgQmFja2VuZERlcGxveWVyLFxuICBEZXBsb3lQcm9wcyxcbiAgRGVwbG95UmVzdWx0LFxuICBEZXN0cm95UHJvcHMsXG4gIERlc3Ryb3lSZXN1bHQsXG59IGZyb20gJy4vY2RrX2RlcGxveWVyX3NpbmdsZXRvbl9mYWN0b3J5LmpzJztcbmltcG9ydCB7IENka0Vycm9yTWFwcGVyIH0gZnJvbSAnLi9jZGtfZXJyb3JfbWFwcGVyLmpzJztcbmltcG9ydCB7IEJhY2tlbmRJZGVudGlmaWVyLCBEZXBsb3ltZW50VHlwZSB9IGZyb20gJ0Bhd3MtYW1wbGlmeS9wbHVnaW4tdHlwZXMnO1xuaW1wb3J0IHsgQmFja2VuZExvY2F0b3IsIENES0NvbnRleHRLZXkgfSBmcm9tICdAYXdzLWFtcGxpZnkvcGxhdGZvcm0tY29yZSc7XG5pbXBvcnQgeyBkaXJuYW1lIH0gZnJvbSAncGF0aCc7XG5cbi8qKlxuICogQ29tbWFuZHMgdGhhdCBjYW4gYmUgaW52b2tlZFxuICovXG5lbnVtIEludm9rYWJsZUNvbW1hbmQge1xuICBERVBMT1kgPSAnZGVwbG95JyxcbiAgREVTVFJPWSA9ICdkZXN0cm95Jyxcbn1cblxuLyoqXG4gKiBJbnZva2VzIENESyBjb21tYW5kIHZpYSBleGVjYVxuICovXG5leHBvcnQgY2xhc3MgQ0RLRGVwbG95ZXIgaW1wbGVtZW50cyBCYWNrZW5kRGVwbG95ZXIge1xuICAvKipcbiAgICogSW5zdGFudGlhdGVzIGluc3RhbmNlIG9mIENES0RlcGxveWVyXG4gICAqL1xuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIHJlYWRvbmx5IGNka0Vycm9yTWFwcGVyOiBDZGtFcnJvck1hcHBlcixcbiAgICBwcml2YXRlIHJlYWRvbmx5IGJhY2tlbmRMb2NhdG9yOiBCYWNrZW5kTG9jYXRvclxuICApIHt9XG4gIC8qKlxuICAgKiBJbnZva2VzIGNkayBkZXBsb3kgY29tbWFuZFxuICAgKi9cbiAgZGVwbG95ID0gYXN5bmMgKGJhY2tlbmRJZD86IEJhY2tlbmRJZGVudGlmaWVyLCBkZXBsb3lQcm9wcz86IERlcGxveVByb3BzKSA9PiB7XG4gICAgYXdhaXQgdGhpcy5pbnZva2VUc2MoZGVwbG95UHJvcHMpO1xuXG4gICAgY29uc3QgY2RrQ29tbWFuZEFyZ3M6IHN0cmluZ1tdID0gW107XG4gICAgaWYgKGRlcGxveVByb3BzPy5kZXBsb3ltZW50VHlwZSA9PT0gJ3NhbmRib3gnKSB7XG4gICAgICBjZGtDb21tYW5kQXJncy5wdXNoKCctLWhvdHN3YXAtZmFsbGJhY2snKTtcbiAgICAgIGNka0NvbW1hbmRBcmdzLnB1c2goJy0tbWV0aG9kPWRpcmVjdCcpO1xuICAgICAgaWYgKGRlcGxveVByb3BzLnNlY3JldExhc3RVcGRhdGVkKSB7XG4gICAgICAgIGNka0NvbW1hbmRBcmdzLnB1c2goXG4gICAgICAgICAgJy0tY29udGV4dCcsXG4gICAgICAgICAgYHNlY3JldExhc3RVcGRhdGVkPSR7ZGVwbG95UHJvcHMuc2VjcmV0TGFzdFVwZGF0ZWQuZ2V0VGltZSgpfWBcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gdGhpcy5pbnZva2VDZGsoXG4gICAgICBJbnZva2FibGVDb21tYW5kLkRFUExPWSxcbiAgICAgIGJhY2tlbmRJZCxcbiAgICAgIGRlcGxveVByb3BzPy5kZXBsb3ltZW50VHlwZSxcbiAgICAgIGNka0NvbW1hbmRBcmdzXG4gICAgKTtcbiAgfTtcblxuICAvKipcbiAgICogSW52b2tlcyBjZGsgZGVzdHJveSBjb21tYW5kXG4gICAqL1xuICBkZXN0cm95ID0gYXN5bmMgKFxuICAgIGJhY2tlbmRJZD86IEJhY2tlbmRJZGVudGlmaWVyLFxuICAgIGRlc3Ryb3lQcm9wcz86IERlc3Ryb3lQcm9wc1xuICApID0+IHtcbiAgICByZXR1cm4gdGhpcy5pbnZva2VDZGsoXG4gICAgICBJbnZva2FibGVDb21tYW5kLkRFU1RST1ksXG4gICAgICBiYWNrZW5kSWQsXG4gICAgICBkZXN0cm95UHJvcHM/LmRlcGxveW1lbnRUeXBlLFxuICAgICAgWyctLWZvcmNlJ11cbiAgICApO1xuICB9O1xuXG4gIHByaXZhdGUgaW52b2tlVHNjID0gYXN5bmMgKGRlcGxveVByb3BzPzogRGVwbG95UHJvcHMpID0+IHtcbiAgICBpZiAoIWRlcGxveVByb3BzPy52YWxpZGF0ZUFwcFNvdXJjZXMpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IHRoaXMuZXhlY3V0ZUNoaWxkUHJvY2VzcyhcbiAgICAgICAgJ25weCcsXG4gICAgICAgIFtcbiAgICAgICAgICAndHNjJyxcbiAgICAgICAgICAnLS1zaG93Q29uZmlnJyxcbiAgICAgICAgICAnLS1wcm9qZWN0JyxcbiAgICAgICAgICBkaXJuYW1lKHRoaXMuYmFja2VuZExvY2F0b3IubG9jYXRlKCkpLFxuICAgICAgICBdLFxuICAgICAgICB7IHByaW50U3Rkb3V0OiBmYWxzZSB9XG4gICAgICApO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAvLyBJZiB3ZSBjYW5ub3QgbG9hZCB0cyBjb25maWcsIHR1cm4gb2ZmIHR5cGUgY2hlY2tpbmdcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgYXdhaXQgdGhpcy5leGVjdXRlQ2hpbGRQcm9jZXNzKCducHgnLCBbXG4gICAgICAndHNjJyxcbiAgICAgICctLW5vRW1pdCcsXG4gICAgICAnLS1za2lwTGliQ2hlY2snLFxuICAgICAgLy8gcG9pbnRpbmcgdGhlIHByb2plY3QgYXJnIHRvIHRoZSBhbXBsaWZ5IGJhY2tlbmQgZGlyZWN0b3J5IHdpbGwgdXNlIHRoZSB0c2NvbmZpZyBwcmVzZW50IGluIHRoYXQgZGlyZWN0b3J5XG4gICAgICAnLS1wcm9qZWN0JyxcbiAgICAgIGRpcm5hbWUodGhpcy5iYWNrZW5kTG9jYXRvci5sb2NhdGUoKSksXG4gICAgXSk7XG4gIH07XG5cbiAgLyoqXG4gICAqIEV4ZWN1dGVzIGEgQ0RLIGNvbW1hbmRcbiAgICovXG4gIHByaXZhdGUgaW52b2tlQ2RrID0gYXN5bmMgKFxuICAgIGludm9rYWJsZUNvbW1hbmQ6IEludm9rYWJsZUNvbW1hbmQsXG4gICAgYmFja2VuZElkPzogQmFja2VuZElkZW50aWZpZXIsXG4gICAgZGVwbG95bWVudFR5cGU/OiBEZXBsb3ltZW50VHlwZSxcbiAgICBhZGRpdGlvbmFsQXJndW1lbnRzPzogc3RyaW5nW11cbiAgKTogUHJvbWlzZTxEZXBsb3lSZXN1bHQgfCBEZXN0cm95UmVzdWx0PiA9PiB7XG4gICAgLy8gQmFzaWMgYXJnc1xuICAgIGNvbnN0IGNka0NvbW1hbmRBcmdzID0gW1xuICAgICAgJ2NkaycsXG4gICAgICBpbnZva2FibGVDb21tYW5kLnRvU3RyaW5nKCksXG4gICAgICAvLyBUaGlzIGlzIHVuZm9ydHVuYXRlLiBDREsgd3JpdGVzIGV2ZXJ5dGhpbmcgdG8gc3RkZXJyIHdpdGhvdXQgYC0tY2lgIGZsYWcgYW5kIHdlIG5lZWQgdG8gZGlmZmVyZW50aWF0ZSBiZXR3ZWVuIHRoZSB0d28uXG4gICAgICAvLyBTZWUgaHR0cHM6Ly9naXRodWIuY29tL2F3cy9hd3MtY2RrL2lzc3Vlcy83NzE3IGZvciBtb3JlIGRldGFpbHMuXG4gICAgICAnLS1jaScsXG4gICAgICAnLS1hcHAnLFxuICAgICAgYCducHggdHN4ICR7dGhpcy5iYWNrZW5kTG9jYXRvci5sb2NhdGUoKX0nYCxcbiAgICAgICctLWFsbCcsXG4gICAgICAnLS1vdXRwdXQnLFxuICAgICAgJy5hbXBsaWZ5L2FydGlmYWN0cy9jZGsub3V0JyxcbiAgICBdO1xuXG4gICAgLy8gQWRkIGNvbnRleHQgaW5mb3JtYXRpb24gaWYgYXZhaWxhYmxlXG4gICAgaWYgKGJhY2tlbmRJZCkge1xuICAgICAgY2RrQ29tbWFuZEFyZ3MucHVzaChcbiAgICAgICAgJy0tY29udGV4dCcsXG4gICAgICAgIGAke0NES0NvbnRleHRLZXkuQkFDS0VORF9OQU1FU1BBQ0V9PSR7YmFja2VuZElkLm5hbWVzcGFjZX1gLFxuICAgICAgICAnLS1jb250ZXh0JyxcbiAgICAgICAgYCR7Q0RLQ29udGV4dEtleS5CQUNLRU5EX05BTUV9PSR7YmFja2VuZElkLm5hbWV9YFxuICAgICAgKTtcblxuICAgICAgaWYgKGRlcGxveW1lbnRUeXBlICE9PSAnc2FuZGJveCcpIHtcbiAgICAgICAgY2RrQ29tbWFuZEFyZ3MucHVzaCgnLS1yZXF1aXJlLWFwcHJvdmFsJywgJ25ldmVyJyk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgaWYgKGRlcGxveW1lbnRUeXBlKSB7XG4gICAgICBjZGtDb21tYW5kQXJncy5wdXNoKFxuICAgICAgICAnLS1jb250ZXh0JyxcbiAgICAgICAgYCR7Q0RLQ29udGV4dEtleS5ERVBMT1lNRU5UX1RZUEV9PSR7ZGVwbG95bWVudFR5cGV9YFxuICAgICAgKTtcbiAgICB9XG5cbiAgICBpZiAoYWRkaXRpb25hbEFyZ3VtZW50cykge1xuICAgICAgY2RrQ29tbWFuZEFyZ3MucHVzaCguLi5hZGRpdGlvbmFsQXJndW1lbnRzKTtcbiAgICB9XG5cbiAgICB0cnkge1xuICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuZXhlY3V0ZUNoaWxkUHJvY2VzcygnbnB4JywgY2RrQ29tbWFuZEFyZ3MpO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgdGhyb3cgdGhpcy5jZGtFcnJvck1hcHBlci5nZXRIdW1hblJlYWRhYmxlRXJyb3IoZXJyIGFzIEVycm9yKTtcbiAgICB9XG4gIH07XG5cbiAgLyoqXG4gICAqIFdyYXBwZXIgZm9yIHRoZSBjaGlsZCBwcm9jZXNzIGV4ZWN1dG9yLiBIZWxwcyBpbiB1bml0IHRlc3RpbmcgYXMgbm9kZTp0ZXN0IGZyYW1ld29ya1xuICAgKiBkb2Vzbid0IGhhdmUgY2FwYWJpbGl0aWVzIHRvIG1vY2sgZXhwb3J0ZWQgZnVuY3Rpb25zIGxpa2UgYGV4ZWNhYCBhcyBvZiByaWdodCBub3cuXG4gICAqL1xuICBleGVjdXRlQ2hpbGRQcm9jZXNzID0gYXN5bmMgKFxuICAgIGNvbW1hbmQ6IHN0cmluZyxcbiAgICBjb21tYW5kQXJnczogc3RyaW5nW10sXG4gICAgb3B0aW9uczogeyBwcmludFN0ZG91dDogYm9vbGVhbiB9ID0geyBwcmludFN0ZG91dDogdHJ1ZSB9XG4gICkgPT4ge1xuICAgIC8vIFdlIGxldCB0aGUgc3Rkb3V0IGFuZCBzdGRpbiBpbmhlcml0IGFuZCBzdHJlYW1lZCB0byBwYXJlbnQgcHJvY2VzcyBidXQgcGlwZVxuICAgIC8vIHRoZSBzdGRlcnIgYW5kIHVzZSBpdCB0byB0aHJvdyBvbiBmYWlsdXJlLiBUaGlzIGlzIHRvIHByZXZlbnQgYWN0dWFsXG4gICAgLy8gYWN0aW9uYWJsZSBlcnJvcnMgYmVpbmcgaGlkZGVuIGFtb25nIHRoZSBzdGRvdXQuIE1vcmVvdmVyIGV4ZWNhIGVycm9ycyBhcmVcbiAgICAvLyB1c2VsZXNzIHdoZW4gY2FsbGluZyBDTElzIHVubGVzcyB5b3UgbWFkZSBleGVjYSBjYWxsaW5nIGVycm9yLlxuICAgIGxldCBhZ2dyZWdhdGVkU3RkZXJyID0gJyc7XG4gICAgY29uc3QgYWdncmVnYXRvclN0ZGVyclN0cmVhbSA9IG5ldyBzdHJlYW0uV3JpdGFibGUoKTtcbiAgICBhZ2dyZWdhdG9yU3RkZXJyU3RyZWFtLl93cml0ZSA9IGZ1bmN0aW9uIChjaHVuaywgZW5jb2RpbmcsIGRvbmUpIHtcbiAgICAgIGFnZ3JlZ2F0ZWRTdGRlcnIgKz0gY2h1bms7XG4gICAgICBkb25lKCk7XG4gICAgfTtcblxuICAgIGNvbnN0IGNoaWxkUHJvY2VzcyA9IGV4ZWNhKGNvbW1hbmQsIGNvbW1hbmRBcmdzLCB7XG4gICAgICBzdGRpbjogJ2luaGVyaXQnLFxuICAgICAgc3Rkb3V0OiAncGlwZScsXG4gICAgICBzdGRlcnI6ICdwaXBlJyxcblxuICAgICAgLy8gUGlwaW5nIHRoZSBvdXRwdXQgYnkgZGVmYXVsdCBzdHJpcHMgb2ZmIHRoZSBjb2xvci4gVGhpcyBpcyBhIHdvcmthcm91bmQgdG9cbiAgICAgIC8vIHByZXNlcnZlIHRoZSBjb2xvciBiZWluZyBwaXBlZCB0byBwYXJlbnQgcHJvY2Vzcy5cbiAgICAgIGV4dGVuZEVudjogdHJ1ZSxcbiAgICAgIGVudjogeyBGT1JDRV9DT0xPUjogJzEnIH0sXG4gICAgfSk7XG4gICAgY2hpbGRQcm9jZXNzLnN0ZGVycj8ucGlwZShhZ2dyZWdhdG9yU3RkZXJyU3RyZWFtKTtcblxuICAgIGlmIChvcHRpb25zPy5wcmludFN0ZG91dCkge1xuICAgICAgY2hpbGRQcm9jZXNzLnN0ZG91dD8ucGlwZShwcm9jZXNzLnN0ZG91dCk7XG4gICAgfVxuXG4gICAgY29uc3QgY2RrT3V0cHV0ID0geyBkZXBsb3ltZW50VGltZXM6IHt9IH07XG4gICAgaWYgKGNoaWxkUHJvY2Vzcy5zdGRvdXQpIHtcbiAgICAgIGF3YWl0IHRoaXMucG9wdWxhdGVDREtPdXRwdXRGcm9tU3Rkb3V0KGNka091dHB1dCwgY2hpbGRQcm9jZXNzLnN0ZG91dCk7XG4gICAgfVxuXG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IGNoaWxkUHJvY2VzcztcbiAgICAgIHJldHVybiBjZGtPdXRwdXQ7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIC8vIHN3YWxsb3cgZXhlY2EgZXJyb3Igd2hpY2ggaXMgbm90IHJlYWxseSBoZWxwZnVsLCByYXRoZXIgdGhyb3cgc3RkZXJyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYWdncmVnYXRlZFN0ZGVycik7XG4gICAgfVxuICB9O1xuXG4gIHByaXZhdGUgcG9wdWxhdGVDREtPdXRwdXRGcm9tU3Rkb3V0ID0gYXN5bmMgKFxuICAgIG91dHB1dDogRGVwbG95UmVzdWx0IHwgRGVzdHJveVJlc3VsdCxcbiAgICBzdGRvdXQ6IHN0cmVhbS5SZWFkYWJsZVxuICApID0+IHtcbiAgICBjb25zdCByZWdleFRvdGFsVGltZSA9IC/inKggezJ9VG90YWwgdGltZTogKFxcZCpcXC4qXFxkKilzLiovO1xuICAgIGNvbnN0IHJlZ2V4U3ludGhUaW1lID0gL+KcqCB7Mn1TeW50aGVzaXMgdGltZTogKFxcZCpcXC4qXFxkKilzLztcbiAgICBjb25zdCByZWFkZXIgPSByZWFkbGluZS5jcmVhdGVJbnRlcmZhY2Uoc3Rkb3V0KTtcbiAgICBmb3IgYXdhaXQgKGNvbnN0IGxpbmUgb2YgcmVhZGVyKSB7XG4gICAgICBpZiAobGluZS5pbmNsdWRlcygn4pyoJykpIHtcbiAgICAgICAgLy8gR29vZCBjaGFuY2UgdGhhdCBpdCBjb250YWlucyB0aW1pbmcgaW5mb3JtYXRpb25cbiAgICAgICAgY29uc3QgdG90YWxUaW1lID0gbGluZS5tYXRjaChyZWdleFRvdGFsVGltZSk7XG4gICAgICAgIGlmICh0b3RhbFRpbWUgJiYgdG90YWxUaW1lLmxlbmd0aCA+IDEgJiYgIWlzTmFOKCt0b3RhbFRpbWVbMV0pKSB7XG4gICAgICAgICAgb3V0cHV0LmRlcGxveW1lbnRUaW1lcy50b3RhbFRpbWUgPSArdG90YWxUaW1lWzFdO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IHN5bnRoVGltZSA9IGxpbmUubWF0Y2gocmVnZXhTeW50aFRpbWUpO1xuICAgICAgICBpZiAoc3ludGhUaW1lICYmIHN5bnRoVGltZS5sZW5ndGggPiAxICYmICFpc05hTigrc3ludGhUaW1lWzFdKSkge1xuICAgICAgICAgIG91dHB1dC5kZXBsb3ltZW50VGltZXMuc3ludGhlc2lzVGltZSA9ICtzeW50aFRpbWVbMV07XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH07XG59XG4iXX0=